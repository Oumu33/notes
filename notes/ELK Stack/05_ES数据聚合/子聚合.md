# 子聚合
## 简介
针对聚合分析的结果再次进行聚合分析，而且支持链式调用。

Pipeline 的分析结果会输出到原结果中，根据输出位置的不同，分为以下两类：

**Sibling 结果与现有聚合分析结果同级**

+ Max/Min/Avg/Sum Bucket
+ Stats/Extended Stats Bucket
+ Percentiles Bucket

**Parent 结果内嵌到现有的聚合分析结果中**

+ Derivative
+ Moving Average
+ Cumulative Sum

## min_bucket(bucket的最小值)
```json
# 按city分桶，计算每个桶的平均值，并找出平均值最小的桶
POST query_test/_search
{
  "size": 0,
  "aggs": {
    "citys": {
      "terms": {
        "field": "city.keyword"
      }, 
      "aggs": {
        "avg_age":{
          "avg": {
            "field": "age"
          }
        }
      }
    },
    "min_age_by_city": {
      "min_bucket": {
        "buckets_path": "citys>avg_age" 
      }
    }
  }
}
# 响应
{
  "took" : 10,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 6,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "citys" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "bei jing",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.5
          }
        },
        {
          "key" : "shang hai",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.0
          }
        },
        {
          "key" : "nan jing",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 41.0
          }
        },
        {
          "key" : "shen zhen",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 22.0
          }
        }
      ]
    },
    "min_salary_by_age" : {
      "value" : 17.0,
      "keys" : [
        "shang hai"
      ]
    }
  }
}
```

## max_bucket(bucket的最大值)
```json
# 按city分桶，计算每个桶的平均值，并找出平均值最大的桶
POST query_test/_search
{
  "size": 0,
  "aggs": {
    "citys": {
      "terms": {
        "field": "city.keyword"
      }, 
      "aggs": {
        "avg_age":{
          "avg": {
            "field": "age"
          }
        }
      }
    },
    "max_age_by_city": {
      "max_bucket": {
        "buckets_path": "citys>avg_age" 
      }
    }
  }
}
# 响应
{
  "took" : 4,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 6,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "citys" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "bei jing",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.5
          }
        },
        {
          "key" : "shang hai",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.0
          }
        },
        {
          "key" : "nan jing",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 41.0
          }
        },
        {
          "key" : "shen zhen",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 22.0
          }
        }
      ]
    },
    "min_salary_by_age" : {
      "value" : 41.0,
      "keys" : [
        "nan jing"
      ]
    }
  }
}
```

## avg_bucket(bucket的平均值)
```json
# 按city分桶，计算每个桶的平均值，并计算所有桶的平均值
POST query_test/_search
{
  "size": 0,
  "aggs": {
    "citys": {
      "terms": {
        "field": "city.keyword"
      }, 
      "aggs": {
        "avg_age":{
          "avg": {
            "field": "age"
          }
        }
      }
    },
    "avg_age_by_city": {
      "avg_bucket": {
        "buckets_path": "citys>avg_age" 
      }
    }
  }
}
# 响应
{
  "took" : 2,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 6,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "citys" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "bei jing",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.5
          }
        },
        {
          "key" : "shang hai",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.0
          }
        },
        {
          "key" : "nan jing",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 41.0
          }
        },
        {
          "key" : "shen zhen",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 22.0
          }
        }
      ]
    },
    "avg_salary_by_age" : {
      "value" : 24.375
    }
  }
}
```

## sum_bucket(bucket的总和)
```json
# 按city分桶，计算每个桶的平均值，并计算所有桶的平均值的总和
POST query_test/_search
{
  "size": 0,
  "aggs": {
    "citys": {
      "terms": {
        "field": "city.keyword"
      }, 
      "aggs": {
        "avg_age":{
          "avg": {
            "field": "age"
          }
        }
      }
    },
    "sum_age_by_city": {
      "sum_bucket": {
        "buckets_path": "citys>avg_age" 
      }
    }
  }
}
# 响应
{
  "took" : 4,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 6,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "citys" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "bei jing",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.5
          }
        },
        {
          "key" : "shang hai",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.0
          }
        },
        {
          "key" : "nan jing",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 41.0
          }
        },
        {
          "key" : "shen zhen",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 22.0
          }
        }
      ]
    },
    "sum_salary_by_age" : {
      "value" : 97.5
    }
  }
}
```

## stats_bucket(bucket的分析)
```json
# 按city分桶，计算每个桶的平均值，并计算所有桶的平均值的数据分析
POST query_test/_search
{
  "size": 0,
  "aggs": {
    "citys": {
      "terms": {
        "field": "city.keyword"
      }, 
      "aggs": {
        "avg_age":{
          "avg": {
            "field": "age"
          }
        }
      }
    },
    "stats_age_by_city": {
      "stats_bucket": {
        "buckets_path": "citys>avg_age" 
      }
    }
  }
}
# 响应
{
  "took" : 4,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 6,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "citys" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "bei jing",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.5
          }
        },
        {
          "key" : "shang hai",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.0
          }
        },
        {
          "key" : "nan jing",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 41.0
          }
        },
        {
          "key" : "shen zhen",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 22.0
          }
        }
      ]
    },
    "stats_salary_by_age" : {
      "count" : 4,
      "min" : 17.0,
      "max" : 41.0,
      "avg" : 24.375,
      "sum" : 97.5
    }
  }
}
```

## percentiles_bucket(bucket的百分位)
```json
# 按city分桶，计算每个桶的平均值，并计算所有桶的平均值的百分位
POST query_test/_search
{
  "size": 0,
  "aggs": {
    "citys": {
      "terms": {
        "field": "city.keyword"
      }, 
      "aggs": {
        "avg_age":{
          "avg": {
            "field": "age"
          }
        }
      }
    },
    "percentiles_age_by_city": {
      "percentiles_bucket": {
        "buckets_path": "citys>avg_age" 
      }
    }
  }
}
# 响应
{
  "took" : 4,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 6,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "citys" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "bei jing",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.5
          }
        },
        {
          "key" : "shang hai",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.0
          }
        },
        {
          "key" : "nan jing",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 41.0
          }
        },
        {
          "key" : "shen zhen",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 22.0
          }
        }
      ]
    },
    "percentiles_salary_by_age" : {
      "values" : {
        "1.0" : 17.0,
        "5.0" : 17.0,
        "25.0" : 17.5,
        "50.0" : 22.0,
        "75.0" : 22.0,
        "95.0" : 41.0,
        "99.0" : 41.0
      }
    }
  }
}
```

## 文档
es pipeline：[https://www.elastic.co/guide/en/elasticsearch/reference/7.13/search-aggregations-pipeline.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.13/search-aggregations-pipeline.html)

