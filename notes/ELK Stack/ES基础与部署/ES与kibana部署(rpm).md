# ES与kibana部署(rpm)
# 环境准备
## 修改主机名添加hosts(单节点可跳过)
```plain
# hostnamectl set-hostname es-master

# cat /etc/hosts 
192.168.10.132 es-master
192.168.10.133 es-hot
192.168.10.136 es-warm
192.168.10.138 es-cold
```

## 关闭防火墙和selinux
```plain
systemctl stop firewalld.service
systemctl  disable firewalld
setenforce  0
sed  -i 's/enforcing/disabled/g' /etc/selinux/config
grep  SELINUX= /etc/selinux/config
```

## 配置时间同步
```plain
dnf -y install chrony
systemctl  start chronyd
systemctl  enable chronyd
timedatectl set-timezone Asia/Shanghai
chronyc sourcestats -v 
date
```

也可以在内网环境其中一台主机启动chronyd服务，其他主机配置chronyd服务地址，参考文档：[https://www.cuiliangblog.cn/detail/section/31516177](https://www.cuiliangblog.cn/detail/section/31516177)

## 系统参数优化
### 修改文件描述符数目
+ 修改原因

原因1： Elasticsearch 在节点和 HTTP 客户端之间进行通信也使用了大量的套接字（sockets）。 所有这一切都需要足够的文件描述符。  
原因2：linux系统对每个用户、进程、或整个系统的可打开文件描述符数量都有一个限制，一般默认为1024。这对一个小的 Elasticsearch 节点来说实在是太低了，更不用说一个处理数以百计索引的节点。

+ 设置环境变量

```plain
# 修改环境变量文件
vim /etc/profile
ulimit -n 65535
# 使配置生效
source /etc/profile
```

+ 修改limits.conf配置文件

```plain
# 修改limits.conf配置
vim /etc/security/limits.conf
* soft nofile 65535
* hard nofile 65535
```

+ 验证

```plain
# ulimit -n
65535
```

### 修改虚拟内存数大小
+ 修改原因

Elasticsearch 对各种文件混合使用了 NioFs（ 非阻塞文件系统）和 MMapFs （ 内存映射文件系统）。  
请确保配置的最大映射数量，以便有足够的虚拟内存可用于 mmapped 文件

+ 临时设置

```plain
# sysctl -w vm.max_map_count=262144
vm.max_map_count = 262144
```

+ 永久设置

```plain
cat >> /etc/sysctl.conf << EOF
vm.max_map_count=262144
EOF
# sysctl -p 
vm.max_map_count = 262144
```

### 关闭swap分区
+ 修改原因

关闭 Swap 分区可以提高服务器的性能，因为 Swap 分区通常会在物理内存不足时被使用，这会导致额外的 I/O 操作和延迟。 当系统使用物理内存满足所有应用程序的需求时，关闭 Swap 分区可以避免这种情况的发生。

+ 设置

```plain
swapoff -a  
sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
```

## 数据盘挂载
ES数据存储建议挂载单独的数据盘，可将数据盘格式化后挂载至/data目录。

## 下载rpm包
+ elasticsearch软件包下载地址：[https://www.elastic.co/cn/downloads/past-releases#elasticsearch](https://www.elastic.co/cn/downloads/past-releases#elasticsearch)
+ kibana软件包下载地址：[https://www.elastic.co/cn/downloads/past-releases#kibana](https://www.elastic.co/cn/downloads/past-releases#kibana)

# 安装ES+kibana（单节点）
## 安装elasticsearch
### 安装elasticsearch软件包
```bash
[root@es-test ~]# rpm -ivh elasticsearch-8.10.4-x86_64.rpm
```

### 修改配置文件
无需修改，使用默认配置文件即可启动elasticsearch服务，可根据实际情况修改数据存储地址和节点名称。

```bash
[root@es-test ~]# cat /etc/elasticsearch/elasticsearch.yml
#cluster.name: my-application
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
xpack.security.enabled: true
xpack.security.enrollment.enabled: true
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/http.p12
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/transport.p12
  truststore.path: certs/transport.p12
network.host: 0.0.0.0 # 修改为服务器ip或0.0.0.0
```

## <font style="color:rgb(48, 49, 51);">修改jvm配置</font>
<font style="color:rgb(48, 49, 51);">实际生产环境中计算公式：</font>**<font style="color:rgb(48, 49, 51);">min（机器内存的一半，32GB内存）</font>**<font style="color:rgb(48, 49, 51);">。也就是说：取机器环境内存的一半和32GB内存之间的小值，jvm配置如下</font>

```plain
[root@es-test ~]# cat > /etc/elasticsearch/jvm.options.d/es.options << EOF
-Xms1g
-Xmx1g
EOF
```

### 启动elasticsearch服务
```bash
[root@es-test ~]# systemctl start elasticsearch
[root@es-test ~]# systemctl enable elasticsearch
```

## 安装kibana
### 安装kibana软件包
```bash
[root@es-test ~]# rpm -ivh kibana-8.10.4-x86_64.rpm
```

### 修改配置文件
```bash
[root@es-test ~]# vim /etc/kibana/kibana.yml
server.host: "0.0.0.0"
i18n.locale: "zh-CN"
```

### 启动kibana服务
```bash
[root@es-test ~]# systemctl start kibana
[root@es-test ~]# systemctl enable kibana
```

## 初始化服务
### <font style="color:rgb(48, 49, 51);">为Kibana生成注册令牌</font>
```plain
[root@es-test ~]# /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana
eyJ2ZXIiOiI4LjguMiIsImFkciI6WyIxOTIuMTY4LjguNTo5MjAwIl0sImZnciI6IjdmMTlkZjk5OGQ1NTRjOTJlY2I1MDVkYjZkYWUwOTU0ZDc0ZjNjNDdlZjU2Yjc4YjQ2YjY1NjYyNTU4Yjk4OGMiLCJrZXkiOiJ2TEgtZDRrQllLU1JQelFQSXBGVTpwVzZEUmtTV1NJMmg4QmVlMjdpMkFRIn0=
```

### <font style="color:rgb(48, 49, 51);">kibana注册集群</font>
```plain
[root@es-test ~]# /usr/share/kibana/bin/kibana-setup --enrollment-token eyJ2ZXIiOiI4LjguMiIsImFkciI6WyIxOTIuMTY4LjguNTo5MjAwIl0sImZnciI6IjdmMTlkZjk5OGQ1NTRjOTJlY2I1MDVkYjZkYWUwOTU0ZDc0ZjNjNDdlZjU2Yjc4YjQ2YjY1NjYyNTU4Yjk4OGMiLCJrZXkiOiJ2TEgtZDRrQllLU1JQelFQSXBGVTpwVzZEUmtTV1NJMmg4QmVlMjdpMkFRIn0=

✔ Kibana configured successfully.

To start Kibana run:
  bin/kibana
```

### <font style="color:rgb(48, 49, 51);">重置elastic用户密码</font>
```bash
[root@es-master ~]# /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
This tool will reset the password of the [elastic] user to an autogenerated value.
The password will be printed in the console.
Please confirm that you would like to continue [y/N]y
Password for the [elastic] user successfully reset.
New value: _21FDs+tGRRSaxg=q=4P
```

### <font style="color:rgb(48, 49, 51);">访问验证</font>
+ <font style="color:rgb(48, 49, 51);">登录kibana http://es-test:5601，用户名为elasic，密码为上述步骤中重置的elastic用户密码</font>

# 安装ES+kibana(集群)
具体内容可参考文档：[https://www.cuiliangblog.cn/detail/article/59](https://www.cuiliangblog.cn/detail/article/59)

# 安装head插件(可选)
1. 修改配置文件/etc/elasticsearch/elasticsearch.yml增加参数，使head插件可以访问es

`http.cors.enabled: true ` 

`http.cors.allow-origin: "*"` 

![](../../images/img_1753.png)

2. 使用docker运行容器

`# docker run --name elasticsearch-head -p 9100:9100 -d --restart=always mobz/elasticsearch-head:5 ` 

3. 浏览器访问

![](../../images/img_1754.png)

4. 查看“数据浏览”时，右侧不出数据，报406 Not Acceptable 错误。
+ 进入 es-head 安装目录；

`cd _site/` 

+ 编辑 vendor.js 共有两处

`将 6886行 contentType: "application/x-www-form-urlencoded" 修改为 contentType: "application/json;charset=UTF-8"` 

`将 7574行 var inspectData = s.contentType === "application/x-www-form-urlencoded" && 修改为 var inspectData = s.contentType === "application/json;charset=UTF-8" &&` 

+ 强制刷新浏览器验证。

# 安装cerebro监控插件(可选)
1. docker运行容器

`# docker run --name elasticsearch-cerebro -p 9000:9000  -d --restart=always lmenezes/cerebro ` 

2. 浏览器打开访问

![](../../images/img_1755.png)

# 官方文档
es部署方式：[https://www.elastic.co/guide/en/elasticsearch/reference/8.10/install-elasticsearch.html](https://www.elastic.co/guide/en/elasticsearch/reference/8.10/install-elasticsearch.html)

es配置文件：[https://www.elastic.co/guide/en/elasticsearch/reference/8.10/important-settings.html](https://www.elastic.co/guide/en/elasticsearch/reference/8.10/important-settings.html)

