# 安装配置
# 下载地址
[https://www.elastic.co/downloads/beats](https://www.elastic.co/downloads/beats)

# rpm方式
## 安装
```yaml
rpm -ivh filebeat-8.8.2-x86_64.rpm
```

## 创建测试配置文件
```yaml
vim /etc/filebeat/test.yml
filebeat.inputs:
- type: stdin
  enabled: true
output.console:
  pretty:  true
  enable:  true
```

## <font style="color:rgb(0, 0, 0);">常用配置</font>
### type
<font style="color:rgb(0, 0, 0);">指定input类型，有log、stdin、redis、tcp、syslog等</font>

### fields
<font style="color:rgb(0, 0, 0);">可以自定义添加字段，到output中去，后续可以使用这些字段，例如：</font>

```yaml
fields:
  log_topic: mysql_slow  
  idc: szjf
```

### 字段过滤
```yaml
exclude_lines: ['^DBG'] #不包含的字段行数过滤
include_lines: ['^ERR', '^WARN'] # 包含的字段行
```

### <font style="color:rgb(0, 0, 0);">tail_files</font>
<font style="color:rgb(0, 0, 0);">默认为false。配置为true时，filebeat将从新文件的最后位置开始读取,而不是从开头读取新文件， 注意：如果配合日志轮循使用，新文件的第一行将被跳过。</font>

<font style="color:rgb(0, 0, 0);">此选项适用于Filebeat尚未处理的文件。</font><font style="color:rgb(0, 0, 0);">如果先前运行了Filebeat并且文件的状态已经保留，</font><font style="color:rgb(232, 62, 140);background-color:rgb(246, 246, 246);">tail_files</font><font style="color:rgb(0, 0, 0);">则不会应用。</font>

<font style="color:rgb(0, 0, 0);">第一次运行Filebeat时，可以使用 tail_files: true 来避免索引旧的日志行。</font><font style="color:rgb(0, 0, 0);">第一次运行后，建议禁用此选项。</font>

### <font style="color:rgb(0, 0, 0);">registry file</font>
<font style="color:rgb(0, 0, 0);">filebeat会将自己处理日志文件的进度信息写入到registry文件中，以保证filebeat在重启之后能够接着处理未处理过的数据，而无需从头开始。  </font>

<font style="color:rgb(0, 0, 0);">如果要让filebeat从头开始读文件，需要停止filebeat，然后删除registry file:</font>

<font style="color:rgb(0, 0, 0);">systemctl stop filebeat ;rm -fr /var/lib/filebeat/registry/* ; systemctl start filebaet</font>

<font style="color:rgb(0, 0, 0);">registry文件里字段的解释：</font>

+ <font style="color:rgb(0, 0, 0);">source： 日志文件的路径</font>
+ <font style="color:rgb(0, 0, 0);">offset：已经采集的日志的字节数;已经采集到日志的哪个字节位置</font>
+ <font style="color:rgb(0, 0, 0);">inode： 日志文件的inode号</font>
+ <font style="color:rgb(0, 0, 0);">device： 日志所在的磁盘编号</font>
+ <font style="color:rgb(0, 0, 0);">timestamp： 日志最后一次发生变化的时间戳</font>
+ <font style="color:rgb(0, 0, 0);">ttl： 采集失效时间，-1表示只要日志存在，就一直采集该日志</font>

### <font style="color:rgb(0, 0, 0);">multiline</font>
处理多行合并，下文详细介绍

## 启动filebeat，指定配置文件
`filebeat -e -c /etc/filebeat/test.yml` 

## 测试
输入hello运行结果如下

```bash
hello
{
  "@timestamp": "2024-03-16T13:47:59.821Z",
  "@metadata": {
    "beat": "filebeat",
    "type": "_doc",
    "version": "7.17.18"
  },
  "log": {
    "file": {
      "path": ""
    },
    "offset": 0
  },
  "message": "hello",
  "input": {
    "type": "stdin"
  },
  "ecs": {
    "version": "1.12.0"
  },
  "host": {
    "name": "es7"
  },
  "agent": {
    "version": "7.17.18",
    "hostname": "es7",
    "ephemeral_id": "693aa7a4-6a6f-4dc3-9cac-4f77fda47304",
    "id": "e94b727a-bebc-4138-943e-25a524091875",
    "name": "es7",
    "type": "filebeat"
  }
}
```

# docker方式
## 拉取镜像
```bash
docker pull docker.elastic.co/beats/filebeat:8.8.2
```

## 创建测试日志文件
```bash
vim docker/filebeat/log/info.log
{'access_status': 200, 'request_method': 'POST', 'request_uri': '/public/', 'request_length': 23, 'remote_address': '161.175.250.11', 'server_name': 'cu-20.cn', 'time_start': '2023-07-22T08:57:23.850+08:00', 'time_finish': '2023-07-22T08:57:24.377+08:00', 'http_user_agent': 'Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0; Touch; MASMJS)'}
{'access_status': 200, 'request_method': 'PUT', 'request_uri': '/login/', 'request_length': 47, 'remote_address': '221.108.80.211', 'server_name': 'cm-13.cn', 'time_start': '2023-07-22T08:57:23.616+08:00', 'time_finish': '2023-07-22T08:57:24.734+08:00', 'http_user_agent': 'Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Trident/4.0; Hot Lingo 2.0)'}
{'access_status': 404, 'request_method': 'PUT', 'request_uri': '/login/', 'request_length': 63, 'remote_address': '186.233.87.105', 'server_name': 'cm-14.cn', 'time_start': '2023-07-22T08:57:24.885+08:00', 'time_finish': '2023-07-22T08:57:25.325+08:00', 'http_user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3451.0 Safari/537.36'}
{'access_status': 200, 'request_method': 'DELETE', 'request_uri': '/management/', 'request_length': 31, 'remote_address': '188.240.254.146', 'server_name': 'cm-9.cn', 'time_start': '2023-07-22T08:57:24.654+08:00', 'time_finish': '2023-07-22T08:57:25.323+08:00', 'http_user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.2999.0 Safari/537.36'}
{'access_status': 400, 'request_method': 'PUT', 'request_uri': '/public/', 'request_length': 44, 'remote_address': '146.245.251.35', 'server_name': 'cu-27.cn', 'time_start': '2023-07-22T08:57:25.994+08:00', 'time_finish': '2023-07-22T08:57:26.791+08:00', 'http_user_agent': 'Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.4; en-US; rv:1.9.2.2) Gecko/20100316 Firefox/3.6.2'}
{'access_status': 200, 'request_method': 'GET', 'request_uri': '/login/', 'request_length': 1, 'remote_address': '136.55.9.47', 'server_name': 'cm-11.cn', 'time_start': '2023-07-22T08:57:26.161+08:00', 'time_finish': '2023-07-22T08:57:27.063+08:00', 'http_user_agent': 'Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0; Touch; MASMJS)'}
{'access_status': 200, 'request_method': 'DELETE', 'request_uri': '/public/', 'request_length': 6, 'remote_address': '161.243.27.61', 'server_name': 'cm-8.cn', 'time_start': '2023-07-22T08:57:26.756+08:00', 'time_finish': '2023-07-22T08:57:27.826+08:00', 'http_user_agent': 'Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Trident/4.0; Hot Lingo 2.0)'}
{'access_status': 200, 'request_method': 'GET', 'request_uri': '/account/', 'request_length': 40, 'remote_address': '114.164.142.10', 'server_name': 'cm-17.cn', 'time_start': '2023-07-22T08:57:27.710+08:00', 'time_finish': '2023-07-22T08:57:28.447+08:00', 'http_user_agent': 'Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36'}
{'access_status': 201, 'request_method': 'DELETE', 'request_uri': '/login/', 'request_length': 4, 'remote_address': '172.66.52.255', 'server_name': 'cu-34.cn', 'time_start': '2023-07-22T08:57:28.169+08:00', 'time_finish': '2023-07-22T08:57:28.951+08:00', 'http_user_agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:57.0) Gecko/20100101 Firefox/57.0'}
{'access_status': 502, 'request_method': 'DELETE', 'request_uri': '/account/', 'request_length': 12, 'remote_address': '201.146.209.24', 'server_name': 'cm-5.cn', 'time_start': '2023-07-22T08:57:28.216+08:00', 'time_finish': '2023-07-22T08:57:29.659+08:00', 'http_user_agent': 'Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0; Touch; MASMJS)'}
{'access_status': 201, 'request_method': 'POST', 'request_uri': '/account/', 'request_length': 11, 'remote_address': '150.38.231.57', 'server_name': 'cu-25.cn', 'time_start': '2023-07-22T08:57:28.216+08:00', 'time_finish': '2023-07-22T08:57:29.446+08:00', 'http_user_agent': 'Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; Trident/6.0; Touch; MASMJS)'}
{'access_status': 200, 'request_method': 'GET', 'request_uri': '/account/', 'request_length': 62, 'remote_address': '173.132.216.154', 'server_name': 'cu-35.cn', 'time_start': '2023-07-22T08:57:29.822+08:00', 'time_finish': '2023-07-22T08:57:30.489+08:00', 'http_user_agent': 'Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36'}
{'access_status': 401, 'request_method': 'PUT', 'request_uri': '/login/', 'request_length': 58, 'remote_address': '208.46.162.3', 'server_name': 'cm-7.cn', 'time_start': '2023-07-22T08:57:30.520+08:00', 'time_finish': '2023-07-22T08:57:31.000+08:00', 'http_user_agent': 'Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36'}
{'access_status': 201, 'request_method': 'PUT', 'request_uri': '/management/', 'request_length': 63, 'remote_address': '155.1.90.255', 'server_name': 'cm-7.cn', 'time_start': '2023-07-22T08:57:30.837+08:00', 'time_finish': '2023-07-22T08:57:32.425+08:00', 'http_user_agent': 'Mozilla/5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36'}
```

## 创建测试配置文件
```yaml
vim docker/filebeat/conf/filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
  - /log/info.log
output.console:
  pretty:  true
  enable:  true
```

## 挂载配置文件与目录运行
```bash
docker run -d -v $PWD/conf/filebeat.yml:/usr/share/filebeat/filebeat.yml -v$PWD/log:/log docker.elastic.co/beats/filebeat:8.8.2
```

