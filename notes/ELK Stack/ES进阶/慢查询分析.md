# 慢查询分析
# profile api
<font style="color:rgb(62, 62, 62);">我们可以使用profile api来定位慢查询。</font>

<font style="color:rgb(62, 62, 62);">在查询条件中设置profile为true的参数，将会显示查询经历的细节。</font>

```json
GET index_name/_search
{
  "query": {
     "match": {
       "serviceIp" : "xxxxx"
     }
  },
  "profile": true
}
```

<font style="color:rgb(62, 62, 62);">其结果为：</font>

![](../../images/img_1808.png)

<font style="color:rgb(62, 62, 62);">这里会返回一个shards列表。其中：</font>

+ <font style="color:rgb(62, 62, 62);">id</font><font style="color:rgb(62, 62, 62);">【nodeId】【shardId】</font>
+ <font style="color:rgb(62, 62, 62);">query</font>

<font style="color:rgb(62, 62, 62);">主要包含了如下信息：</font>

+ <font style="color:rgb(62, 62, 62);">query_type</font><font style="color:rgb(62, 62, 62);">展示了哪种类型的查询被触发。</font>
+ <font style="color:rgb(62, 62, 62);">lucene</font><font style="color:rgb(62, 62, 62);">显示启动的lucene方法</font>
+ <font style="color:rgb(62, 62, 62);">time</font><font style="color:rgb(62, 62, 62);">执行lucene查询小号的时间</font>
+ <font style="color:rgb(62, 62, 62);">breakdown</font><font style="color:rgb(62, 62, 62);">里面包含了lucene查询的一些细节参数</font>
+ <font style="color:rgb(62, 62, 62);">rewrite_time</font><font style="color:rgb(62, 62, 62);">多个关键字会分解创建个别查询，这个分解过程花费的时间。将重写一个或者多个组合查询的时间被称为”重写时间“</font>
+ <font style="color:rgb(62, 62, 62);">collector在Lucene中，收集器负责收集原始结果，并对它们进行组合、过滤、排序等处理。这里我们可以根据这个查看收集器里面花费的时间及一些参数。</font>

<font style="color:rgb(62, 62, 62);">Profile API让我们清楚地看到查询耗时。提供了有关子查询的详细信息，我们可以清楚地知道在哪个环节查询慢，另外返回的结果中，关于Lucene的详细信息也让我们深入了解到ES是如何执行查询的。</font>

# 查看慢日志
<font style="color:rgb(62, 62, 62);">ES记录了两类慢日志：</font><font style="color:rgb(51, 51, 51);"></font>

<font style="color:rgb(62, 62, 62);">慢搜索日志</font>

<font style="color:rgb(62, 62, 62);">用来记录哪些查询比较慢，每个节点可以设置不同的阈值。</font>

<font style="color:rgb(62, 62, 62);">之前我们已经详细分析了ES的搜索由两个阶段组</font><font style="color:rgb(62, 62, 62);">成：</font>

1. <font style="color:rgb(62, 62, 62);">查询</font>
2. <font style="color:rgb(62, 62, 62);">取回</font>

<font style="color:rgb(62, 62, 62);">慢搜索日志给出了每个阶段所花费的时间和整个查询内容本身。慢搜索日志可以为查询和取回阶段单独设置以时间为单位的阈值，在定义好每个级别的时间后，通过level决定输出哪个级别的日志。</font><font style="color:rgb(51, 51, 51);">  
</font>

<font style="color:rgb(62, 62, 62);">示例如下</font>

```json

PUT kibana_sample_data_logs/_settings
{
"index.search.slowlog.threshold.query.warn": "100ms",
"index.search.slowlog.threshold.query.info": "50ms",
"index.search.slowlog.threshold.query.debug": "10ms",
"index.search.slowlog.threshold.query.trace": "60ms",
"index.search.slowlog.threshold.fetch.warn": "100ms",
"index.search.slowlog.threshold.fetch.info": "50ms",
"index.search.slowlog.threshold.fetch.debug": "20ms",
"index.search.slowlog.threshold.fetch.trace": "60ms",
"index.search.slowlog.level": "debug"
}
```

```plain
[2030-08-30T11:59:37,786][WARN ][i.s.s.query] [node-0] [index6][0] took[78.4micros], took_millis[0], total_hits[0 hits], stats[], search_type[QUERY_THEN_FETCH], total_shards[1], source[{"query":{"match_all":{"boost":1.0}}}], id[MY_USER_ID],
```

<font style="color:rgb(62, 62, 62);">官方链接：</font>

<font style="color:rgb(62, 62, 62);">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/index-modules-slowlog.html</font>

  


