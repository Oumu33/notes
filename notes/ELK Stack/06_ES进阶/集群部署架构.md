# 集群部署架构
# 节点规格
## 节点分类
<font style="color:rgb(62, 62, 62);">ElasticSearch的部署节点类型如下：</font>

+ <font style="color:rgb(62, 62, 62);">Master eligible</font>

<font style="color:rgb(62, 62, 62);">主节点及其候选节点，负责集群状态(cluster state)的管理</font>

<font style="color:rgb(62, 62, 62);">配置项：node.master，默认为true</font>

+ <font style="color:rgb(62, 62, 62);">data</font>

<font style="color:rgb(62, 62, 62);">数据节点，负责数据存储及处理客户端请求</font>

<font style="color:rgb(62, 62, 62);">配置项：node.data，默认为true</font>

+ <font style="color:rgb(62, 62, 62);">Ingest</font>

<font style="color:rgb(62, 62, 62);">ingest节点，负责数据处理，脚本执行</font>

<font style="color:rgb(62, 62, 62);">配置项：node.ingest，默认为true</font>

+ <font style="color:rgb(62, 62, 62);">Coordinating</font>

<font style="color:rgb(62, 62, 62);">协调节点</font>

<font style="color:rgb(62, 62, 62);">配置项：设置上面三个参数全部为false，那么它就是一个纯协调节点</font>

+ <font style="color:rgb(62, 62, 62);">machine learning</font>

<font style="color:rgb(62, 62, 62);">机器学习节点，收费属于x-pack</font>

## <font style="color:rgb(62, 62, 62);">节点资源使用</font>
| <font style="background-color:rgba(255, 255, 255, 0);">角色</font> | <font style="background-color:rgba(255, 255, 255, 0);">描述</font> | <font style="background-color:rgba(255, 255, 255, 0);">存储</font> | <font style="background-color:rgba(255, 255, 255, 0);">内存</font> | <font style="background-color:rgba(255, 255, 255, 0);">计算</font> | <font style="background-color:rgba(255, 255, 255, 0);">网络</font> |
| --- | --- | --- | --- | --- | --- |
| <font style="background-color:rgba(255, 255, 255, 0);">主节点</font> | <font style="background-color:rgba(255, 255, 255, 0);">管理集群状态</font> | <font style="background-color:rgba(255, 255, 255, 0);">低</font> | <font style="background-color:rgba(255, 255, 255, 0);">低</font> | <font style="background-color:rgba(255, 255, 255, 0);">低</font> | <font style="background-color:rgba(255, 255, 255, 0);">低</font> |
| <font style="background-color:rgba(255, 255, 255, 0);">数据节点</font> | <font style="background-color:rgba(255, 255, 255, 0);">存储和检索数据</font> | <font style="background-color:rgba(255, 255, 255, 0);">极高</font> | <font style="background-color:rgba(255, 255, 255, 0);">高</font> | <font style="background-color:rgba(255, 255, 255, 0);">高</font> | <font style="background-color:rgba(255, 255, 255, 0);">中</font> |
| <font style="background-color:rgba(255, 255, 255, 0);">Ingest 节点</font> | <font style="background-color:rgba(255, 255, 255, 0);">转换输入数据</font> | <font style="background-color:rgba(255, 255, 255, 0);">低</font> | <font style="background-color:rgba(255, 255, 255, 0);">中</font> | <font style="background-color:rgba(255, 255, 255, 0);">高</font> | <font style="background-color:rgba(255, 255, 255, 0);">中</font> |
| <font style="background-color:rgba(255, 255, 255, 0);">协调节点</font> | <font style="background-color:rgba(255, 255, 255, 0);">请求转发和合并检索结果</font> | <font style="background-color:rgba(255, 255, 255, 0);">低</font> | <font style="background-color:rgba(255, 255, 255, 0);">中</font> | <font style="background-color:rgba(255, 255, 255, 0);">中</font> | <font style="background-color:rgba(255, 255, 255, 0);">中</font> |
| <font style="background-color:rgba(255, 255, 255, 0);">机器学习节点</font> | <font style="background-color:rgba(255, 255, 255, 0);">机器学习</font> | <font style="background-color:rgba(255, 255, 255, 0);">低</font> | <font style="background-color:rgba(255, 255, 255, 0);">极高</font> | <font style="background-color:rgba(255, 255, 255, 0);">极高</font> | <font style="background-color:rgba(255, 255, 255, 0);">中</font> |


## 节点推荐配置
<font style="color:rgb(62, 62, 62);">在生产环境部署推荐配置整体思路就是：</font><font style="color:rgb(62, 62, 62);">尽量是一个节点只承担一个角色。</font>

<font style="color:rgb(62, 62, 62);">因为不同的节点所需要的计算机资源都不一样。</font><font style="color:rgb(62, 62, 62);">职责分离后可以按需扩展互不影响。</font>

+ <font style="color:rgb(62, 62, 62);">Master</font>

<font style="color:rgb(62, 62, 62);">资源要求：中高CPU；中高内存；中低磁盘</font>

<font style="color:rgb(62, 62, 62);">一般在生产环境中配置3台</font>

<font style="color:rgb(62, 62, 62);">一个集群只有1台活跃的主节点，负责分片管理，索引创建，集群管理等操作</font>

+ <font style="color:rgb(62, 62, 62);">data</font>

<font style="color:rgb(62, 62, 62);">资源要求：CPU、内存、磁盘要求都高</font>

+ <font style="color:rgb(62, 62, 62);">ingest</font>

<font style="color:rgb(62, 62, 62);">资源要求：高配置CPU;中等配置的RAM;低配置的磁盘</font>

+ <font style="color:rgb(62, 62, 62);">Coordinating</font>

<font style="color:rgb(62, 62, 62);">资源要求：一般中高CPU；中高内存；低磁盘</font>

<font style="color:rgb(62, 62, 62);">协调节点扮演者负载均衡、结果的聚合，在大型的es集群中条件允许可以使用高配的cpu和内存。因为如果客户端发起了深度分页等请求可能会导致oom。</font>

**<font style="color:rgb(255, 0, 0);">注意：</font>**

**<font style="color:rgb(62, 62, 62);">如果和数据节点或者Coordinate节点混合部署，数据节点本来相对有比较大的内存占用。</font>**

**<font style="color:rgb(62, 62, 62);">而Coordinate节点有时候可能会有开销很高的查询导致OOM，这些甚至都有可能影响Master节点，导致集群的不稳定。</font>**

# <font style="color:rgb(0, 0, 0);background-color:rgb(241, 252, 244);">架构模式</font>
## 基础架构
![](../../images/img_1812.png)

<font style="color:rgb(62, 62, 62);">这是一个基础版的职责分离的部署架构：</font>

+ <font style="color:rgb(62, 62, 62);">比如当磁盘容量无法满足需求时，可以增加数据节点；</font>
+ <font style="color:rgb(62, 62, 62);">磁盘读写压力大时，增加数据节点。</font>

<font style="color:rgb(62, 62, 62);">但是如果大量的聚合查询等操作，这种架构不太适合了。</font>

## 水平扩展部署<font style="color:rgba(0, 0, 0, 0.9);">  
</font>
![](../../images/img_1813.png)

<font style="color:rgb(62, 62, 62);">当系统中有大量的复杂查询或者聚合时候，我们可增加Coordinating节点，增加查询的性能，这里增加了负载均衡层，通过负载均衡扩展时应用程序无感知。</font>

## 读写分离<font style="color:rgba(0, 0, 0, 0.9);"></font>
![](../../images/img_1814.png)<font style="color:rgb(62, 62, 62);"></font>

<font style="color:rgb(62, 62, 62);">这样部署部署相互影响，写入多的话，多部署ingetst节点，读的时候聚合查询较多可以多部署协调节点，存储数据量大，可以适当对数据节点进行调优。</font>

## 冷热分离
<font style="color:rgb(62, 62, 62);">我们知道数据有冷热之分，比如写入频繁的日志数据，近期的索引将会频繁写入。</font><font style="color:rgb(62, 62, 62);">es根据数据这些特征引入了hot节点和warm节点。</font>

+ <font style="color:rgb(62, 62, 62);">hot节点</font>

<font style="color:rgb(62, 62, 62);">使用ssd，该节点上的索引不断的有新文档写入和查询，对cpu、io的要求较高。</font>

+ <font style="color:rgb(62, 62, 62);">warm节点</font>

<font style="color:rgb(62, 62, 62);">可以使用HDD，上面的索引不会有写入，查询较少。上面只保存只读索引或者旧索引，使用大容量便宜的机械硬盘。  
</font>

![](../../images/img_1815.png)

<font style="color:rgb(62, 62, 62);">配置步骤：</font>

+ <font style="color:rgb(62, 62, 62);">在</font><font style="color:rgb(62, 62, 62);">ElasticSearch</font><font style="color:rgb(62, 62, 62);">节点启动的时候，在</font><font style="color:rgb(62, 62, 62);">ElasticSearch</font><font style="color:rgb(62, 62, 62);">.yml配置文件node.attr中指定当前的节点是hot还是warm。</font><font style="color:rgb(62, 62, 62);">如：</font><font style="color:rgb(62, 62, 62);">node.attr.testNodeType=hot</font>
+ <font style="color:rgb(62, 62, 62);">通过GET/_cat/nodeattrs?v查看所有的节点的状态</font>

<font style="color:rgb(62, 62, 62);">  
</font>

![](../../images/img_1816.png)

<font style="color:rgb(62, 62, 62);">  
</font>

+ <font style="color:rgb(62, 62, 62);">创建索引时指定在何种类型的节点上，</font><font style="color:rgb(62, 62, 62);">使用属性：</font><font style="color:rgb(62, 62, 62);">"index.routing.allocation.require.testNodeType":"hot"</font>
+ <font style="color:rgb(62, 62, 62);">也可以在已有的索引上使用上述属性，它会将索引的数据迁移到hot节点上</font>

# 异地多活
<font style="color:rgb(62, 62, 62);">针对多机房灾备，</font><font style="color:rgb(62, 62, 62);">ElasticSearch</font><font style="color:rgb(62, 62, 62);">业界有多种不同的通用解决方案：</font>

## <font style="color:rgb(62, 62, 62);">跨机房部署集群</font>
<font style="color:rgb(62, 62, 62);">一个集群中的节点分布在不同的机房</font>

+ <font style="color:rgb(62, 62, 62);">优点：部署简单，一致性高。</font>
+ <font style="color:rgb(62, 62, 62);">缺点：但是对网络带宽和延迟要求较高，仅适用于同城灾备，可能导致可能由于机房间网络中断造成不可用。</font>

## <font style="color:rgb(62, 62, 62);">应用双写</font>
<font style="color:rgb(62, 62, 62);">应用程序同时将数据写入两个集群</font>

+ <font style="color:rgb(62, 62, 62);">优点：应用端灵活可控</font>
+ <font style="color:rgb(62, 62, 62);">缺点：但是一致性差、延迟高、集群故障时数据会丢失</font>

## <font style="color:rgb(62, 62, 62);">借助消息队列实现双写</font>
<font style="color:rgb(62, 62, 62);">应用程序先将数据写入消息队列，然后由下游的消费者消费并写入集群</font>

+ <font style="color:rgb(62, 62, 62);">优点：这种方案数据可靠性高，不易丢失</font>
+ <font style="color:rgb(62, 62, 62);">缺点：引入额外的消息队列组件，维护成本高，开发难度大、延迟高，需要保证消息中间件的高可用。</font>

## <font style="color:rgb(62, 62, 62);">CCR跨集群复制</font>
<font style="color:rgb(62, 62, 62);">ElasticSearch</font><font style="color:rgb(62, 62, 62);">官方的跨集群复制功能，基于文档操作实现订阅复制</font>

+ <font style="color:rgb(62, 62, 62);">优点：</font><font style="color:rgb(62, 62, 62);">一致性高、设置简单、延迟低、提供完善的API，并且可以监控同步进度，整体有保障。</font>
+ <font style="color:rgb(62, 62, 62);">缺点：白金功能，会员独享；集群之间拉取数据可能会增加额外的负载并影响原有集群本身的磁盘和网络性能</font>

## <font style="color:rgb(62, 62, 62);">定期快照</font>
<font style="color:rgb(62, 62, 62);">定期将索引备份到外部存储，如hdfs等设备</font>

+ <font style="color:rgb(62, 62, 62);">优点：</font><font style="color:rgb(62, 62, 62);">操作简单，无技术成本</font>
+ <font style="color:rgb(62, 62, 62);">缺点：</font><font style="color:rgb(62, 62, 62);">但是需要通过快照将数据恢复到新集群中，恢复时间长，数据不是实时备份，可能丢失数据</font>

## <font style="color:rgb(62, 62, 62);">极限网关</font>
<font style="color:rgb(62, 62, 62);">写请求交给网关，网关实时写入主集群，然后异步写备集群</font>

+ <font style="color:rgb(62, 62, 62);">优点：</font><font style="color:rgb(62, 62, 62);">无缝透明，应用程序无需任何调整、网关自动处理故障情况、一致性高，通过校验任务确保数据完全一致</font>
+ <font style="color:rgb(62, 62, 62);">对网关的要求较高</font>

<font style="color:rgb(62, 62, 62);">如下是基于CCR跨集群复制的部署架构</font><font style="color:rgb(51, 51, 51);"></font><font style="color:rgb(62, 62, 62);">  
</font>

![](../../images/img_1817.png)

