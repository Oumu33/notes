# RBD镜像空间动态伸缩
# 扩容
## 扩容 RBD
```bash
root@ceph-1:~# rbd ls -p rbd-data -l
NAME       SIZE   PARENT  FMT  PROT  LOCK
data-img1  3 GiB            2        excl
data-img2  4 GiB            2            
 
# 调整data-img1镜像大小至6G
root@ceph-1:~# rbd resize --pool rbd-data --image data-img1 --size 6G
Resizing image: 100% complete...done.
root@ceph-1:~# rbd ls -p rbd-data -l
NAME       SIZE   PARENT  FMT  PROT  LOCK
data-img1  6 GiB            2             # 扩容到6G
data-img2  4 GiB            2 
```

## 客户端验证镜像空间
验证客户端

```bash
# lsblk已识别为6G
root@ceph-client:~# lsblk | grep rbd
rbd0                      252:0    0    6G  0 disk /data
 
# 系统还未识别
root@ceph-client:~# df -h | grep rbd
/dev/rbd0                          3.0G   54M  3.0G   2% /data	# 没有自动识别
```

## ‍客户端文件系统手动执行更新
+ 如果是ext{2,3,4}文件系统的话，可以用`resize2fs` 命令来更新。

```bash
resize2fs /dev/rbd0
```

+ 如果是xfs文件系统的话，用`xfs_growfs`更新

```bash
xfs_growfs /dev/rbd0
```

挂载点手动执行识别

```bash
root@ceph-client:~# xfs_growfs /dev/rbd0
meta-data=/dev/rbd0              isize=512    agcount=8, agsize=98304 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1
data     =                       bsize=4096   blocks=786432, imaxpct=25
         =                       sunit=16     swidth=16 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=16 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
data blocks changed from 786432 to 1572864
root@ceph-client:~# df -h | grep rbd
/dev/rbd0                          6.0G   76M  6.0G   2% /data # 已经更新为6G
```

# 缩容
## 缩容 RBD
```bash
# 当前data-img1为6G
root@ceph-1:~# rbd ls -p rbd-data -l
NAME       SIZE   PARENT  FMT  PROT  LOCK
data-img1  6 GiB            2        excl
data-img2  4 GiB            2          
# 缩容为5G
root@ceph-1:~# rbd resize --pool rbd-data --image data-img1 --size 5G --allow-shrink
Resizing image: 100% complete...done.
root@ceph-1:~# rbd ls -p rbd-data -l
NAME       SIZE   PARENT  FMT  PROT  LOCK
data-img1  5 GiB            2             # 已经缩容为5G
data-img2  4 GiB            2
```

## 客户端缩容
 方法与上面基本一样，但是要注意的是，由于 xfs 不支持缩小，所以即使 rbd缩小，xfs也无法缩 小。  


