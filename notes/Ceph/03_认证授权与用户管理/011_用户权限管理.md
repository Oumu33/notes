# 用户权限管理
用户管理功能可让Ceph集群管理员能够直接在Ceph集群中创建、更新和删除用户。在Ceph集群中创建或删除用户时，可能需要将key分发到客户端，以便将key添加到keyring文件中（/etc/ceph/ceph.client.admin.keyring），此文件中可以包含一个或者多个用户认证信息，凡是拥有此文件的节点，将具备访问ceph的权限，而且可以使用其中任何一个账户的权限，此文件类似于linux系统的中的/etc/passwd文件。

# 列出用户
```bash
ceph auth list
```

Ceph 会列出集群中的所有用户，示例：

```bash
root@ceph-1:~# ceph auth list
client.admin
        key: AQBii0hnHNvZFxAAzs6IHqobafeOMF4aypRH7g==
        caps: [mds] allow *
        caps: [mgr] allow *
        caps: [mon] allow *
        caps: [osd] allow *
client.bootstrap-mds
        key: AQBji0hn9mJJHhAAPlJM8tEVuM7wV4jHY1n0GQ==
        caps: [mon] allow profile bootstrap-mds
client.bootstrap-mgr
        key: AQBji0hnGGZJHhAAEZazRz4V6Qfdc3tyyOXlRA==
        caps: [mon] allow profile bootstrap-mgr
client.bootstrap-osd
        key: AQBji0hny2hJHhAAP7kefIMqH64jE3X1QDZyOw==
        caps: [mon] allow profile bootstrap-osd
...
```

注意：TYPE.ID表示法  
针对用户采用TYPE.ID表示法，例如：osd.0指定是osd类并且ID为0的用户(节点)，client.admin是client类型的用户，其ID为admin。

另外，每个用户条目都有一个 key: 对，一个或多个 caps: 条目。可以结合使用-o文件名选项和`ceph auth list`将输出保存到某个文件。

```bash
root@ceph-1:~# ceph auth list -o all.key
root@ceph-1:~# cat all.key 
client.admin
        key: AQBii0hnHNvZFxAAzs6IHqobafeOMF4aypRH7g==
        caps: [mds] allow *
        caps: [mgr] allow *
        caps: [mon] allow *
        caps: [osd] allow *
client.bootstrap-mds
        key: AQBji0hn9mJJHhAAPlJM8tEVuM7wV4jHY1n0GQ==
        caps: [mon] allow profile bootstrap-mds
client.bootstrap-mgr
        key: AQBji0hnGGZJHhAAEZazRz4V6Qfdc3tyyOXlRA==
        caps: [mon] allow profile bootstrap-mgr
client.bootstrap-osd
        key: AQBji0hny2hJHhAAP7kefIMqH64jE3X1QDZyOw==
        caps: [mon] allow profile bootstrap-osd
client.bootstrap-rbd
        key: AQBji0hnAGxJHhAAlYK+Y8gCHXhsH/3729mX0w==
        caps: [mon] allow profile bootstrap-rbd
client.bootstrap-rbd-mirror
        key: AQBji0hn8G5JHhAAImClxu9feXf8sTVtL93C9g==
        caps: [mon] allow profile bootstrap-rbd-mirror
……
```

# 获取用户
列出指定某一用户信息

```bash
ceph auth get {TYPE.ID}
```

示例：

```bash
root@ceph-1:~# ceph auth get client.admin
[client.admin]
        key = AQBii0hnHNvZFxAAzs6IHqobafeOMF4aypRH7g==
        caps mds = "allow *"
        caps mgr = "allow *"
        caps mon = "allow *"
        caps osd = "allow *"
 
# 还可以给命令加上 -o {filename} 选项把输入保存到一个文件中。
root@ceph-1:~# ceph auth get client.admin -o admin.key
root@ceph-1:~# cat admin.key 
[client.admin]
        key = AQBii0hnHNvZFxAAzs6IHqobafeOMF4aypRH7g==
        caps mds = "allow *"
        caps mgr = "allow *"
        caps mon = "allow *"
        caps osd = "allow *"
```

# 添加用户
添加一个用户会创建用户名(TYPE.ID)、密钥，以及包含在命令中用于创建该用户的所有能力，用户可使用其密钥向Ceph 存储集群进行身份验证。用户的能力授予该用户在Ceph monitor (mon)、Ceph OSD(osd)或Ceph 元数据服务器(mds)上进行读取、写入或执行的能力，可以使用以下几个命令来添加用户：

## ceph auth add
此命令是添加用户的规范方法，它会创建用户、生成密钥，并添加所有指定的能力。

```bash
# 添加用户
root@ceph-1:~# ceph auth add client.cuiliang mon 'allow r' osd 'allow rwx pool=mypool'
added key for client.cuiliang
 
# 查看
root@ceph-1:~# ceph auth get client.cuiliang
[client.cuiliang]
        key = AQBpH0tnK0jPGxAATUztIrdRlFILW1CyFq84eA==
        caps mon = "allow r"
        caps osd = "allow rwx pool=mypool"
```

## ceph auth get-or-create
此命令是创建用户较为常见的方式之一，它会返回包含用户名（在方括号中）和密钥的格式，如果该用户已存在，此命令以密钥文件格式返回用户名和密钥信息，还可以使用-o指定文件名选项输出保存到指定文件中。

```bash
# 创建用户
root@ceph-1:~# ceph auth get-or-create client.liang mon 'allow r' osd 'allow rwx pool=mypool'
[client.liang]
        key = AQDKH0tnKppMJxAAlQKhAFmJ2/DdBWU/NSHm2Q==
 
# 验证用户
root@ceph-1:~# ceph auth get client.liang
[client.liang]
        key = AQDKH0tnKppMJxAAlQKhAFmJ2/DdBWU/NSHm2Q==
        caps mon = "allow r"
        caps osd = "allow rwx pool=mypool"
 
# 再次创建用户
root@ceph-1:~# ceph auth get-or-create client.liang mon 'allow r' osd 'allow rwx pool=mypool'
[client.liang]
        key = AQDKH0tnKppMJxAAlQKhAFmJ2/DdBWU/NSHm2Q==
```

## ceph auth get-or-create-key
此命令是创建用户并仅返回用户密钥，对于只需要密钥的客户端（如libvirt) ，此命令非常有用。如果该用户已存在，此命令只返回用户的密钥，可以使用-o文件名选项将输出保存到某个文件。  
创建客户端用户时，可以创建不具有能力的用户，不具有能力的用户可以进行身份验证，但不能执行其他操作，此类客户端无法从监视器检索集群地图，但希望稍后再添加能力，可以使用`ceph auth caps`命令创建一个不具有能力的用户。  
典型的用户至少对Ceph monitor具有读取功能，并对 Ceph OSD具有读取和写入功能。此外，用户的OSD权限通常限制为只能访问特定的存储池。

```bash
# 只返回密钥信息
root@ceph-1:~# ceph auth get-or-create-key client.cui mon 'allow r' osd 'allow rwx pool=mypool'
AQBLIEtnH+O/BRAAeglp7Rz6A61ht+hq+pSfOA==
```

# 打印用户的密钥
```bash
ceph auth print-key
```

只获取单个指定用户的key信息

```perl
root@ceph-1:~# ceph auth print-key client.cuiliang
AQBpH0tnK0jPGxAATUztIrdRlFILW1CyFq84eA==
```

# 修改用户权限
使用`ceph auth caps`命令可以指定用户以及更改该用户的权限，设置新权限会完全覆盖当前的权限，因此要加上之前的用户已经拥有的权限和新的权限，如果看当前权限，可以运行ceph auth get USERTYPE.USERID，如果要添加权限，使用以下格式时还需要指定现有权限:

```bash
ceph auth caps USERTYPE.USERID daemon 'allow [r|w|x|*|...] [pool=pool-name] [namespace=namespace-name]' [daemon 'allow [r|w|x|*]...] [pool=pool-name] [namespace=namespace-name]']
```

示例：

```bash
# 查看用户当前权限
root@ceph-1:~# ceph auth print-key client.cuiliang
AQBpH0tnK0jPGxAATUztIrdRlFILW1CyFq84eA==root@ceph-1:~# ceph auth get client.cui
[client.cui]
        key = AQBLIEtnH+O/BRAAeglp7Rz6A61ht+hq+pSfOA==
        caps mon = "allow r"
        caps osd = "allow rwx pool=mypool"
 
# 修改用户权限
root@ceph-1:~# ceph auth caps client.cui mon 'allow rw' osd 'allow rw pool=mypool'
updated caps for client.cui
 
# 查看修改后权限
root@ceph-1:~# ceph auth get client.cui
[client.cui]
        key = AQBLIEtnH+O/BRAAeglp7Rz6A61ht+hq+pSfOA==
        caps mon = "allow rw" # 新增w权限
        caps osd = "allow rw pool=mypool" # 新增x权限
```

# 删除用户
要删除用户使用`ceph auth del TYPE.ID`，其中TYPE是client、osd、mon或mds之一，ID是用户名或守护进程的ID。

示例：

```bash
# 删除
root@ceph-1:~# ceph auth del client.cui
 
# 查询
root@ceph-1:~# ceph auth get client.cui
Error ENOENT: failed to find client.cui in keyring
```

# 导入用户
使用 ceph auth import 命令并指定密钥文件，可以导入一个或多个用户

```bash
ceph auth import -i /path/to/keyring
```


