# RBD快照
 在 Ceph 集群中，快照（Snapshot）是 RBD 的一项重要功能，可以用来对某个时间点的数据进行备份和恢复。

# 回收站
在 Ceph 的 RBD 中，"回收站" 是一个管理快照和镜像删除的功能，可以避免误操作导致的数据丢失。启用回收站后，删除的镜像或快照会被标记为 "垃圾" 状态，而不会立即从集群中清除，可以在需要时恢复或彻底删除。 14.2.0开始，RBD 回收站功能即默认可用。

## 镜像移动至回收站
```bash
root@ceph-1:~# rbd ls --pool rbd-data -l
NAME       SIZE   PARENT  FMT  PROT  LOCK
data-img1  3 GiB            2        excl
data-img2  4 GiB            2            
root@ceph-1:~# rbd trash move rbd-data/data-img2 
root@ceph-1:~# rbd ls --pool rbd-data -l
NAME       SIZE   PARENT  FMT  PROT  LOCK
data-img1  3 GiB            2        excl
```

## 查看回收站内容
```bash
root@ceph-1:~# rbd trash list rbd-data
281bb9bea770d data-img2
```

## 恢复回收站中的镜像
```bash
root@ceph-1:~# rbd trash restore rbd-data/281bb9bea770d
root@ceph-1:~# rbd ls --pool rbd-data -l
NAME       SIZE   PARENT  FMT  PROT  LOCK
data-img1  3 GiB            2        excl
data-img2  4 GiB            2
```

## 设置自动清理过期数据
可以为回收站设置自动清理过期数据的策略，以避免存储空间被长期占用。

```plain
rbd trash mv-expired rbd-data --expire 30
```

+ 以上命令会自动清理存储池中超过 30 天的回收站数据。

## 设置默认过期时间
```plain
rbd config set rbd-data rbd_trash_max_age 2592000  # 30 天
```

## 手动清理回收站
```plain
rbd trash purge rbd-data
```

# 快照与恢复
## 写入测试数据
```bash
root@ceph-client:/data# curl  http://www.baidu.com/  -o  baidu.html
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  2381  100  2381    0     0   4849      0 --:--:-- --:--:-- --:--:--  4839
root@ceph-client:/data# ls -lh
total 4.0K
-rw-r--r-- 1 root root 2.4K Dec  4 15:12 baidu.html
```

## 创建快照
```bash
# 命令格式rbd snap create <pool-name>/<image-name>@<snapshot-name>
root@ceph-1:~# rbd snap create rbd-data/data-img1@snap1
Creating snap: 100% complete...done.
```

## 查看快照
```bash
root@ceph-1:~# rbd snap ls rbd-data/data-img1
SNAPID  NAME   SIZE   PROTECTED  TIMESTAMP               
     4  snap1  3 GiB             Wed Dec  4 15:38:00 2024
```

## 恢复快照
客户端删除数据

```bash
root@ceph-client:~# cd /data/
root@ceph-client:/data# rm -rf baidu.html 
root@ceph-client:/data# ls -l
total 0
```

客户端卸载文件系统

```bash
root@ceph-client:~# umount /data
root@ceph-client:~# rbd unmap /dev/rbd0
```

服务端恢复快照

```bash
root@ceph-1:~# rbd snap rollback rbd-data/data-img1@snap1
Rolling back to snapshot: 100% complete...done.
```

+ **注意**：此命令会覆盖镜像中的当前数据。

客户端重新挂载并验证

```bash
root@ceph-client:~# rbd --id cuiliang -p rbd-data map data-img1
/dev/rbd0
root@ceph-client:~# mount /dev/rbd0 /data/
root@ceph-client:~# cd /data/
root@ceph-client:/data# ls -lh
total 4.0K
-rw-r--r-- 1 root root 2.4K Dec  4 15:29 baidu.html
```

## 删除快照
```bash
# 命令格式rbd snap rm <pool-name>/<image-name>@<snapshot-name>
root@ceph-1:~# rbd snap rm rbd-data/data-img1@snap1
Removing snap: 100% complete...done.
root@ceph-1:~# rbd snap ls rbd-data/data-img1
```

## 批量删除快照
```plain
rbd snap purge rbd-data/data-img1
```

---

# 克隆快照
Ceph 支持从快照创建新的 RBD 镜像（即克隆）。克隆可以用来快速复制镜像。

## 创建快照
```plain
root@ceph-1:~# rbd snap create rbd-data/data-img1@snap1
Creating snap: 100% complete...done.
root@ceph-1:~# rbd snap ls rbd-data/data-img1
SNAPID  NAME   SIZE   PROTECTED  TIMESTAMP               
     6  snap1  3 GiB             Wed Dec  4 15:53:44 2024
```

## 保护快照
 基于快照创建克隆时，父快照必须设置为“受保护”状态，否则 Ceph 不允许克隆  

```plain
root@ceph-1:~# rbd snap protect rbd-data/data-img1@snap1                                                           
root@ceph-1:~# rbd snap ls rbd-data/data-img1                                                                      
SNAPID  NAME   SIZE   PROTECTED  TIMESTAMP                                                                         
     6  snap1  3 GiB  yes        Wed Dec  4 15:53:44 2024
```

## 克隆快照到新镜像
```bash
root@ceph-1:~# rbd clone rbd-data/data-img1@snap1 rbd-data/my-clone
root@ceph-1:~# rbd ls rbd-data -l
NAME             SIZE   PARENT                    FMT  PROT  LOCK
data-img1        3 GiB                              2            
data-img1@snap1  3 GiB                              2  yes       
data-img2        4 GiB                              2            
my-clone         3 GiB  rbd-data/data-img1@snap1    2
```

## 解锁克隆依赖关系
解锁克隆后，可以独立管理克隆的镜像：

```bash
root@ceph-1:~# rbd flatten rbd-data/my-clone
Image flatten: 100% complete...done.
root@ceph-1:~# rbd ls rbd-data -l
NAME             SIZE   PARENT  FMT  PROT  LOCK
data-img1        3 GiB            2            
data-img1@snap1  3 GiB            2  yes       
data-img2        4 GiB            2            
my-clone         3 GiB            2 
```

# 挂载快照（只读访问）
快照可以通过只读方式挂载。

## 映射快照
```bash
root@ceph-1:~# rbd snap ls rbd-data/data-img1
SNAPID  NAME   SIZE   PROTECTED  TIMESTAMP               
     6  snap1  3 GiB  yes        Wed Dec  4 15:53:44 2024
root@ceph-1:~# rbd map rbd-data/data-img1@snap1 --read-only
/dev/rbd0
```

## 挂载快照
```plain
root@ceph-1:~# mkdir /mnt/snapshot
root@ceph-1:~# mount /dev/rbd/rbd-data/data-img1@snap1 /mnt/snapshot/
mount: /mnt/snapshot: WARNING: device write-protected, mounted read-only.
root@ceph-1:~# cd /mnt/snapshot/
root@ceph-1:/mnt/snapshot# ls -lh
total 4.0K
-rw-r--r-- 1 root root 2.4K Dec  4 15:29 baidu.html
```

## 取消挂载和映射
```bash
root@ceph-1:~# umount /mnt/snapshot
root@ceph-1:~# rbd unmap /dev/rbd/rbd-data/data-img1@snap1
```

# 注意事项
1. **快照是只读的：**

快照是数据的静态副本，不能直接修改。

2. **快照占用空间：**

快照本身不占用额外空间，但快照与原始镜像的数据差异会占用空间，需定期清理不需要的快照。

3. **影响性能：**

大量快照可能会对性能有影响，建议限制单个镜像的快照数量。

4. **恢复操作需谨慎：**

快照回滚会覆盖当前镜像数据，请确保数据备份完毕。


