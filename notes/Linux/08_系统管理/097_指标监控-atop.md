# 指标监控-atop
# atop 介绍
`top` 已经是 Linux 下很常用的系统监控工具了，但是`top` 是实时监控工具，`atop` 是性能审计与历史分析工具。很多情况下系统故障后已经无法正常登录查看 top 指标，此时就需要通过 atop 工具查看历史指标信息，进行故障排查。

|  | `top` | `atop` |
| --- | --- | --- |
|  主要用途   |  实时查看系统资源使用情况   |  长期监控与历史性能分析   |
|  数据来源   |  实时读取 `/proc` |  实时采样 + 记录日志 (`/var/log/atop/atop_YYYYMMDD`)   |
|  使用方式   |  交互式命令行界面   |  实时模式 / 离线回放模式 (`atop -r <logfile>`)   |
| CPU 监控项 | ✅ | ✅（支持 per-process / per-core / steal time） |
| 内存监控项 | ✅ | ✅（包括 swap、page fault、cache） |
| I/O监控项 | ❌ | ✅（磁盘、块设备级别） |
| 网络监控项 | ❌ | ✅（网络接口、socket 级别） |
| 守护进程级性能监控项 | ❌ | ✅（支持 cgroup/container） |


# 安装 atop
## 安装软件包
RHEL 系统

```bash
# 安装 EPEL 源
dnf install epel-release -y

# 安装 atop
dnf install atop -y
```

Ubuntu 系统

```bash
# 更新软件包
apt update -y

# 安装 atop
apt install atop -y
```

## 修改配置
> 参考以下步骤，配置 atop 监控周期及日志保留时间。
>

执行以下命令，使用 VIM 编辑器打开 atop 配置文件。

```bash
vim /etc/sysconfig/atop
```

按 i 进入编辑模式，修改以下配置：

+ 将 `LOGINTERVAL=600` 修改为 `LOGINTERVAL=30`，表示将默认的600s监控周期修改为30s。建议修改为30s，您可结合实际情况进行修改。
+ 将 `LOGGENERATIONS=28` 修改为 `LOGGENERATIONS=7`，表示将默认的日志保留时间28天修改为7天。为避免 atop 长时间运行占用太多磁盘空间，建议修改为7天，您可结合实际情况进行修改。

保存修改并退出编辑器，然后重启 atop

```bash
systemctl restart atop
```

# 使用 atop
## 查看实时指标
执行`atop [采样间隔秒数] [采样次数]`命令进入交互模式。

```shell
# 以默认配置查看（10秒刷新一次）。
atop

# 每5秒查看一次系统指标。
atop 5

# 以10秒为间隔，采集30次系统指标。
atop 10 30

# 以30秒为间隔，采集10次，并结果写入文件。
atop 30 10 > /tmp/atop.mem
```

在交互模式下，可使用单个字母键切换视图或者排序。

| 按键 | 功能 | 用途 |
| --- | --- | --- |
| c | 显示完整命令行 | 查看进程启动的具体参数。 |
| g | 通用视图（默认） | 综合查看 CPU、内存增长、磁盘 I/O。 |
| m/M | 内存视图/按内存排序 | 用于分析内存使用、页错误，排查内存泄漏。 |
| d/D | 磁盘视图/按磁盘排序 | 用于分析磁盘 I/O，定位磁盘读写高的进程。 |
| n/N | 网络视图/按网络排序（需[安装并加载netatop内核模块](https://help.aliyun.com/zh/ecs/user-guide/use-the-atop-tool-to-monitor-linux-system-metrics#b34588453b991)） | 用于分析网络流量，定位网络流量大的进程。 |
| a | 聚合视图 | 将一个程序的所有线程/进程资源消耗聚合在一起。 |
| C | 按 CPU 排序 | 快速定位消耗 CPU 最多的进程。 |
| h | 显示帮助 | 查看更多快捷键。 |
| q | 退出 | 退出交互模式。 |


## 查看历史指标
atop服务成功运行后，会定期在`/var/log/atop/`目录下生成以`atop_YYYYMMDD`格式命名的二进制日志文件。

`atop` 的日志是二进制文件，使用`cat`、`less`或`vim`等文本编辑器打开会显示乱码。

1. 读取历史日志文件。

使用`atop -r <日志文件>`命令加载指定的日志文件。

```bash
# 查看当天的日志，atop会自动查找当天的日志文件
atop -r

# 查看指定日期的日志
atop -r /var/log/atop/atop_YYYYMMDD
```

2. 在日志中跳转到指定时间点。

加载日志后，界面显示的是该日志文件的第一个时间点快照。

+ 按 t 键：向后跳转到下一个时间点的快照。
+ 按 T 键（大写）：向前跳转到上一个时间点的快照。
+ 按 b 键：输入具体时间（格式 HH:MM），直接跳转到该时间点。

## 生成指标报告
`atopsar`是atop工具包中的一个非交互式的命令行工具，用于从atop记录的二进制日志文件中提取数据并生成系统性能报告。

### 使用示例
查看当前系统在 1 分钟内（12 次，间隔 5 秒）的CPU使用率指标报告。

```shell
atopsar -c 5 12
```

查看当天指定时间段的内存指标报告。

```shell
# 查看当天18：00至18：01的内存指标报告
atopsar -m -b 18:00 -e 18:01
```

查看指定日期内，指定时间段的内存指标报告。

```shell
# 查看2025年8月15日 18：00至18：01的内存指标报告。
atopsar -m -r /var/log/atop/atop_20250815 -b 18:00 -e 18:01
```

### atopsar命令基本语法
```bash
atopsar [options] [interval] [count]
```

+ [options]：用于指定报告类型的标志，例如`-c`（CPU），`-m`（内存），`-d`（磁盘）。
+ [interval]：指定输出报告的时间间隔，单位为秒。
+ [count]：指定输出报告的次数。

# 指标解读
## 系统资源概览
![](https://via.placeholder.com/800x600?text=Image+3dcd779091986008)

| 指标类别 | 指标 | 详细说明 | 单位 |
| --- | --- | --- | --- |
| ATOP | 主机名, 日期 | 显示当前主机名、采样日期和时间。 | - |
| | 采样间隔 | 显示两次采样之间的时间间隔。 | 秒 |
| PRC（进程总体情况） | `sys` | 在采样间隔内，所有进程在内核模式下消耗的CPU总时间。 | 秒 |
| | `user` | 在采样间隔内，所有进程在用户模式下消耗的CPU总时间。 | 秒 |
| | `#proc` | 系统当前的总进程数量。 | 个 |
| | `#trun` | 处于运行中状态的平均线程数。 | 个 |
| | `#tslpi` | 处于可中断睡眠状态的线程数。 | 个 |
| | `#tslpu` | 处于不可中断睡眠状态的线程数。 | 个 |
| | `#zombie` | 僵尸进程的数量。 | 个 |
| | `clones` | 在采样间隔内，通过clone系统调用创建的新进程/线程数。 | 个/秒 |
| | `#exit` | 在采样间隔内，退出的进程数量。 | 个/秒 |
| CPU/cpu（CPU整体/单个CPU核心） | `sys%` | CPU在内核模式下花费的时间百分比。 | % |
| | `user%` | CPU在用户模式下花费的时间百分比。 | % |
| | `irq%` | CPU处理硬件中断（irq）和软件中断（softirq）的时间百分比。 | % |
| | `idle%` | CPU处于完全空闲状态的时间百分比。 | % |
| | `wait%` | CPU因等待磁盘I/O完成而处于空闲状态的时间百分比。 | % |
| | `steal%` | 虚拟CPU等待物理CPU时间的百分比（被宿主机或其他虚拟机占用的时间）。 | % |
| | `guest%` | 运行虚拟机所花费的CPU时间的百分比。 | % |
| | `freq%` | CPU的平均运行频率，相对于其最大频率的百分比。 | % |
| CPL（CPU负载） | `avg1`/`avg5`/`avg15` | 过去1分钟/5分钟/15分钟的系统平均负载。 | - |
| | `csw` | 在采样间隔内，上下文切换的次数。 | 次/秒 |
| | `intr` | 在采样间隔内，发生的中断总次数。 | 次/秒 |
| MEM（物理内存） | `tot` | 系统物理内存总量。 | GiB/MiB |
| | `free` | 完全未被使用的空闲内存量。 | GiB/MiB |
| | `cache` | 用作页面缓存的内存量，用于缓存文件数据。 | GiB/MiB |
| | `dirty` | 在页面缓存中，已被修改但尚未写回磁盘的脏页大小。 | MiB |
| | `buff` | 用作缓冲区缓存的内存量，用于缓存块设备元数据。 | MiB |
| | `slab` | 内核用于自身数据结构（slab分配器）的内存量。 | MiB |
| | `shmem` | 共享内存（包括tmpfs）的大小。 | MiB |
| | `vmbal` | （仅限32位系统）用于虚拟内存区域的平衡内存量。 | MiB |
| SWP（交换分区） | `tot` | 交换分区的总大小。 | GiB/MiB |
| | `free` | 空闲的交换分区大小。 | GiB/MiB |
| | `swcac` | 已被换出但同时又被缓存的内存大小。 | MiB |
| | `vmcom` | 已被应用程序申请的虚拟内存总量。 | GiB/MiB |
| | `vmlim` | 允许申请的虚拟内存上限。 | GiB/MiB |
| PAG（分页活动） | `scan` | 内核在采样间隔内为回收内存而扫描的页数。 | 页/秒 |
| | `steal` | 内核在扫描后成功回收的页数。 | 页/秒 |
| | `stall` | 内核因内存不足而停滞以等待页面回收的次数。 | 次/秒 |
| | `swin` | 从交换分区换入到物理内存的页面数。 | 页/秒 |
| | `swout` | 从物理内存换出到交换分区的页面数。 | 页/秒 |
| DSK（磁盘）<br/>LVM（逻辑卷） | `busy` | 磁盘繁忙的时间百分比。达到100%表示磁盘饱和。 | % |
| | `read`/`write` | 在采样间隔内，完成的读/写请求数量。 | 个/秒 |
| | `KiB/r`/`KiB/w` | 每个读/写请求的平均数据大小。 | KB |
| | `Msec/r`/`Msec/w` | 每个读/写请求的平均耗时（包括排队和服务时间）。 | 毫秒 |
| | `avio` | 平均I/O请求的服务时间（不含排队时间）。 | 毫秒 |
| NET（网络） | `transport` | TCP和UDP层的收发包统计。 | 包/秒 |
| | `network` | IP层的收发包、转发包统计。 | 包/秒 |
| | `*if*` | 显示每个网络接口的活动情况。 | - |
| | `pcki`/`pcko` | 接口接收/发送的数据包数量。 | 包/秒 |
| | `spdi`/`spdo` | 接口接收/发送的速率。 | Mbps |
| | `erri`/`erro` | 接口接收/发送时发生的错误数。 | 个/秒 |
| | `drpi`/`drpo` | 接口接收/发送时丢弃的数据包数。 | 个/秒 |


## 进程级详情
![](https://via.placeholder.com/800x600?text=Image+69bdaabe910fede3)

| 视图 | 指标 | 详细说明 | 单位 |
| --- | --- | --- | --- |
| 通用视图（默认） | `PID` | 进程ID。系统的唯一进程标识符。 | - |
| | `S` | 进程状态。R-运行中, S-可中断睡眠, D-不可中断睡眠, Z-僵尸, E-已退出。 | - |
| | `CPU%` | CPU使用率。 | % |
| | `MEM%` | 内存使用率。 | % |
| | `THR` | 线程数。 | 个 |
| | `PAG` | 主要缺页错误。表示进程需要从磁盘读取数据到内存的次数，是衡量磁盘I/O压力的一个指标。 | 次/秒 |
| | `CMD` | 命令名。进程的可执行文件名。按 c 键后会显示完整命令行。 | - |
| 内存视图 | `VSIZE` | 虚拟内存大小。进程向系统申请的虚拟地址空间总大小。 | KiB/MiB/GiB |
| | `RSIZE` | 常驻内存大小。进程当前实际占用物理内存的大小。 | KiB/MiB/GiB |
| | `SHR` | 共享内存大小。 | KiB/MiB/GiB |
| | `RGROW` | 常驻内存增长量。正数表示内存消耗在增加，负数表示在减少。 | KiB |
| | `VGROW` | 虚拟内存增长量。 | KiB |
| 磁盘视图 | `DSK%` | 磁盘活动百分比。进程产生的磁盘I/O繁忙时间占总磁盘繁忙时间的百分比。 | % |
| | `RDDSK`/`WRDSK` | 读取/写入的磁盘数据。 | KiB/MB |
| | `WCANCL` | 取消的写入量。进程写入页面缓存后，在数据被同步到磁盘前又被删除的数据量。 | KiB/MB |
| 网络视图 | `NET%` | 网络活动百分比。进程产生的网络流量占所有进程总流量的百分比。 | % |
| | `TCPSND`/`TCPRCV` | TCP发送/接收量。 | KiB/MB |
| | `UDPSND`/`UDPRCV` | UDP发送/接收量。 | KiB/MB |


# 常见问题
## atop -r 异常
执行 `atop -r` 时提示 `stat raw file： No such file or directory`，是什么原因？

这个错误表示atop找不到指定日期的日志文件。可能的原因有：

1. 指定的日期`atop`服务并未运行。
2. 日志文件因轮转策略已被删除（超过了`LOGGENERATIONS`设置的保留数量）。
3. 查询的是未来的日期。

请检查`/var/log/atop`目录下实际存在的日志文件列表。

## 减少 atop 磁盘占用
可通过修改配置减少磁盘空间占用，修改配置后，需重启`atop`服务：

1. 减少日志保留天数：在配置文件中调低`LOGGENERATIONS`的值，例如从`28`改为`14`。
2. 降低采集频率：在配置文件中调高`LOGINTERVAL`的值，例如从`600`改为`1200`。

## 按 n 看不到网络流量
atop默认不包含按进程统计网络流量的功能。要启用此功能，需要额外安装并加载`netatop`内核模块。

安装内核开发包及编译所需软件环境。

```bash
sudo yum install -y kernel-devel dkms elfutils-libelf-devel
```

下载netatop源码至指定目录。

```bash
cd /usr/src/ && sudo wget https://www.atoptool.nl/download/netatop-3.2.2.tar.gz
```

解压源码并进入源码目录。

```bash
sudo tar -zxvf netatop-3.2.2.tar.gz && cd netatop-3.2.2
```

基于源码构建并安装模块和守护程序。

```bash
sudo make && sudo make install
```

启动`netatop`服务。

```bash
sudo systemctl start netatop
```

验证`netatop`是否安装成功。

执行`atop`进入交互操作界面，按`n`键查看，若进程详情列表中包含`NET`列，表示安装成功。


