# KVM磁盘配置
# 一、LVM作为storage pool
1. 宿主机添加磁盘



1. 给/dev/sdc分区

![img_4864.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_4864.png)

1. 创建pv



1. 创建vg



1. 创建lv



1. 创建了一个 Storage Pool 的定义文件



 



1. 加载定义文件

![img_1056.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_1056.png)

1. 启用vg1



1. 查看使用vg1

![img_1984.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_1984.png)

# 二、创建虚拟机镜像（虚拟机安装位置）
1. 创建虚拟机镜像文件

![img_4208.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_4208.png)

1. 查看虚拟机镜像文件

![img_2448.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_2448.png)

1. 使用虚拟机镜像文件

![img_2464.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_2464.png)

# 三、基础镜像、派生文件
1. 创建基础镜像文件



1. 指定后端文件
2. ![img_544.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_544.png)
+ -f：指定文件的格式
+ -o：选项中使用了backing_file这个选项来指定其后端镜像文件，那么这个创建的镜像文件new_1.qcow2只记录操作过程仅记录与基础镜像文件的差异部分

![img_2272.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_2272.png)

1. 创建new_base.qcow2镜像文件作为另一个基础镜像

![img_2400.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_2400.png)

1. 改变new_1基础镜像文件为new_base.qcow2

![img_4288.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_4288.png)

1. 查看new_1镜像文件信息



1. 使用新派生镜像



+ 派生镜像是在基础镜像的基础上，做个性化定制
1. 将基础镜像和派生镜像合并，生成新的基础镜像

![img_1328.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_1328.png)

1. 查看新基础镜像信息



# 四、转换镜像格式
1. 查看初始镜像信息

![img_4864.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_4864.png)

1. 将raw镜像转换为qcow2格式



+ qemu-img    convert    -f         源格式    -O 目标格式    源磁盘         目标磁盘
1. 查看转换后的磁盘镜像信息

![img_3936.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_3936.png)

1. 压缩镜像文件（只有qcow2和qcow格式的镜像文件才支持压缩）

![img_192.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_192.png)

# 五、改变磁盘大小
1. 查看初始镜像信息



1. 增加磁盘大小



1. 减少磁盘大小

![img_1152.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_1152.png)

+ qcow2格式文件不支持缩小镜像的操作。

# 六、磁盘快照
1. 创建磁盘快照

![img_4864.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_4864.png)

1. 查看磁盘快照

![img_4816.jpeg](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_4816.jpeg)

1. 使用磁盘快照



1. 删除磁盘快照

![img_4784.jpeg](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_4784.jpeg)

# 七、基本镜像和增量镜像实验
| 虚拟机类型 | 虚拟机名称 | 镜像名称 | 配置文件名称 |
| --- | --- | --- | --- |
| 基本镜像 | centos7.1 | centos7.0.qcow2 | Centos7.1.xml |
| 增量镜像 | centos7-add | centos7-add.img | centos7-add.xml |


1. 查看基本镜像

![img_624.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_624.png)

1. 创建增量镜像

![img_4016.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_4016.png)

1. 创建增量镜像虚拟机xml配置文件



![img_2032.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_2032.png)

1. 修改xml配置文件



![img_3184.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_3184.png)



1. 加载增量虚拟机配置文件

![img_4416.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_4416.png)

1. 查看虚拟机列表并启动增量虚拟机



1. 查看基础虚拟机和增量虚拟机的原始存储大小

![img_4000.jpeg](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_4000.jpeg)

1. 在增量虚拟机上创建1G大小文件

![img_2096.png](https://raw.githubusercontent.com/Oumu33/notes/main/notes/images/img_2096.png)

1. 查看基础虚拟机和增量虚拟机的当前存储大小



+ 基础镜像大小不变，增量镜像增加了1G


