# 自动弹性缩放(HPA)
# HPA 简介
Horizontal Pod Autoscaler (HPA) 是 Kubernetes 中的一种自动扩展机制，它可以根据 Pod 的 CPU 或内存使用率等指标自动调整 Pods 的副本数。通过 HPA，用户无需手动监控和调整应用程序的负载，Kubernetes 会根据预定的指标和阈值自动进行扩容或缩容操作。

# 工作原理与详细配置
## 配置清单字段
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: example-hpa
  namespace: default
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: my-app

  minReplicas: 2 # 最小副本数
  maxReplicas: 10 # 最大副本数

  metrics:
    # 类型 1：资源指标（如 CPU 和 memory）
    - type: Resource
      resource:
        name: cpu  # 指标名称：cpu 或 memory
        target:
          type: Utilization  # 类型为利用率（百分比），另一种是 AverageValue
          averageUtilization: 60  # 期望平均利用率为 60%

    - type: Resource
      resource:
        name: memory
        target:
          type: AverageValue  # 指定目标为绝对值（支持 CPU/Memory）
          averageValue: "500Mi"  # 所有 Pod 的平均 memory 为 500Mi 时扩缩容

    # 类型 2：Pods 指标（每个 Pod 的自定义指标）
    - type: Pods
      pods:
        metric:
          name: requests_per_second  # 自定义的指标名（每个 Pod）
        target:
          type: AverageValue
          averageValue: "10"  # 每个 Pod 平均 RPS 达到 10 时触发扩容

    # 类型 3：Object 指标（与某个 Kubernetes 对象相关的指标）
    - type: Object
      object:
        metric:
          name: nginx_ingress_controller_requests  # 指标名称
        describedObject:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          name: my-ingress  # 监控的对象名称
        target:
          type: Value
          value: "1000"  # 当前对象的请求数达到 1000 时扩容

    # 类型 4：External 指标（外部系统提供的指标，如消息队列、云服务指标等）
    - type: External
      external:
        metric:
          name: queue_messages_ready  # 外部指标名，例如消息队列中的 ready 数
          selector:
            matchLabels:
              queue: my-queue  # 可选：通过标签选择器过滤外部指标
        target:
          type: Value
          value: "50"  # 指标值达到 50 时扩容（如消息堆积数）

  behavior:
    scaleUp:
      stabilizationWindowSeconds: 0  # 扩容稳定窗口，单位为秒。默认值为 0，表示立即扩容。
      selectPolicy: Max  # 多个指标时如何选择扩容数量。默认是 Max，可选：Max、Min、Disabled
      policies:
        - type: Percent
          value: 100  # 每次扩容最多增加当前副本数的 100%
          periodSeconds: 15  # 评估周期（秒），默认 15 秒
        - type: Pods
          value: 4  # 每次最多扩容 4 个 Pod
          periodSeconds: 15

    scaleDown:
      stabilizationWindowSeconds: 300  # 缩容稳定窗口，默认是 300 秒（5 分钟）
      selectPolicy: Max  # 多个策略时，选择最大的缩容值作为决策
      policies:
        - type: Percent
          value: 100  # 每次最多减少当前副本数的 100%
          periodSeconds: 15
        - type: Pods
          value: 4  # 每次最多缩容 4 个 Pod
          periodSeconds: 15

```

## kubernetes的监控指标
+ Core metrics(核心指标)：从 Kubelet、cAdvisor 等获取度量数据，再由metrics-server提供给 Dashboard、HPA 控制器等使用。
+ Custom Metrics(自定义指标)：由Prometheus Adapter提供API custom.metrics.k8s.io，由此可支持任意Prometheus采集到的指标。

核心指标只包含node和pod的cpu、内存等，一般来说，核心指标作HPA已经足够，但如果想根据自定义指标:如请求qps/5xx错误数来实现HPA，就需要使用自定义指标了，目前Kubernetes中自定义指标一般由Prometheus来提供，再利用k8s-prometheus-adpater聚合到apiserver，实现和核心指标（metric-server)同样的效果。

## 核心扩缩容公式
HPA 的核心公式如下：

`desiredReplicas = ceil[currentReplicas * (currentMetricValue / desiredMetricValue)]`

**参数解释：**

+ **currentReplicas**：当前运行的 Pod 副本数量。
+ **currentMetricValue**：当前实际监控到的指标值（如 CPU 使用率）。
+ **desiredMetricValue**：HPA 配置中设定的目标指标值（如 50% CPU 使用率）。

**扩缩容行为：**

+ **扩容（Scale Up）**：当 `currentMetricValue > desiredMetricValue`。
+ **缩容（Scale Down）**：当 `currentMetricValue < desiredMetricValue`。
+ **无操作**：当 `currentMetricValue / desiredMetricValue` 比值接近 1.0（默认容忍度为 ±10%）。

## 避免频繁扩缩容的容忍机制
HPA 默认的容忍度为 10%。当比值在 0.9 至 1.1 之间时，不会触发扩缩容，以减少因指标波动导致的不必要操作，确保系统稳定性。

## 多指标处理与优先级
当 HPA 配置了多个指标时：

+ 每个指标独立计算所需副本数。
+ HPA 选择**最大副本数**作为最终值，确保系统优先扩容以保持服务可用性。

## 缩容稳定化机制
为了避免快速缩容带来的系统抖动，HPA 引入了缩容稳定化机制：

+ **默认时间**：5 分钟。
+ **工作原理**：在稳定化时间内，选择过去 5 分钟内的最高副本数作为缩容目标。

# HPA 的四种指标类型详解
| **类型** | **数据来源** | **监控粒度** | **适用场景** | **优点** |
| --- | --- | --- | --- | --- |
| **Resource** | Kubernetes 内置资源（如 CPU、内存） | 每个 Pod 的资源使用率 | 标准扩缩容场景，如 CPU 或内存利用率 | 配置简单，无需额外工具 |
| **Pod** | 每个 Pod 的自定义指标 | 单个 Pod 的运行状态 | 微观监控，如 QPS、处理延迟、队列长度 | 灵活适用于自定义指标 |
| **Object** | Kubernetes 对象（如 Ingress） | 特定对象的行为 | 宏观监控，如 Ingress 请求速率或 Service 流量 | 适合对象级别扩缩容 |
| **External** | 集群外部系统（如云服务指标） | 无直接关联 Kubernetes | 云原生场景，如 Kafka 消息队列或 AWS SQS 指标 | 支持复杂的外部系统监控 |


## Resource 类型
+ **数据来源**：Kubernetes 内置的资源指标（CPU、内存等），通过 Metrics Server 提供。
+ **适用场景**：监控 CPU 和内存的使用率，适用于大多数应用的标准扩缩容。
+ **优点**：配置简单，无需额外的自定义指标。
+ **示例配置**：

```yaml
metrics:
- type: Resource
  resource:
    name: cpu
    target:
      type: Utilization
      averageUtilization: 50
```

**解释：**

+ 目标：将 CPU 利用率维持在 50%。
+ HPA 会实时监控所有 Pod 的 CPU 使用率，并根据公式调整副本数。

## Pod 类型
+ **数据来源**：通过 Prometheus Adapter 暴露的 Pod 自定义指标。
+ **适用场景**：需要监控单个 Pod 的运行状态或性能（如 QPS、队列长度、处理延迟）。
+ **优点**：适合微观层面的监控。
+ **示例配置**：

```yaml
metrics:
- type: Pods
  pods:
    metric:
      name: qps
    target:
      type: AverageValue
      averageValue: 100
```

**解释：**

+ 目标：将每个 Pod 的平均 QPS 维持在 100。
+ HPA 会计算所有 Pod 的平均 QPS，并基于公式扩缩容。

## Object 类型
+ **数据来源**：Kubernetes 对象（如 Ingress、Service 或 CRD）的指标。
+ **适用场景**：根据对象行为扩缩容，例如根据 Ingress 的流量扩容后端 Deployment。
+ **优点**：适合宏观层面的监控。
+ **示例配置**：

```yaml
metrics:
- type: Object
  object:
    metric:
      name: ingress_request_count
    describedObject:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      name: example-ingress
    target:
      type: Value
      value: 1000
```

**解释：**

+ 目标：当 Ingress 的请求速率达到 1000 时扩容。
+ HPA 会监控 Ingress 的请求速率，并动态调整副本数。

## External 类型
+ **数据来源**：集群外部系统的指标（如云服务或第三方工具）。
+ **适用场景**：需要根据外部系统的状态扩缩容，如 Kafka 消息队列长度或 AWS SQS 指标。
+ **优点**：支持云原生应用的复杂场景。
+ **示例配置**：

```yaml
metrics:
- type: External
  external:
    metric:
      name: sqs_queue_length
    target:
      type: AverageValue
      averageValue: 500
```

**解释：**

+ 目标：将 AWS SQS 队列长度控制在 500。
+ HPA 会实时监控外部系统的指标，并动态扩缩容。

# HPA 总结
## 优势
1. **动态扩缩容**：基于实时指标调整副本数，提升资源利用效率。
2. **多场景适配**：支持多种指标类型（Resource、Pod、Object、External），灵活适配不同需求。
3. **稳定性保障**：通过缩容稳定化机制和容忍机制，避免频繁扩缩容引发的不稳定。

## 局限性
1. **对象级指标需额外工具支持**：如 Object 类型指标依赖 Prometheus Adapter 或自定义实现。
2. **延迟性**：HPA 的扩缩容决策需要一定的时间（默认同步周期为 15 秒），可能在高负载突发时存在响应延迟。

## 如何选择合适的指标类型
| **需求场景** | **推荐类型** | **原因** |
| --- | --- | --- |
| 需要基于 CPU 或内存利用率扩缩容 | **Resource** | Kubernetes 内置支持，最简单直接。 |
| 需要监控 Pod 的自定义性能指标（如 QPS、队列长度等） | **Pod** | 适合微观层面的监控，灵活支持自定义指标。 |
| 需要根据 Kubernetes 对象的行为扩缩容（如 Ingress 流量） | **Object** | 适合宏观层面的监控，但需借助 Prometheus Adapter 等工具暴露指标。 |
| 需要根据外部系统（如 Kafka 消费量或云服务指标）扩缩容 | **External** | 适合云原生复杂场景，支持第三方系统的指标监控。 |



