# HPA操作实践(内置指标)
基于 CPU 或内存使用率进行扩缩容，适用于大多数常规应用。  

# 资源部署
## 创建 deployment
假设有一个 **nginx** 部署，我们希望它基于 CPU 使用率自动扩缩容

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: harbor.local.com/library/nginx:latest
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              cpu: "100m" # Pod 启动时最少分配 0.1 核 CPU
              memory: "128Mi"
            limits:
              cpu: "500m" # Pod 最多使用 0.5 核 CPU
              memory: "256Mi"
```

## 创建 HPA
 HPA 在 CPU 使用率超过 **50%** 时进行扩容

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: nginx-hpa
  namespace: default
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nginx
  minReplicas: 1 # 最小副本数为 1
  maxReplicas: 5 # 最大副本数为 5
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 50 # 当 CPU 使用率 超过 50% 时，HPA 会增加副本
```

# 验证 HPA
## 观察当前 HPA 状态信息
```bash
# kubectl apply -f .                                                                                                                           
deployment.apps/nginx created
horizontalpodautoscaler.autoscaling/nginx-hpa created
# kubectl get pod        
NAME                     READY   STATUS    RESTARTS   AGE
nginx-5768874d94-jqgmb   1/1     Running   0          44s
# kubectl top pod                                                                                                                              
NAME                     CPU(cores)   MEMORY(bytes)   
nginx-5768874d94-jqgmb   0m           10Mi
# kubectl get hpa nginx-hpa -w                                                                                                                 
NAME        REFERENCE          TARGETS       MINPODS   MAXPODS   REPLICAS   AGE
nginx-hpa   Deployment/nginx   cpu: 0%/50%   1         5         1          8m25s
```

 `TARGETS` 显示的是 `0%/50%`，说明当前 CPU 使用率为 0%，目标阈值是 50%。  

## 提高 CPU 负载验证扩缩容
进入容器后通过 stress 工具提高 cpu 负载

```bash
# kubectl exec -it nginx-5768874d94-jqgmb -- bash
root@nginx-5768874d94-jqgmb:/# apt update && apt install -y stress
root@nginx-5768874d94-jqgmb:/# stress --cpu 2 --timeout 300
stress: info: [156] dispatching hogs: 2 cpu, 0 io, 0 vm, 0 hdd
```

观察 hpa 扩容情况

```bash
# kubectl get hpa nginx-hpa -w                                                                                                                 
NAME        REFERENCE          TARGETS       MINPODS   MAXPODS   REPLICAS   AGE
nginx-hpa   Deployment/nginx   cpu: 0%/50%   1         5         1          8m25s
nginx-hpa   Deployment/nginx   cpu: 23%/50%   1         5         1          11m
nginx-hpa   Deployment/nginx   cpu: 384%/50%   1         5         1          11m
nginx-hpa   Deployment/nginx   cpu: 144%/50%   1         5         4          11m
nginx-hpa   Deployment/nginx   cpu: 125%/50%   1         5         5          12m
# kubectl get pod                                
NAME                     READY   STATUS    RESTARTS   AGE
nginx-5768874d94-5f6vz   1/1     Running   0          118s
nginx-5768874d94-fmgrc   1/1     Running   0          103s
nginx-5768874d94-jqgmb   1/1     Running   0          6m11s
nginx-5768874d94-kt4f4   1/1     Running   0          118s
nginx-5768874d94-pr6jf   1/1     Running   0          118s
```

 此时 `REPLICAS` 从 `1` 变为 `5`，表示 HPA 进行了扩容。  

## 降低 CPU 负载验证缩容
停止stress 工具降低 cpu 负载，此时观察 hpa 缩容情况

```bash
# kubectl get hpa nginx-hpa -w                                                                                                                 
NAME        REFERENCE          TARGETS       MINPODS   MAXPODS   REPLICAS   AGE
nginx-hpa   Deployment/nginx   cpu: 100%/50%   1         5         5          13m
nginx-hpa   Deployment/nginx   cpu: 3%/50%     1         5         5          14m
nginx-hpa   Deployment/nginx   cpu: 0%/50%     1         5         5          15m
nginx-hpa   Deployment/nginx   cpu: 0%/50%     1         5         1          19m
```

# 以内存为指标
如果希望 HPA 依据 **内存** 进行扩缩容，可修改如下

```yaml
metrics:
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80  # 目标内存使用率 80%
```




