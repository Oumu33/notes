# 服务和网络
# <font style="color:rgb(36, 43, 60);">网络策略</font>
## 参考文档
[https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/](https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/)

## 例题
在现有的namespace my-app中创建一个名为allow-port-from-namespace的新NetworkPolicy

确保新的NetworkPolicy允许namespace my-app中的pods来连接到namespace big-corp中的端口8080

## 解题思路
直接从官网复制yaml文件示例修改即可。

## 答案
```bash
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-port-from-namespace
  namespace: my-app
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: big-corp
    ports:
      - protocol: TCP
        port: 8080
```

# <font style="color:rgb(36, 43, 60);">SVC暴露应用</font>
## 参考文档
[https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/](https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/)

## 例题
重新配置现有的部署front-end以及添加名为http的端口规范来公开现有容器NGINX的端口80/tcp

创建一个名为front-end-svc的新服务，以公开容器端口http

配置此服务，以通过在排定的节点上的NodePort来公开各个Pods

## 解题思路
先修改deployment配置，新增ports信息

然后创建NodePort方式的svc资源，可参考官方文档直接复制示例文件修改即可。

## 答案
```bash
# 修改deployment配置
[root@k8s-master ~]# kubectl edit deployment front-end 
deployment.apps/front-end edited

  spec:
    containers:
    - image: nginx
      imagePullPolicy: Always
      name: nginx
      ports:
      - containerPort: 80
        name: http
        protocol: TCP
# 创建NodePort方式的svc
[root@k8s-master ~]# cat svc.yaml 
apiVersion: v1
kind: Service
metadata:
  name: front-end-svc
spec:
  type: NodePort
  selector:
    app: front-end
  ports:
    - port: 80
      targetPort: 80

[root@k8s-master ~]# kubectl apply -f svc.yaml 
service/front-end-svc created
[root@k8s-master ~]# kubectl get svc 
NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
front-end-svc   NodePort    10.104.138.67   <none>        80:32305/TCP   15s
[root@k8s-master ~]# curl 10.104.138.67
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>

# 也可以通过命令行方式直接创建资源
[root@k8s-master ~]# kubectl expose deployment front-end --port=80 --target-port=80 --type=NodePort --name=front-end-svc
```

# <font style="color:rgb(36, 43, 60);">Ingress</font>
## 参考文档
[https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/](https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/)

## 例题
创建一个NGINX ingress资源，名称：ping、namespace：default、使用服务端口80在路径/hello上公开服务front-end-svc

## 解题思路
复制官方文档示例文件，按题目要求修改指定字段值即可

## 答案
```bash
[root@k8s-master ~]# cat ingress.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ping
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - http:
      paths:
      - path: /hello
        pathType: Prefix
        backend:
          service:
            name: front-end-svc
            port:
              number: 80
[root@k8s-master ~]# kubectl apply -f ingress.yaml 
ingress.networking.k8s.io/pong created
[root@k8s-master ~]# kubectl get ingress
NAME    CLASS    HOSTS            ADDRESS   PORTS   AGE
ping    <none>   *                          80      10s

# 也可以通过命令行方式创建资源
[root@k8s-master ~]# kubectl create ingress ping --rule=/hello=hello:5678 --class=nginx --annotation=nginx.ingress.kubernetes.io/rewrite-target=/ -n ing-internal

# 可以使用以下命令检查服务 hello的可用性，该命令应返回 hello：
curl -kL <INTERNAL_IP>/hello
```

<font style="color:rgb(36, 43, 60);"></font>


