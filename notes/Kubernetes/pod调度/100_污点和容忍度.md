# 污点和容忍度
# 一、简介


1. 污点（taints）是定义在node之上的键值型属性数据，用于让节点拒绝将Pod调度运行于其上，除非该Pod对象具有接纳节点污点的容忍度。
2. 容忍度（tolerations）是定义在Pod对象上的键值型属性数据，用于配置其可容忍的节点污点，而且调度器仅能将Pod对象调度至其能够容忍该节点污点的节点之上，
3. 节点亲和性使得Pod对象被吸引到一类特定的节点，而污点则相反，它提供了让节点排斥特定Pod对象的能力

# 二、定义污点和容忍度


1. 污点定义在节点的nodeSpec中，而容忍度则定义在Pod的podSpec中，它们都是键值型数据，但又都额外支持一个效果（effect）标记，语法格式为“key=value:effect”，其中key和value的用法及格式与资源注解信息相似，effect用于定义对Pod对象的排斥等级，它主要包含以下三种类型。
+ NoSchedule： k8s 将不会将 Pod 调度到具有该污点的 Node 上。
+ PreferNoSchedule: k8s 将尽量避免将 Pod 调度到具有该污点的 Node 上。
+ NoExecute：k8s 将不会将 Pod 调度到具有该污点的 Node 上，同时会将 Node上已经存在的 Pod 驱逐出去
2. 在Pod对象上定义容忍度时，它支持两种操作符：
+ 一种是等值比较（Equal），表示容忍度与污点必须在key、value和effect三者之上完全匹配
+ 另一种是存在性判断（Exists），表示二者的key和effect必须完全匹配，而容忍度中的value字段要使用空值。
3. 一个节点可以配置使用多个污点，一个Pod对象也可以有多个容忍度，不过二者在进行匹配检查时应遵循如下逻辑。
+ 首先处理每个有着与之匹配的容忍度的污点。
+ 不能匹配到的污点上，如果存在一个污点使用了NoSchedule效用标识，则拒绝调度Pod对象至此节点。
+ 不能匹配到的污点上，若没有任何一个使用了NoSchedule效用标识，但至少有一个使用了PreferNoScheduler，则应尽量避免将Pod对象调度至此节点。
+ 如果至少有一个不匹配的污点使用了NoExecute效用标识，则节点将立即驱逐Pod对象，或者不予调度至给定节点；另外，即便容忍度可以匹配到使用了NoExecute效用标识的污点，若在定义容忍度时还同时使用tolerationSeconds属性定义了容忍时限，则超出时限后其也将被节点驱逐。
4. pod.spec.tolerations字段设置
+ key, vaule, effect 要与 Node 上设置的 taint 保持一致
+ operator 的值为 Exists 将会忽略 value 值
+ tolerationSeconds 用于描述当 Pod 需要被驱逐时可以在 Pod 上继续保留运行的时间
+ 不指定 key 值时，表示容忍所有的污点 key

tolerations:  
        - operator: "Exists"

+ 不指定 effect 值时，表示容忍所有的污点作用  
tolerations:  
- key: "key"  
operator: "Exists"
+ 有多个 Master 存在时，防止资源浪费，可以如下设置  
kubectl taint nodes Node-Name  
node-role.kubernetes.io/master=:PreferNoSchedule

# 三、污点的设置、查看和去除


1. 设置污点  
`kubectl taint nodes node1 key1=value1:NoSchedule` 
2. 节点说明中，查找 Taints 字段  
`kubectl describe node node-name` 

![](https://via.placeholder.com/800x600?text=Image+cc6aeb311fb0a987)

3. 去除污点  
kubectl taint nodes node1 key1:NoSchedule-

# 四、示例
1. 使用NoExecute：将node1已经存在的Pod对象驱逐。
+ 创建deployment资源，系统自动调度至node1和node2上

![](https://via.placeholder.com/800x600?text=Image+9d6111b2119ec386)

+ 给node1设置NoExecute污点  
`# kubectl taint node node1 status=check:NoExecute` 
+ 查看pod信息，已全部调度至node2上

![](https://via.placeholder.com/800x600?text=Image+5fefe13a84a568d7)

2. 设置容忍，容忍status=check:NoExecute的污点存在，60秒后失效
+ 配置deployment清单文件

![](https://via.placeholder.com/800x600?text=Image+8f32cf5fa36b344f)

+ 查看pod信息，此时node1和node2上均有pod

![](https://via.placeholder.com/800x600?text=Image+20212f4a9b6a50ff)

+ 60秒后查看pod信息，pod已全部调度至node2上

![](https://via.placeholder.com/800x600?text=Image+21e74c2bc1437724)


