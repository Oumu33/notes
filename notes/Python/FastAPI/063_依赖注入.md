# 依赖注入
> 在构建 Web 应用时，经常需要复用一些逻辑，比如数据库连接、登录用户验证、配置加载等。FastAPI 提供了强大的 依赖注入（Dependency Injection）机制，让你可以以优雅、声明式的方式将这些共享逻辑注入到路由函数中，从而避免重复代码，提高可维护性和可测试性。
>

# 什么是依赖注入
依赖注入（Dependency Injection，简称 DI）是一种设计模式，用来将一个组件所依赖的对象，从外部“注入”进来，而不是由它自己创建或管理依赖。好处包括：

+ 更少的重复代码；
+ 更好的测试能力（可以轻松 mock）；
+ 更清晰的职责划分；
+ 更好的解耦。

在 FastAPI 中，使用 `Depends` 实现依赖注入。

# 使用示例
## 简单示例
```python
from fastapi import FastAPI, Depends

app = FastAPI()

def is_login(username: str):
    """
    检查用户是否登录
    
    :param username: 用户名
    :return: 如果用户名为"admin"则返回True，否则返回False
    """
    if username == "admin":
        return True
    return False

@app.get("/items/")
def read_items(params: dict = Depends(is_login)):
    """
    读取项目列表接口
    
    :param params: 依赖于is_login函数的参数验证结果
    :return: 返回参数验证结果
    """
    return params
```

请求 `/items/?username=admin`时，输出：`True`

说明：

+ `is_login` 是一个依赖函数；
+ 使用 `Depends(is_login)` 表示将返回值注入到 `read_items` 中；
+ 你可以在多个路由中复用 `is_login`，达到代码复用的目的。

## 依赖嵌套
依赖也可以嵌套其他依赖，就像积木一样组合：

```python
from fastapi import FastAPI, Depends, HTTPException

app = FastAPI()

def auth_header(token: str = ""):
    """
    解析认证头信息，提取token
    
    参数:
        token (str): 认证令牌，默认为空字符串
        
    返回:
        dict: 包含token的字典
    """
    return {"token": token}

def get_user(auth=Depends(auth_header)):
    """
    根据认证信息获取用户信息，验证token有效性
    
    参数:
        auth (dict): 包含认证信息的字典，通过依赖注入获取
        
    返回:
        dict: 包含用户名的用户信息字典
        
    异常:
        HTTPException: 当token无效时抛出401未授权异常
    """
    token = auth["token"]
    # 验证token是否为预设的密钥
    if token != "secret":
        raise HTTPException(status_code=401, detail="Unauthorized")
    return {"username": "admin"}

@app.get("/profile/")
def get_profile(user=Depends(get_user)):
    """
    获取用户个人信息接口
    
    参数:
        user (dict): 用户信息，通过依赖注入获取
        
    返回:
        dict: 包含用户信息的响应数据
    """
    return {"user": user}

```

## 类作为依赖（依赖对象）
也可以将类实例注入路由：

```python
from fastapi import FastAPI, Depends

app = FastAPI()

class Pagination:
    """
    分页参数类，用于处理分页相关的参数
    
    Args:
        page (int): 页码，默认为1
        limit (int): 每页显示的数量，默认为10
    """
    def __init__(self, page: int = 1, limit: int = 10):
        self.page = page
        self.limit = limit

@app.get("/products/")
def get_products(p: Pagination = Depends()):
    """
    获取产品列表的接口，支持分页功能
    
    Args:
        p (Pagination): 分页参数对象，包含页码和每页数量信息
        
    Returns:
        dict: 包含当前页码和每页数量的字典
    """
    return {"page": p.page, "limit": p.limit}

```

FastAPI 会自动将请求参数映射到构造函数中，并实例化类。

## 带清理逻辑的依赖（生成器依赖）
如果你需要执行“进入”和“退出”操作（比如数据库连接的打开和关闭），可以使用 Python 的生成器语法：

```python
from fastapi import FastAPI, Depends
from contextlib import asynccontextmanager

app = FastAPI()


@asynccontextmanager
async def db_connection():
    """
    异步上下文管理器，用于管理数据库连接
    
    该函数模拟创建数据库连接，并在使用完毕后进行资源清理工作。
    通过yield返回数据库连接对象，确保连接能够在使用后被正确关闭。
    
    Yields:
        dict: 包含数据库连接信息的字典对象
        
    注意:
        实际使用中这里应该创建真实的数据库连接
    """
    db = {"conn": "fake-db-connection"}
    yield db
    # 清理资源，比如关闭连接
    print("数据库连接已关闭")


@app.get("/data/")
async def read_data(db=Depends(db_connection)):
    """
    处理GET请求，返回数据接口
    
    通过依赖注入获取数据库连接，返回当前使用的数据库连接信息。
    
    Args:
        db (dict): 由db_connection依赖提供的数据库连接对象，默认值通过Depends自动注入
        
    Returns:
        dict: 包含连接信息的响应数据，格式为{"conn": "连接标识符"}
    """
    return {"conn": db["conn"]}


```

FastAPI 会在请求结束后自动执行 `yield` 之后的清理逻辑。

## 依赖作用域（scope）
默认情况下，依赖函数在每个请求中都会重新执行一次。但你可以为生成器依赖设置作用域：

```python
@asynccontextmanager
async def get_cache():
    cache = {"conn": "redis"}
    yield cache

app.dependency_overrides[get_cache] = get_cache

# 指定作用域为应用生命周期
app.dependency_overrides[get_cache].__fastapi_scope__ = "app"
```

FastAPI 支持以下作用域：

| 作用域 | 描述 |
| --- | --- |
| `"function"`（默认） | 每个请求调用一次 |
| `"app"` | 在应用启动时创建，只执行一次 |


## 可选依赖
你可以让某些依赖是“可选的”：

```python
from fastapi import FastAPI, Depends
from typing import Annotated

app = FastAPI()


def get_token(token: str | None = None):
    """
    获取请求中的token参数
    
    Args:
        token (str | None): 从请求中提取的token字符串，默认为None
        
    Returns:
        str | None: 返回传入的token值或None
    """
    return token

@app.get("/public/")
def read(token: Annotated[str | None, Depends(get_token)] = None):
    """
    处理GET请求，返回token信息
    
    Args:
        token (Annotated[str | None, Depends(get_token)]): 通过依赖注入获取的token参数，默认为None
        
    Returns:
        dict: 包含token值的字典对象
    """
    return {"token": token}
```

## 依赖重写（测试用）
FastAPI 提供了 `.dependency_overrides` 机制，可以在测试时替换依赖：

```python
def fake_get_user():
    return {"username": "test"}

app.dependency_overrides[get_user] = fake_get_user
```

这样你就可以在测试中完全 mock 掉原来的权限逻辑。


