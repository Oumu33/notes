# 密钥环管理

> 来源: Ceph
> 创建时间: 2024-11-30T08:26:33+08:00
> 更新时间: 2026-01-11T09:43:40.285069+08:00
> 阅读量: 115 | 点赞: 0

---

ceph的秘钥环是一个保存了secrets、keys、certificates并且能够让客户端通过认证访问ceph的keyring file（集合文件），一个keyring file可以保存一个或多个认证，每一个key都有一个实体名称加权限，类型为`{client|mon|mds|osd}.name`。

当客户端访问ceph集群时，Ceph 客户端会使用本地的 keyring 文件。默认使用下列路径和名称的 keyring 文件：

+ /etc/ceph/<$cluster name>.<user $type>.<user $id>.keyring # 保存单个用户的keyring，如ceph.client.admin.keyring
+ /etc/ceph/cluster.keyring # 保存多个用户的keyring
+ /etc/ceph/keyring # 未定义集群名称的多个用户的keyring
+ /etc/ceph/keyring.bin # 编译后的二进制文件

也可以在 ceph.conf 中另行指定 keyring 的路径，但不推荐这样做。

## 使用keyring备份用户
使用`ceph auth add`等命令添加的用户还需要额外使用ceph-authtool命令为其创建用户秘钥环文件。  
创建keyring文件命令格式：

```bash
ceph-authtool --create-keyring FILE
```

导出用户认证信息至keyring文件

```bash
# 创建用户
root@ceph-1:~# ceph auth get-or-create client.cui mon 'allow r' osd 'allow * pool=mypool'
[client.cui]
        key = AQDeIUtnkqt1IRAAoo+8BfPwUqar5PbTP3RkRQ==
 
# 验证用户
root@ceph-1:~# ceph auth get client.cui
[client.cui]
        key = AQDeIUtnkqt1IRAAoo+8BfPwUqar5PbTP3RkRQ==
        caps mon = "allow r"
        caps osd = "allow * pool=mypool"
 
# 创建一个空的 keyring 文件，使用 --create-keyring 或 -C 选项
root@ceph-1:~# ceph-authtool --create-keyring ceph.client.cui.keyring
creating ceph.client.cui.keyring

# 查看keyring文件，为空文件
root@ceph-1:~# cat ceph.client.cui.keyring 
root@ceph-1:~# file ceph.client.cui.keyring 
ceph.client.cui.keyring: empty
 
# 导出keyring至指定文件
root@ceph-1:~# ceph auth get client.cui -o ceph.client.cui.keyring
 
# 查看指定用户的keyring文件
root@ceph-1:~# cat ceph.client.cui.keyring 
[client.cui]
        key = AQDeIUtnkqt1IRAAoo+8BfPwUqar5PbTP3RkRQ==
        caps mon = "allow r"
        caps osd = "allow * pool=mypool"
```

在创建包含单个用户的秘钥环时，通常建议使用`<ceph集群名称>.<用户类型>.<用户名>.keyring`来命名，并将其保存至/etc/ceph目录中。例如为client.cui 用户创建秘钥环，命名为`ceph.client.cui.keyring`。

## 使用keyring恢复用户
可以使用`ceph auth import -i {filename}` 指定keyring文件并导入到ceph，起到用户备份和恢复的作用。

```bash
# 查看用户认证文件
root@ceph-1:~# cat ceph.client.cui.keyring 
[client.cui]
        key = AQDeIUtnkqt1IRAAoo+8BfPwUqar5PbTP3RkRQ==
        caps mon = "allow r"
        caps osd = "allow * pool=mypool"
 
# 删除用户
root@ceph-1:~# ceph auth del client.cui

# 确认用户被删
root@ceph-1:~# ceph auth get client.cui
Error ENOENT: failed to find client.cui in keyring
 
# 导入用户
root@ceph-1:~# ceph auth import -i ceph.client.cui.keyring
 
# 查看用户已恢复
root@ceph-1:~# ceph auth get client.cui
[client.cui]
        key = AQDeIUtnkqt1IRAAoo+8BfPwUqar5PbTP3RkRQ==
        caps mon = "allow r"
        caps osd = "allow * pool=mypool"
```

## 秘钥环文件多用户
一个keyring文件中可以包含多个不同用户的认证文件。

将多用户导出至秘钥环：

```bash
# 创建空的keyring文件
root@ceph-1:~# ceph-authtool --create-keyring ceph.client.user.keyring
creating ceph.client.user.keyring
 
# 把admin用户的keyring文件内容导入到user用户的keyring文件
root@ceph-1:~# ceph-authtool ./ceph.client.user.keyring --import-keyring /etc/ceph/ceph.client.admin.keyring 
importing contents of /etc/ceph/ceph.client.admin.keyring into ./ceph.client.user.keyring
 
# 查看user用户keyring文件内容
root@ceph-1:~# ceph-authtool -l ./ceph.client.user.keyring
[client.admin]
        key = AQBii0hnHNvZFxAAzs6IHqobafeOMF4aypRH7g==
        caps mds = "allow *"
        caps mgr = "allow *"
        caps mon = "allow *"
        caps osd = "allow *"
 
# 再将cui的keyring导入到user中
root@ceph-1:~# ceph-authtool ./ceph.client.user.keyring --import-keyring ./ceph.client.cui.keyring 
importing contents of ./ceph.client.cui.keyring into ./ceph.client.user.keyring
 
# 查看user的keyring文件，包含多个用户的认证信息
cephadmin@ceph-deploy:/data/ceph-cluster$ ceph-authtool -l ./ceph.client.user.keyring 
root@ceph-1:~# ceph-authtool -l ./ceph.client.user.keyring
[client.admin]
        key = AQBii0hnHNvZFxAAzs6IHqobafeOMF4aypRH7g==
        caps mds = "allow *"
        caps mgr = "allow *"
        caps mon = "allow *"
        caps osd = "allow *"
[client.cui]
        key = AQDeIUtnkqt1IRAAoo+8BfPwUqar5PbTP3RkRQ==
        caps mon = "allow r"
        caps osd = "allow * pool=mypool"
```


