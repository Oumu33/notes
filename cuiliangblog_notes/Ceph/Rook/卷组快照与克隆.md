# 卷组快照与克隆
卷组快照是针对多个 CephFS 卷（通常是逻辑相关的卷集合）在同一时刻创建的快照。需要确保在同一时间点对所有卷的数据状态进行一致性快照操作。  

# 安装控制器和CRD 
具体参考上篇

# 使用卷组快照
## 创建卷组快照类
```yaml
# cat groupsnapshotclass.yaml             
apiVersion: groupsnapshot.storage.k8s.io/v1beta1
kind: VolumeGroupSnapshotClass
metadata:
  name: csi-cephfsplugin-groupsnapclass
driver: rook-ceph.cephfs.csi.ceph.com 
parameters:
  clusterID: rook-ceph 
  fsName: k8sfs # cephfs名称
  csi.storage.k8s.io/group-snapshotter-secret-name: rook-csi-cephfs-provisioner
  csi.storage.k8s.io/group-snapshotter-secret-namespace: rook-ceph
deletionPolicy: Delete
# kubectl apply -f groupsnapshotclass.yaml 
volumegroupsnapshotclass.groupsnapshot.storage.k8s.io/csi-cephfsplugin-groupsnapclass created
# kubectl get volumegroupsnapshotclass
NAME                              DRIVER                          DELETIONPOLICY   AGE
csi-cephfsplugin-groupsnapclass   rook-ceph.cephfs.csi.ceph.com   Delete           41s
```

## <font style="color:rgba(0, 0, 0, 0.87);">创建卷组快照</font>
注意的是卷组快照是基于 PVC 的标签选择器创建快照组，因此创建 pvc 时需要指定标签，例如

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cephfs-pvc-restore
  labels:
    app: redis
spec:
  storageClassName: ceph-fs # sc名称
  dataSource:
    name: cephfs-pvc-snapshot # 快照名称
    kind: VolumeSnapshot
    apiGroup: snapshot.storage.k8s.io
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
```

查看 pvc 资源

```bash
# kubectl get pvc -l app=redis
NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
cephfs-pvc-restore   Bound    pvc-409e52d2-1043-4e8a-916a-dcaf476db25f   20Mi       RWX            ceph-fs        <unset>                 118s
```

创建卷组快照

```yaml
# cat groupsnapshot.yaml             
apiVersion: groupsnapshot.storage.k8s.io/v1beta1
kind: VolumeGroupSnapshot
metadata:
  name: cephfs-groupsnapshot
spec:
  source:
    selector:
      matchLabels: # pvc标签
        app: redis
  volumeGroupSnapshotClassName: csi-cephfsplugin-groupsnapclass
# kubectl apply -f groupsnapshot.yaml
volumegroupsnapshot.groupsnapshot.storage.k8s.io/cephfs-groupsnapshot created
```

查看卷组快照

```bash
# kubectl get volumegroupsnapshot
NAME                     READYTOUSE   VOLUMEGROUPSNAPSHOTCLASS          VOLUMEGROUPSNAPSHOTCONTENT   CREATIONTIME   AGE
cephfs-groupsnapshot-1                csi-cephfsplugin-groupsnapclass                                               4m5s
```

