# 常见问题

> 分类: Ceph > Rook
> 更新时间: 2026-01-10T23:35:20.300260+08:00

---

# pv 删除资源后空间不释放
## 问题表现
删除 pv 挂载目录的文件后，执行 `rbd du --pool k8s-rbd`查看 pool 空间发现并未释放

## 问题原因
因为大部分的文件系统都是标记删除，没有把trim透传到后端存储。

## 解决办法
方案 1： 手动运行 `fstrim`

```bash
# 执行lsblk查询挂载点
rbd6    252:96   0     2T  0 disk /var/lib/kubelet/pods/47bdde62-b625-4b1b-a7bb-263c1ed40362/volumes/kubernetes.io~csi/pvc-62e8c30
# 手动回收
fstrim /var/lib/kubelet/pods/47bdde62-b625-4b1b-a7bb-263c1ed40362/volumes/kubernetes.io\~csi/pvc-62e8c309-19d1-481c-9439-8db542e50b2d/mount/
# 手动释放所有空间
fstrim --all -v 
```

方案 2： 添加资源注解

参考文档：[https://github.com/csi-addons/kubernetes-csi-addons/blob/main/docs/reclaimspace.md](https://github.com/csi-addons/kubernetes-csi-addons/blob/main/docs/reclaimspace.md)

方案 3：启动fstrim 服务

1. 检查是否已启用 `fstrim.timer`：

```bash
systemctl list-timers fstrim.timer
```

2. 如果未启用，启动定时器：

```plain
systemctl enable --now fstrim.timer
```

3. 查看定时任务的默认周期：

```plain
systemctl cat fstrim.timer
```

默认配置一般是每周运行一次。如果需要调整，可以自定义一个 `fstrim.timer`。

## 应急办法
如果执行fstrim 卡主，短期内无法释放资源，可以进行如下操作

```bash
# 查询images列表
rbd ls k8s-rbd --long
# 临时调整osd空间阈值
ceph osd set-full-ratio  0.96
# 删除images
rbd rm k8s-rbd/csi-vol-f2730483-f729-4ab2-9971-f2765224d30b
```

# 故障排查手册
参考文档：[https://rook.io/docs/rook/latest-release/Troubleshooting/kubectl-plugin/](https://rook.io/docs/rook/latest-release/Troubleshooting/kubectl-plugin/)

