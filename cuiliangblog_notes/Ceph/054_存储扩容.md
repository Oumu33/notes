# 存储扩容
# PVC 扩容
当 pv 的容量不足时，需要对 pv 进行扩容操作，Rook 支持对 RBD 和 CpehFS 这两种驱动通过StorageClass存储供给者为容器提供存储空间，同时具备⾃动扩容的能⼒，其流程为： 

1. 客户端通过PVC声明的⽅式向StorageClass申请扩容容量空间
2. 通过驱动调整PV的容量
3. 调整底 层的RBD镜像块容量，最终达到容量的扩展

## 查看当前 pv/pvc 信息
```bash
# kubectl get pvc                                                                                                                                                       
NAME       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE                                                                             
test-rbd   Bound    pvc-1de616a3-9dbc-47dc-95ac-a23798bd2394   10Mi       RWO            ceph-rbd                        8s                                                                              
# kubectl get pv                                                                                                                                                        
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE                                        
pvc-9b5c196b-ac44-424a-974c-ecd8b4891532   100M       RWO            Delete           Bound    helm/helm-dashboard   nfs-client                               7h8m
```

## 调整 pvc 声明空间
```yaml
# cat > pvc.yaml << EOF
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: test-rbd
spec:
  storageClassName: ceph-rbd # StorageClass名称
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi # 修改为10Gi
EOF
# kubectl apply -f pvc.yaml 
persistentvolumeclaim/test-rbd configured
```

## 查看验证
查看 pv、pvc 资源信息

```bash
# kubectl get pv           
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
pvc-1de616a3-9dbc-47dc-95ac-a23798bd2394   10Gi       RWO            Delete           Bound    default/test-rbd      ceph-rbd       <unset>                          3m7s
pvc-9b5c196b-ac44-424a-974c-ecd8b4891532   100M       RWO            Delete           Bound    helm/helm-dashboard   nfs-client     <unset>                          7h11m
# kubectl get pvc   
NAME       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
test-rbd   Bound    pvc-1de616a3-9dbc-47dc-95ac-a23798bd2394   10Mi       RWO            ceph-rbd       <unset>                 3m11s
```

查看 RBD 块信息

```bash
# kubectl exec -it -n rook-ceph rook-ceph-tools-699dcdd8bb-d99mp -- bash
bash-5.1$ rbd ls --pool k8s-rbd -l
NAME                                          SIZE    PARENT  FMT  PROT  LOCK
csi-vol-5a70db6c-68ba-4be1-86c9-6d1773a2d75f  10 GiB            2            
bash-5.1$ rbd -p k8s-rbd info csi-vol-5a70db6c-68ba-4be1-86c9-6d1773a2d75f
rbd image 'csi-vol-5a70db6c-68ba-4be1-86c9-6d1773a2d75f':
        size 10 GiB in 2560 objects
        order 22 (4 MiB objects)
        snapshot_count: 0
        id: c7a0411a3fe1
        block_name_prefix: rbd_data.c7a0411a3fe1
        format: 2
        features: layering
        op_features: 
        flags: 
        create_timestamp: Thu Dec 26 11:10:43 2024
        access_timestamp: Thu Dec 26 11:10:43 2024
        modify_timestamp: Thu Dec 26 11:10:43 2024
```

# RBD 块扩容
除了使用 pvc 扩容外，也可以直接操作 rbd 镜像完成扩容操作。

## 扩容 RBD 镜像
```bash
# kubectl exec -it -n rook-ceph rook-ceph-tools-699dcdd8bb-d99mp -- bash
bash-5.1$ rbd -p k8s-rbd resize csi-vol-5a70db6c-68ba-4be1-86c9-6d1773a2d75f --size 20G
Resizing image: 100% complete...done.
bash-5.1$ rbd -p k8s-rbd info csi-vol-5a70db6c-68ba-4be1-86c9-6d1773a2d75f
rbd image 'csi-vol-5a70db6c-68ba-4be1-86c9-6d1773a2d75f':
        size 20 GiB in 5120 objects
        order 22 (4 MiB objects)
        snapshot_count: 0
        id: c7a0411a3fe1
        block_name_prefix: rbd_data.c7a0411a3fe1
        format: 2
        features: layering
        op_features: 
        flags: 
        create_timestamp: Thu Dec 26 11:10:43 2024
        access_timestamp: Thu Dec 26 11:10:43 2024
        modify_timestamp: Thu Dec 26 11:10:43 2024
```

## 扩容宿主机文件系统
查询 pod 所在宿主机信息

```bash
# kubectl get pod -o wide
NAME                     READY   STATUS    RESTARTS       AGE     IP             NODE    NOMINATED NODE   READINESS GATES
redis                    1/1     Running   0              8m35s   10.244.4.117   work2   <none>           <none>
```

登录宿主机，扩容文件系统

```bash
[root@work2 ~]# rbd device list
id  pool     namespace  image                                         snap  device   
0   k8s-rbd             csi-vol-5a70db6c-68ba-4be1-86c9-6d1773a2d75f  -     /dev/rbd0
[root@work2 ~]# resize2fs /dev/rbd0 
resize2fs 1.45.6 (20-Mar-2020)
/dev/rbd0 上的文件系统已被挂载于 /var/lib/kubelet/plugins/kubernetes.io/csi/rook-ceph.rbd.csi.ceph.com/0d84243b08c52eaebb8ffc6443fa8953e158e0dd546bcc36fd348fdd8f2b67e9/globalmount/0001-0009-rook-ceph-0000000000000002-5a70db6c-68ba-4be1-86c9-6d1773a2d75f；需要进行在线调整大小

old_desc_blocks = 80, new_desc_blocks = 160
/dev/rbd0 上的文件系统现在为 20971520 个块（每块 1k）。
```

## 查看验证
查看 pod 存储空间

```bash
# kubectl exec -it redis -- bash
root@redis:/data# df -h
Filesystem           Size  Used Avail Use% Mounted on
overlay               47G   12G   36G  24% /
tmpfs                 64M     0   64M   0% /dev
tmpfs                7.7G     0  7.7G   0% /sys/fs/cgroup
/dev/rbd0             20G   14K   20G   1% /data # 已经扩容到20G
/dev/mapper/rl-root   47G   12G   36G  24% /etc/hosts
shm                   64M     0   64M   0% /dev/shm
tmpfs                128M   12K  128M   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs                7.7G     0  7.7G   0% /proc/acpi
tmpfs                7.7G     0  7.7G   0% /proc/scsi
tmpfs                7.7G     0  7.7G   0% /sys/firmware
```

查看 pv、pvc 信息，还是显示原来的 10G

```bash
# kubectl get pv                
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
pvc-1de616a3-9dbc-47dc-95ac-a23798bd2394   10Gi       RWO            Delete           Bound    default/test-rbd      ceph-rbd       <unset>                          21m
# kubectl get pvc
NAME       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
test-rbd   Bound    pvc-1de616a3-9dbc-47dc-95ac-a23798bd2394   10Gi       RWO            ceph-rbd       <unset>                 21m
```


