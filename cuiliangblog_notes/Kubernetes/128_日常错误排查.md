# 日常错误排查
## 状态查看
### 查看 Pod 状态以及运行节点
kubectl get pods -o wide

kubectl -n kube-system get pods -o wide

### 查看 Pod 事件
kubectl describe pod <pod-name>

### 查看 Node 状态
kubectl get nodes

kubectl describe node <node-name>



## 日志查看
### kube-apiserver 日志
PODNAME=$(kubectl -n kube-system get pod -l component=kube-apiserver -o

jsonpath='{.items[0].metadata.name}')

kubectl -n kube-system logs $PODNAME --tail 100

+ 以上命令操作假设控制平面以 Kubernetes 静态 Pod 的形式来运行。如果  
kube-apiserver 是用 systemd 管理的，则需要登录到 master 节点上，然后使用  
journalctl -u kube-apiserver 查看其日志。

### kube-controller-manager 日志
PODNAME=$(kubectl -n kube-system get pod -l

component=kube-controller-manager -o jsonpath='{.items[0].metadata.name}')

kubectl -n kube-system logs $PODNAME --tail 100

+ 以上命令操作假设控制平面以 Kubernetes 静态 Pod 的形式来运行。如果  
kube-controller-manager 是用 systemd 管理的，则需要登录到 master  
节点上，然后使用 journalctl -u kube-controller-manager 查看其日志。

### kube-scheduler 日志
PODNAME=$(kubectl -n kube-system get pod -l component=kube-scheduler -o

jsonpath='{.items[0].metadata.name}')

kubectl -n kube-system logs $PODNAME --tail 100

+ 以上命令操作假设控制平面以 Kubernetes 静态 Pod 的形式来运行。如果  
kube-scheduler 是用 systemd 管理的，则需要登录到 master 节点上，然后使用  
journalctl -u kube-scheduler 查看其日志。

### kube-dns 日志
kube-dns 通常以 Addon 的方式部署，每个 Pod 包含三个容器，最关键的是 kubedns

容器的日志：

PODNAME=$(kubectl -n kube-system get pod -l k8s-app=kube-dns -o

jsonpath='{.items[0].metadata.name}')

kubectl -n kube-system logs $PODNAME -c kubedns

### Kubelet 日志
Kubelet 通常以 systemd 管理。查看 Kubelet 日志需要首先 SSH 登录到 Node

上，推荐使用 kubectl-node-shell而不是为每个节点分配公网 IP 地址。比如：··

```bash
[root@localhost ~]# cat kubectl-node_shell
#!/bin/sh
if [ -z "$1" ]; then
  echo "Please specify node name"
  exit 1
fi

NODE="$1"
IMAGE="alpine"
POD="nsenter-$(env LC_CTYPE=C tr -dc a-z0-9 < /dev/urandom | head -c 6)"
NAMESPACE=""

# Check the node
kubectl get node "$NODE" >/dev/null || exit 1

OVERRIDES="$(cat <<EOT
{
  "spec": {
    "nodeName": "$NODE",
    "hostPID": true,
    "containers": [
      {
        "securityContext": {
          "privileged": true
        },
        "image": "$IMAGE",
        "name": "nsenter",
        "stdin": true,
        "stdinOnce": true,
        "tty": true,
        "command": [ "nsenter", "--target", "1", "--mount", "--uts", "--ipc", "--net", "--pid", "--", "bash", "-l" ]
      }
    ]
  }
}
EOT
)"

echo "spawning \"$POD\" on \"$NODE\""
kubectl run --namespace "$NAMESPACE" --rm --image alpine --overrides="$OVERRIDES" --generator=run-pod/v1 -ti "$POD"
chmod +x ./kubectl-node_shell
sudo mv ./kubectl-node-shell /usr/local/bin/kubectl-node_shell
[root@localhost ~]# ./kubectl-node_shell localhost.localdomain
spawning "nsenter-i71opm" on "localhost.localdomain"
If you don't see a command prompt, try pressing enter.
[root@localhost /]# journalctl -l -u kubelet
```

### Kube-proxy 日志
Kube-proxy 通常以 DaemonSet 的方式部署，可以直接用 kubectl 查询其日志

$ kubectl -n kube-system get pod -l component=kube-proxy

NAME READY STATUS RESTARTS AGE

kube-proxy-42zpn 1/1 Running 0 1d

kube-proxy-7gd4p 1/1 Running 0 3d

kube-proxy-87dbs 1/1 Running 0 4d

$ kubectl -n kube-system logs kube-proxy-42zpn

### pod 异常退出日志查看
### 命令格式：
```plain
kubectl logs <pod-name> --previous -n <namespace>
```

+ `--previous`：表示查看 **上一个容器实例（崩溃前）** 的日志
+ `-n`：指定命名空间（如果不是 default）
+  如果 Pod 包含多个容器（如 sidecar），还需加上 `-c <container-name>` 参数。  


