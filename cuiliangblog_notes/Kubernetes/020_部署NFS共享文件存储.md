# 部署NFS共享文件存储

> 来源: Kubernetes
> 创建时间: 2023-02-28T18:48:29+08:00
> 更新时间: 2026-01-11T09:04:21.194543+08:00
> 阅读量: 3045 | 点赞: 0

---

# 环境规划
| 主机名 | ip | 角色 |
| --- | --- | --- |
| tiaoban | 192.168.10.100 | nfs存储服务器 |
| k8s-master | 192.168.10.10    | nfs客户端 |
| k8s-work1 | 192.168.10.11    | nfs客户端 |
| k8s-work2 | 192.168.10.12   | nfs客户端 |


# 部署nfs服务(nfs存储服务器)
```bash
# 安装nfs服务
[root@tiaoban ~]# dnf install -y nfs-utils
# 创建目录授权
[root@tiaoban ~]# mkdir -p /data/nfs
[root@tiaoban ~]# chmod 666 /data/nfs
[root@tiaoban ~]# chown nobody /data/nfs
# 导出文件系统
[root@tiaoban ~]# cat > /etc/exports << EOF
/data/nfs *(rw,sync,insecure,no_subtree_check,no_root_squash)
EOF
# 启动服务
[root@tiaoban ~]# systemctl start nfs-server
[root@tiaoban ~]# systemctl enable nfs-server
# 查看验证
[root@tiaoban ~]# exportfs -rv
exporting *:/data/nfs
```

> <font style="color:rgb(106, 115, 125);">/data/nfs *(rw,sync,insecure,no_subtree_check,no_root_squash)说明：</font>
>
> + <font style="color:rgb(106, 115, 125);">/data/nfs： nfs server 目录</font>
> + <font style="color:rgba(0, 0, 0, 0.8);background-color:rgb(247, 247, 249);">*</font><font style="color:rgb(106, 115, 125);"> </font><font style="color:rgb(106, 115, 125);">： 表示所有的服务器都可以挂载该nfs，当然也可以指定ip地址/ip地址段</font>
> + <font style="color:rgb(106, 115, 125);">rw： 读写权限</font>
> + <font style="color:rgb(106, 115, 125);">sync：同步写入,即数据写入服务器后再返回响应，保证数据的可靠性和一致性</font>
> + <font style="color:rgb(106, 115, 125);">insecure： 表示不进行端口校验，允许客户端使用非保留端口进行连接</font>
> + <font style="color:rgb(106, 115, 125);">no_subtree_check: 禁止子树检查</font>
> + <font style="color:rgb(106, 115, 125);">no_root_squash: 表示禁用 root 用户映射机制，即来自客户端的 root 用户被映射为匿名用户而没有特权</font>
>

# 客户端测试(nfs客户端)
```bash
# 安装软件包
dnf install -y nfs-utils
# debian系统
apt install nfs-common
# 测试挂载
showmount -e 192.168.10.100
mount -t nfs 192.168.10.100:/data/nfs /mnt
```

# **<font style="color:rgb(77, 77, 77);">External NFS部署(ks8 master)</font>**
项目地址：[https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner](https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner)

```bash
[root@k8s-master ~]# helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/
[root@k8s-master ~]# kubectl create ns nfs
namespace/nfs created
[root@k8s-master ~]# helm install nfs nfs-subdir-external-provisioner/nfs-subdir-external-provisioner -n nfs --set nfs.server=192.168.10.100 --set nfs.path=/data/nfs
[root@k8s-master ~]# helm list -n nfs
NAME                            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                                   APP VERSION
nfs-subdir-external-provisioner default         1               2023-02-28 15:13:39.802073981 +0800 CST deployed        nfs-subdir-external-provisioner-4.0.17  4.0.2      
[root@k8s-master ~]# kubectl get pod -n nfs
NAME                                               READY   STATUS    RESTARTS   AGE
nfs-subdir-external-provisioner-6897c6dc4f-czrgp   1/1     Running   0          6s
```

配置 nfs 为默认存储（可选）

```bash
# kubectl patch storageclass nfs-client -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
# kubectl get sc  
NAME                   PROVISIONER                                         RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
nfs-client (default)   cluster.local/nfs-nfs-subdir-external-provisioner   Delete          Immediate              true                   113s
```

# 使用测试
创建pvc资源清单

```yaml
[root@k8s-master nfs]# cat > pvc.yaml << EOF
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: test-pvc
spec:
  storageClassName: nfs-client
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Mi
EOF
[root@k8s-master nfs]# kubectl apply -f pvc.yaml 
persistentvolumeclaim/test-pvc created
[root@k8s-master nfs]# kubectl get pvc
NAME       STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
test-pvc   Bound    pvc-57524310-76f0-400e-8095-9ee9ae504d5b   10Mi       RWX            nfs-client     5s
[root@k8s-master nfs]# kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM              STORAGECLASS   REASON   AGE
pvc-57524310-76f0-400e-8095-9ee9ae504d5b   10Mi       RWX            Delete           Bound    default/test-pvc   nfs-client              10s
```

创建pod使用pvc

```yaml
[root@k8s-master nfs]# cat > pod.yaml << EOF 
apiVersion: v1
kind: Pod
metadata:
  name: redis
  labels:
    name: redis
spec:
  containers:
  - name: redis
    image: redis:latest
    resources:
      limits:
        memory: "128Mi"
        cpu: "500m"
    ports:
      - containerPort: 6379
    volumeMounts:
      - name: redis-data
        mountPath: "/data"
  volumes:
    - name: redis-data
      persistentVolumeClaim:
        claimName: test-pvc
EOF
[root@k8s-master nfs]# kubectl apply -f pod.yaml 
pod/redis created
[root@k8s-master nfs]# kubectl get pod
NAME                                               READY   STATUS    RESTARTS   AGE
nfs-subdir-external-provisioner-6897c6dc4f-czrgp   1/1     Running   0          21m
redis                                              1/1     Running   0          2m37s
```

进入pod添加数据

```yaml
[root@k8s-master nfs]# kubectl exec -it redis -- redis-cli
127.0.0.1:6379> set key hello
OK
127.0.0.1:6379> get key
"hello"
127.0.0.1:6379> exit
```

重启pod，测试数据

```yaml
[root@k8s-master nfs]# kubectl delete pod redis 
pod "redis" deleted
[root@k8s-master nfs]# kubectl apply -f pod.yaml 
pod/redis created
[root@k8s-master nfs]# kubectl exec -it redis -- redis-cli
127.0.0.1:6379> get key
"hello"
127.0.0.1:6379> exit
```


