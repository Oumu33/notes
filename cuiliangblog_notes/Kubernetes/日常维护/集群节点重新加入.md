# 集群节点重新加入
# 删除节点
使用适当的凭证与控制平面节点通信，请运行：

```bash
kubectl drain <node name> --delete-local-data --force --ignore-daemonsets
kubectl delete node <node name>
```

然后，在要删除的节点上，重置所有kubeadm安装状态：

```bash
kubeadm reset
```

重置过程不会重置或清除iptables规则或IPVS表。如果您希望重置iptables，则必须手动进行：

```bash
iptables -F && iptables -t nat -F && iptables -t mangle -F && iptables -X
```

如果要重置IPVS表，则必须运行以下命令：

```bash
ipvsadm -C
```

删除CNI虚拟网卡

```bash
# 停止 kubelet
systemctl stop kubelet

# 删除旧的 cni 配置和缓存
rm -rf /var/lib/cni/*
rm -rf /var/run/flannel/subnet.env
rm -rf /etc/cni/net.d/*

# 删除旧的网桥
ip link delete cni0
ip link delete flannel.1

# 重启 kubelet
systemctl start kubelet
```

# 删除 etcd 节点数据
如果删除的是 master 节点，需要删除对应的 etcd 数据

## 安装etcdctl命令
```bash
yum install etcd-client
```

## 查看故障的etcd节点
```bash
# kubectl -n kube-system get pods | grep etcd
k8s-01       1/1     Running              1(28d ago)       28d
k8s-02       1/1     Running              45(3d1h ago)     3d1h
k8s-03       0/1     CrashLoopBackOff     56(5m ago)       28d
# ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  member list
3a108be8240a547f, started, k8s-01, https://10.119.202.210:2380, https://10.119.202.210:2379
6ca42f45cbab9443, started, k8s-02, https://10.119.202.212:2380, https://10.119.202.212:2379
a458ec508b0c8ef6, started, k8s-03, https://10.119.202.211:2380, https://10.119.202.211:2379
```

## 根据节点ID删除掉etcd节点
```bash
# ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  member remove a458ec508b0c8ef6
```

# 重新加入
在 master 节点执行命令既可。

## worker 节点加入命令
```bash
kubeadm token create --print-join-command
```

## master 节点加入命令
生成 token

```bash
root@miaohua-e-m-211:~# kubeadm token create
9dzunz.t4z37gqdtbasv5zv
```

生成discovery-token

```bash
root@miaohua-e-m-211:~# openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | \
openssl rsa -pubin -outform der 2>/dev/null | \
openssl dgst -sha256 -hex | awk '{print "sha256:" $2}'
sha256:ca9a00b6444541d874dc240b33c725dac2f25cfbc2106c6a6003b02c415aade5
```

生成certificate-key

```bash
kubeadm init phase upload-certs --upload-certs
I1101 11:21:36.744475 2722352 version.go:256] remote version is much newer: v1.31.2; falling back to: stable-1.30
[upload-certs] Storing the certificates in Secret "kubeadm-certs" in the "kube-system" Namespace
[upload-certs] Using certificate key:
95ac8dfff54d5bbb4b95d1e10843c5d7756c51903603db9f8c1cde48c0115323
```

组合成加入命令

```bash
kubeadm join <master-ip>:6443 --token <token> \
    --discovery-token-ca-cert-hash sha256:<discovery-token-ca-cert-hash> \
    --control-plane --certificate-key <certificate-key>

kubeadm join 10.119.202.201:9443 --token 9dzunz.t4z37gqdtbasv5zv \
    --discovery-token-ca-cert-hash sha256:ca9a00b6444541d874dc240b33c725dac2f25cfbc2106c6a6003b02c415aade5 \
    --control-plane --certificate-key 95ac8dfff54d5bbb4b95d1e10843c5d7756c51903603db9f8c1cde48c0115323
```

