# Job控制器
# 一、简介


1. Job控制器用于调配Pod对象运行一次性任务，容器中的进程在正常运行结束后不会对其进行重启，而是将Pod对象置于“Completed”（完成）状态。若容器中的进程因错误而终止，则需要依配置确定重启与否，未运行完成的Pod对象因其所在的节点故障而意外终止后会被重新调度。
2. 有的作业任务可能需要运行不止一次，用户可以配置它们以串行或并行的方式运行。
+ 单工作队列（work queue）的串行式Job：即以多个一次性的作业方式串行执行多次作业，直至满足期望的次数；这次Job也可以理解为并行度为1的作业执行方式，在某个时刻仅存在一个Pod资源对象。

![](https://via.placeholder.com/800x600?text=Image+b861a733cf2cba0d)

+ 多工作队列的并行式Job：这种方式可以设置工作队列数，即作业数，每个队列仅负责运行一个作业；也可以用有限的工作队列运行较多的作业，即工作队列数少于总作业数，相当于运行多个串行作业队列。工作队列数即为同时可运行的Pod资源数。

![](https://via.placeholder.com/800x600?text=Image+704d65aa7fbf29ec)



# 二、创建Job对象


1. Job控制器的spec字段内嵌的必要字段仅为template，它的使用方式与Deployment等控制器并无不同。Job会为其Pod对象自动添加“job-name=JOB_NAME”和“controller-uid=UID”标签，并使用标签选择器完成对controller-uid标签的关联。需要注意的是，Job位于API群组“batch/v1”之内。
2. 定义了一个Job控制器：

![](https://via.placeholder.com/800x600?text=Image+f521cd6cb34a0404)

+ Pod模板中的spec.restartPolicy默认为“Always”，这对Job控制器来说并不适用，因此必须在Pod模板中显式设定restartPolicy属性的值为“Never”或“OnFailure”
3. 创建资源  
`$ kubectl apply -f job-example.yaml` 
4. 查看资源信息  
![](https://via.placeholder.com/800x600?text=Image+e440606c4ad8efb4)  
![](https://via.placeholder.com/800x600?text=Image+62ecb560a6b80218)
+ 两分钟后，待sleep命令执行完成并成功退出后，Pod资源即转换为Completed状态，completions也从0/1变为1/1

# 三、并行式Job


1. spec.parallelism的值设置为1，并设置总任务数．spec.completion属性便能够让Job控制器以串行方式运行多任务。
2. 串行运行5次任务的Job控制器示例：

![](https://via.placeholder.com/800x600?text=Image+cb6f4ab1efa15e7f)

3. 使用kubectl get pod -w监控其变动

# 四、Job扩容


1. Job控制器的.spec.parallelism定义的并行度表示同时运行的Pod对象数，此属性值支持运行时调整从而改变其队列总数，实现扩容和缩容。
2. 例如在其运行过程中（未完成之前）将job-multi的并行度扩展为三路：  
`$ kubectl scale jobs job-multi --replicas=3` 
3. 执行命令后可以看到，其同时运行的Pod对象副本数量立即扩展到了三个：  
`$ kubectl get pods -l job-name=job-multi` 

# 五、删除Job
1. Job控制器待其Pod资源运行完成后，将不再占用系统资源。用户可按需保留或使用资源删除命令将其删除。不过，如果某Job控制器的容器应用总是无法正常结束运行，而其restartPolicy又定为了重启，则它可能会一直处于不停地重启和错误的循环当中。所幸的是，Job控制器提供了两个属性用于抑制这种情况的发生，具体如下。
+ spec.activeDeadlineSeconds <integer>:Job的deadline，用于为其指定最大活动时间长度，超出此时长的作业将被终止。
+ spec.backoffLimit <integer>：将作业标记为失败状态之前的重试次数，默认值为6。
2. 例如，下面的配置片断表示其失败重试的次数为5，并且如果超出100秒的时间仍未运行完成，那么其将被终止：

```yaml
spec:
	backoffLimit: 5
	activeDeadlineSeconds: 100
```




