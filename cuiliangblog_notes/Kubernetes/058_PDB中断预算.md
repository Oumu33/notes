# PDB中断预算
# 一、简介
1. 控制器无法保证在某一时刻一定会存在指定数量或比例的Pod对象，然而这种需求在某些强调服务可用性的场景中却是必备的。Pod中断预算（PodDisruptionBudget，简称PDB）类型的资源，用于为那些自愿的（Voluntary）中断做好预算方案（Budget），限制可自愿中断的最大Pod副本数或确保最少可用的Pod副本数，以确保服务的高可用性。
2. 部署在Kubernetes的每个应用程序都可以创建一个对应的PDB对象以限制自愿中断时最大可以中断的副本数或者最少应该保持可用的副本数，从而保证应用自身的高可用性。
+ 非自愿中断是指那些由不可控外界因素导致的Pod中断退出操作，例如，硬件或系统内核故障、网络故障以及节点资源不足导致Pod对象被驱逐等；
+ 由用户特地执行的管理操作导致的Pod中断则称为“自愿中断”，例如排空节点、人为删除Pod对象、由更新操作触发的Pod对象重建等。
3. 最常见的要保护的对象是是以下kubernetes内置的controller创建的应用对象之一:
+ Deployment
+ ReplicaSet
+ ReplicaSet
+ StatefulSet
4. 定义PDB资源时，其spec字段主要嵌套使用以下三个字段。

| .spec.selector | Object | 当前PDB对象使用的标签选择器，一般是与相关的Pod控制器使用同一个选择器。 |
| --- | --- | --- |
| .spec.minAvailable | string | Pod自愿中断的场景中，至少要保证可用的Pod对象数量或比例，要阻止任何Pod对象发生自愿中断，可将其设置为100% |
| .spec.maxUnavailable | string | Pod自愿中断的场景中，最多可转换为不可用状态的Pod对象数量或比例，0值意味着不允许Pod对象进行自愿中断；此字段与minAvailable互斥 |




2. 应用场景

| 场景 | 关注点 | 解决方案 |
| --- | --- | --- |
| 无状态的前端 | 服务能力不能减少超过10% | 使用一个包含minAvailable 90%值的PDB |
| 单实例有状态应用 | 不要在不知情情况下中断 | 1:不使用PDB,容易偶尔的宕机 2:使用PDB,设置maxUnavailable=0.当集群管理员想要终止pod的时候,他需要联系你,然后删除掉PDB以准备应对中断,然后重新创建.(如果maxUnavailable=0则不能进行自愿中断操作) |
| 多实例有状态应用 | 运行的实例数不能低于法定数量 | 1:把maxUnavailable to 1(根据不同集群要求不同,可以设置为不同的值) 2:把minAvailable设置为法定数量. |




# 二、示例


1. 由Deployment控制器myapp-deploy创建的Pod对象

![](https://via.placeholder.com/800x600?text=Image+55d24dcd22350334)

2. 设置Pod中断预算，要求其最少可用的Pod对象数量为2个

![](https://via.placeholder.com/800x600?text=Image+cc1e13e55e46a4fa)

+ PDB的app与pod中的app信息一致
3. 创建PDB对象  
`$ kubectl apply -f pdb.yaml` 
4. 查看PDB的状态

![](https://via.placeholder.com/800x600?text=Image+c059fe9dc3bca780)


