# 工作负载和调度
# <font style="color:rgb(36, 43, 60);">扩容Pod数量</font>
## 参考文档
[https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/#scaling-a-deployment](https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/#scaling-a-deployment)

## 例题
将deployment资源loadbalancer的pod数扩展至3pods

## 解题思路
可以直接edit修改deployment资源，将replicas副本数改为3

或者通过kubectl scale命令修改副本数

## 答案
```bash
[root@k8s-master ~]# kubectl scale deployment loadbalancer --replicas=3
[root@k8s-master ~]# kubectl get deployments.apps 
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
loadbalancer   3/3     3            1           46h
```

# <font style="color:rgb(36, 43, 60);">节点选择调度</font>
## 参考文档
[https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/assign-pods-nodes/](https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/assign-pods-nodes/)

## 例题
按如下要求调度一个pod：

名称：nginx-kusc

images：nginx

node selector：disktype=ssd

## 解题思路
直接复制官方文档示例，按题目要求修改名称即可

## 答案
```bash
[root@k8s-master ~]# cat pod.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: nginx-kusc
spec:
  containers:
  - name: nginx
    image: nginx
  nodeSelector:
    disktype: ssd
[root@k8s-master ~]# kubectl apply -f pod.yaml 
pod/nginx-kusc created

# 验证
[root@k8s-master ~]# kubectl get pod -o wide | grep nginx-kusc
nginx-kusc                      1/1     Running   0             18s     10.244.1.53   k8s-work1   <none>           <none>
[root@k8s-master ~]# kubectl get node --show-labels | grep ssd
k8s-work1    Ready    <none>          10d   v1.24.13   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disktype=ssd,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-work1,kubernetes.io/os=linux
```

# <font style="color:rgb(36, 43, 60);">pod配置多容器</font>
## 参考文档
[https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/](https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/)

## 例题
创建一个名为kucc4的pod，在pod里面分别为以下每个images单独运行一个app container(nginx+redis+memcached)

## 解题思路
一个pod可以包含多个container，复制官方文档yaml文件，新增container配置即可。

## 答案
```bash
[root@k8s-master ~]# cat pod.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: kucc4
spec:
  containers:
  - name: nginx
    image: nginx
  - name: redis 
    image: redis 
  - name: memcached
    image: memcached
[root@k8s-master ~]# kubectl apply -f pod.yaml 
pod/kucc4 created
# 验证，ready是3/3说明正确
[root@k8s-master ~]# kubectl get pod 
NAME                         READY   STATUS              RESTARTS      AGE
kucc4                        3/3     Running             0             12s
```

<font style="color:rgb(36, 43, 60);"> </font>

# <font style="color:rgb(36, 43, 60);">pod增加sidecar容器</font>
## 参考文档
[https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/logging/](https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/logging/)

## 例题
使用busybox images来将名为sidecar的sidecar容器添加到现有的pod legacy-app中，新的siddecar容器必须运行以下命令`/bin/sh -c tail -n+1 -F /var/log/legacy-app.log`

使用安装在/var/log的volume，使日志文件legacy-app.log可用于sidecar容器

## 解题思路
修改内容较多，且pod不能直接edit，可以先导出yaml文件，修改完成后再执行apply操作

## 答案
```bash
1. 导出yaml文件
[root@k8s-master ~]# kubectl get pod legacy-app -o yaml > varlog.yaml

2. 备份yaml文件防止改错
[root@k8s-master ~]# cp varlog.yaml varlog-bak.yaml

3. 修改配置文件
apiVersion: v1
kind: Pod
metadata:
  name: legacy-app
spec:
  containers:
  - name: count
    image: busybox
    args:
      - /bin/sh 
      - -c 
      - > 
        i=0; 
        while true; 
        do 
          echo "$i: $(date)" >> /var/log/legacy-app.log; 
          sleep 1; 
        done 
    volumeMounts: 
    - name: varlog 
      mountPath: /var/log 
  - name: sidecar 
    image: busybox 
    args: [/bin/sh, -c, 'tail -n+1 -F /var/log/legacy-app.log'] 
    volumeMounts: 
    - name: varlog 
      mountPath: /var/log 
  volumes: 
  - name: varlog 
    emptyDir: {} 
4. 删除原有pod
kubectl delete pod legacy-app

5. 创建新的pod
kubectl apply -f varlog.yaml

6. 验证结果
kubectl logs legacy-app -c sidecar
0: Sun May 21 12:11:41 UTC 2023
0: Sun May 21 12:11:42 UTC 2023
0: Sun May 21 12:11:43 UTC 2023
0: Sun May 21 12:11:45 UTC 2023
0: Sun May 21 12:11:46 UTC 2023
```



