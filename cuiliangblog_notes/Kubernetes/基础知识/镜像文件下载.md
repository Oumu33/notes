# 镜像文件下载
k8s.gcr.io 长期被墙，导致 k8s 的镜像经常无法获取。可以通过以下方式解决，建议首选代理软件，次选第三方加速镜像站

# 使用阿里镜像服务加速
1. github创建仓库，新建Dockerfile文件，内容为FROM 镜像名称

![](../../images/img_2261.png)

2. 登陆阿里云的容器镜像服务然后点击创建镜像仓库

![](../../images/img_2262.png)

3. 代码源绑定github账号

![](../../images/img_2263.png)

4. 构建——添加规则

![](../../images/img_2264.png)

5. 根据提示使用镜像

![](../../images/img_2265.png)

6. pull镜像，修改tag  
`docker tag registry.cn-hangzhou.aliyuncs.com/cuiliang_images/cuiliang_images:1 k8s.gcr.io/metrics-server-amd64:v0.3.6` 
7. 导出镜像  
`docker save -o metrics-server.tar k8s.gcr.io/metrics-server-amd64:v0.3.6` 
8. 导入镜像  
`docker load -i metrics-server.tar` 

# 使用代理软件下载镜像
## docker 配置代理地址
创建 dockerd 相关的 systemd 目录，这个目录下的配置将覆盖 dockerd 的默认配置

```bash
mkdir -p /etc/systemd/system/docker.service.d
```

新建配置文件 /etc/systemd/system/docker.service.d/http-proxy.conf，这个文件中将包含环境变量

```plain
[Service]
Environment="HTTP_PROXY=proxy.example.com:80"
Environment="HTTPS_PROXY=proxy.example.com:443"
```

如果你自己建了私有的镜像仓库，需要 dockerd 绕过代理服务器直连，那么配置 NO_PROXY 变量：

```plain
[Service]
Environment="HTTP_PROXY=http://192.168.1.100:7890"
Environment="HTTPS_PROXY=http://192.168.1.100:7890"
Environment="NO_PROXY=hub-mirror.c.163.com,mirror.ccs.tencentyun.com,harbor.local.com,harbor.cuiliangblog.cn"
```

多个 NO_PROXY 变量的值用逗号分隔，而且可以使用通配符（*），极端情况下，如果 NO_PROXY=*，那么所有请求都将不通过代理服务器。

重新加载配置文件，重启 dockerd

```ruby
systemctl daemon-reload
systemctl restart docker
```

检查确认环境变量已经正确配置：

```ruby
systemctl show --property=Environment docker
```

这样配置后，应该可以正常拉取 docker 镜像。

## containerd 配置代理地址
编辑 `containerd` 的 systemd 服务配置

```bash
# mkdir -p /etc/systemd/system/containerd.service.d
# vim /etc/systemd/system/containerd.service.d/http-proxy.conf
```

添加以下内容（根据你的代理地址调整）

```plain
[Service]
Environment="HTTP_PROXY=http://192.168.8.10:7890"
Environment="HTTPS_PROXY=http://192.168.8.10:7890"
Environment="NO_PROXY=hub-mirror.c.163.com,mirror.ccs.tencentyun.com,harbor.local.com,harbor.cuiliangblog.cn"
```

重新加载并重启服务

```bash
systemctl daemon-reload
systemctl restart containerd
systemctl show containerd --property=Environment
```

可以通过 `ctr` 命令测试拉取镜像：

```bash
crictl pull docker.io/library/nginx:alpine
```

如果配置正确，镜像应能正常拉取。

## 下载导入镜像
```bash
# 在科学工具环境下，下载镜像
docker pull registry.k8s.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2
# 导出镜像
docker save -o nfs.tar registry.k8s.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2 

# k8s节点导入镜像
nerdctl -n k8s.io load -i nfs.tar
```

# 使用coding海外节点拉取镜像
具体操作参考文档：[https://www.cuiliangblog.cn/detail/article/16](https://www.cuiliangblog.cn/detail/article/16)

# 使用第三方加速镜像站
貔貅镜像站：[https://hub.pixiuio.com/](https://hub.pixiuio.com/)

渡渡鸟镜像站：[https://docker.aityp.com/](https://docker.aityp.com/)

AWS 镜像站：[https://gallery.ecr.aws/](https://gallery.ecr.aws/)

quay 镜像站：[https://quay.io/](https://quay.io/)

