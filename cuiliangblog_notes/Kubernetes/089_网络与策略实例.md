# 网络与策略实例
# 一、实现目标


> 假设有名为testing的名称空间内运行着一组nginx Pod和一组myappPod。要求实现如下目标。
>

1. myapp Pod仅允许来自nginx Pod的流量访问其80/TCP端口，但可以向nginx Pod的所有端口发出出站流量。
2. nginx Pod允许任何源端点对其80/TCP端口的访问，并能够向任意端点发出出站流量。
3. myapp Pod和nginx Pod都可与kube-system名称空间的任意Pod进行任何类型的通信，以便于可以使用由kube-dns提供的名称解析服务等。

![](https://via.placeholder.com/800x600?text=Image+a50b612ac9e7a7eb)

# 二、创建基本环境


1. 创建testing名称空间，为其添加标签“ns=kube-system”

![](https://via.placeholder.com/800x600?text=Image+86561d430ebbbd68)

2. 使用deployment控制器在testing空间创建nginx pod

![](https://via.placeholder.com/800x600?text=Image+1899576198f93c35)

3. 使用deployment控制器在testing空间创建myapp pod

![](https://via.placeholder.com/800x600?text=Image+9efa81753d4f0773)

4. 启动一个终端，在default名称空间中创建一个用于测试的临时交互式客户端：  
# kubectl run cirros-$RANDOM --namespace=default --rm -it --image=cirros -- sh
+ 分别测试访问nginx和myapp的服务，名称空间的默认网络策略为准许访问，接下来确认其访问请求可正常通过：

![](https://via.placeholder.com/800x600?text=Image+4fa7d12aaaefbd1e)

# 三、定义默认网络策略并测试


1. 将testing名称空间的入站及出站的默认策略修改为拒绝访问

![](https://via.placeholder.com/800x600?text=Image+eb7ef9fca2ed155d)

2. 查看对应的netpol生成情况

![](https://via.placeholder.com/800x600?text=Image+289cb7d747471d93)

3. 再一次进行访问测试：

![](https://via.placeholder.com/800x600?text=Image+b6bccf5e1403f79c)



# 四、定义流量放行规则


1. 配置清单，允许任何源端点对其80/TCP端口的访问

![](https://via.placeholder.com/800x600?text=Image+bb46b6a773cb2de7)

+ 测试客户端发起访问请求进行测试，nginx已经能够正常访问。

![](https://via.placeholder.com/800x600?text=Image+b9cc9ca8a1af51cb)

2. 放行testing名称空间中来自nginx Pod的发往myapp Pod的80/TCP的访问流量，以及myapp Pod发往nginx Pod的所有流量。允许myapp Pod与kube-system名称空间的任何Pod进行交互的所有流量：

![](https://via.placeholder.com/800x600?text=Image+b7c8f67aeefc50c2)

+ 测试客户端发起访问请求进行测试，myapp拒绝访问。

![](https://via.placeholder.com/800x600?text=Image+43fbc1d477e99c63)

+ 进入nginx空间访问myapp测试，允许访问。

![](https://via.placeholder.com/800x600?text=Image+9be4555b446036c9)


