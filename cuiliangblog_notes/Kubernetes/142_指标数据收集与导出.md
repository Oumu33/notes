# 指标数据收集与导出
# 指标数据收集方案
OpenTelemetry 支持将指标（Metrics）数据导出到多种后端，比如 Prometheus、OTLP、Grafana Cloud等。**导出方式取决于你使用的语言 SDK 和部署模式**（例如手动 SDK 初始化 vs. 使用 OpenTelemetry Collector）。

## OpenTelemetry Collector 导出指标 
这适用于服务中接入 OpenTelemetry SDK 后，将数据导出到 Collector，由 Collector 转发到后端（如 Prometheus）。  

指标数据导出链路为：

应用 (OTel SDK) ——>OpenTelemetry Collector——>Prometheus / Grafana / OTLP / ...

## 在 SDK 中直接导出
比如你用的是 Python、Go、Java 等语言开发的应用，可以在使用opentelemetry.sdk.metrics 这个SDK 在初始化阶段配置 exporter。  

# 指标采集与导出
## 配置Instrumentation
使用 OpenTelemetry 的 `Instrumentation` CRD 自动注入机制，可以实现对 Metrics 的“内置指标”的采集，Java Agent 从 1.26.0+ 支持 JVM runtime metrics（如 GC、线程数）采集。

```yaml
apiVersion: opentelemetry.io/v1alpha1    
kind: Instrumentation                     # 声明资源类型为 Instrumentation（用于语言自动注入）
metadata:
  name: java-instrumentation              # Instrumentation 资源的名称（可以被 Deployment 等引用）
  namespace: opentelemetry
spec:
  propagators:                            # 指定用于 trace 上下文传播的方式，支持多种格式
    - tracecontext                        # W3C Trace Context（最通用的跨服务追踪格式）
    - baggage                             # 传播用户定义的上下文键值对
    - b3                                  # Zipkin 的 B3 header（用于兼容 Zipkin 环境）
  sampler:                                # 定义采样策略（决定是否收集 trace）
    type: always_on                       # 始终采样所有请求（适合测试或调试环境）
  java:
    image: ghcr.io/open-telemetry/opentelemetry-operator/autoinstrumentation-java:latest
                                          # 使用的 Java 自动注入 agent 镜像地址
    env:
      - name: OTEL_METRICS_EXPORTER                  # 启用metrics指标导出
        value: "otlp"
      - name: OTEL_EXPORTER_OTLP_ENDPOINT
        value: http://center-collector.opentelemetry.svc:4318
```

## 配置 Collector
配置 collector 导出 prometheus 格式的指标，以便 prometheus 可以抓取指标数据。

```yaml
apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
# 元数据定义部分
metadata:
  name: center        # Collector 的名称为 center
  namespace: opentelemetry
# 具体的配置内容
spec:
  replicas: 1           # 设置副本数量为1
  config:               # 定义 Collector 配置
    receivers:          # 接收器，用于接收遥测数据（如 trace、metrics、logs）
      otlp:             # 配置 OTLP（OpenTelemetry Protocol）接收器
        protocols:      # 启用哪些协议来接收数据
          grpc: 
            endpoint: 0.0.0.0:4317      # 启用 gRPC 协议
          http: 
            endpoint: 0.0.0.0:4318      # 启用 HTTP 协议

    processors:         # 处理器，用于处理收集到的数据
      batch: {}         # 批处理器，用于将数据分批发送，提高效率

    exporters:          # 导出器，用于将处理后的数据发送到后端系统
      # debug: {}         # 使用 debug 导出器，将数据打印到终端（通常用于测试或调试）
      otlp:               # 数据发送到tempo的grpc端口
        endpoint: "tempo:4317"
        tls: # 跳过证书验证
          insecure: true
      prometheus:
        endpoint: "0.0.0.0:9464" # prometheus指标暴露端口

    service:            # 服务配置部分
      pipelines:        # 定义处理管道
        traces:         # 定义 trace 类型的管道
          receivers: [otlp]                      # 接收器为 OTLP
          processors: [batch]                    # 使用批处理器
          exporters: [otlp]                      # 将数据导出到OTLP
        metrics:        # 定义 metrics 类型的管道
          receivers: [otlp]                      # 接收器为 OTLP
          processors: [batch]                    # 使用批处理器
          exporters: [prometheus]                # 将数据导出到prometheus
```

## 创建监控项
创建ServiceMonitor 资源

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: opentelemetry # ServiceMonitor名称
  namespace: opentelemetry # ServiceMonitor所在名称空间
spec:
  jobLabel: opentelemetry # job名称
  endpoints: # prometheus所采集Metrics地址配置，endpoints为一个数组，可以创建多个，但是每个endpoints包含三个字段interval、path、port
  - port: prometheus # prometheus采集数据的端口，这里为port的name，主要是通过spec.selector中选择对应的svc，在选中的svc中匹配该端口
    interval: 30s # prometheus采集数据的周期，单位为秒
    scheme: http # 协议
    path: /metrics # prometheus采集数据的路径
  selector: # svc标签选择器，匹配service的labels
    matchLabels:
      app.kubernetes.io/name: center-collector
      operator.opentelemetry.io/collector-service-type: base
  namespaceSelector: # namespace选择
    matchNames:
    - opentelemetry
```

查看 target 信息

![](https://via.placeholder.com/800x600?text=Image+1cef22cf2156d87e)

## 查看指标数据
以 java 为例， OpenTelemetry sdk 内置了标准的 JVM 运行时指标 ， 这些指标覆盖了 **JVM 运行时、HTTP 服务、线程、GC 等关键领域**，并以 Prometheus 格式暴露在 `/metrics` 接口上。  

![](https://via.placeholder.com/800x600?text=Image+e42ef2c4572815a5)

我们可以通过 PromQL 查询指标信息

![](https://via.placeholder.com/800x600?text=Image+169fe24f108e9b5e)


