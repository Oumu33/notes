# 部署ELK日志收集

> 来源: Kubernetes
> 创建时间: 2020-10-30T00:13:52+08:00
> 更新时间: 2026-01-11T09:05:00.229162+08:00
> 阅读量: 2226 | 点赞: 0

---

> 以3节点为例，存储使用local pv使用最大io性能，所有节点即是master节点也是data节点。完整内容可参考文档：[https://www.cuiliangblog.cn/detail/section/162609409](https://www.cuiliangblog.cn/detail/section/162609409)
>

# <font style="color:rgb(48, 49, 51);">系统参数调整</font>
## <font style="color:rgb(48, 49, 51);">修改文件描述符数目</font>
<font style="color:rgb(48, 49, 51);">设置环境变量</font>

```plain
# 修改环境变量文件
vim /etc/profile
ulimit -n 65535
# 使配置生效
source /etc/profile
```

<font style="color:rgb(48, 49, 51);">修改limits.conf配置文件</font>

```plain
# 修改limits.conf配置
vim /etc/security/limits.conf
* soft nofile 65535
* hard nofile 65535
```

<font style="color:rgb(48, 49, 51);">验证</font>

```plain
# ulimit -n
65535
```

## <font style="color:rgb(48, 49, 51);">修改虚拟内存数大小</font>
<font style="color:rgb(48, 49, 51);">内核设置可以直接在主机上设置，也可以通过具有特权的初始化容器中设置，通常情况下直接在主机上设置。</font>

<font style="color:rgb(48, 49, 51);">临时设置</font>

```plain
# sysctl -w vm.max_map_count=262144
vm.max_map_count = 262144
```

<font style="color:rgb(48, 49, 51);">永久设置</font>

```plain
cat >> /etc/sysctl.conf << EOF
vm.max_map_count=262144
EOF
# sysctl -p 
vm.max_map_count = 262144
```

# <font style="color:rgb(48, 49, 51);">ECK部署</font>
## <font style="color:rgb(48, 49, 51);">部署CRD资源</font>
```bash
[root@tiaoban eck]# wget https://download.elastic.co/downloads/eck/3.1.0/crds.yaml
[root@tiaoban eck]# kubectl apply -f crds.yaml 
customresourcedefinition.apiextensions.k8s.io/agents.agent.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/apmservers.apm.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/beats.beat.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/elasticmapsservers.maps.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/elasticsearchautoscalers.autoscaling.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/elasticsearches.elasticsearch.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/enterprisesearches.enterprisesearch.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/kibanas.kibana.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/logstashes.logstash.k8s.elastic.co created
customresourcedefinition.apiextensions.k8s.io/stackconfigpolicies.stackconfigpolicy.k8s.elastic.co created
```

## <font style="color:rgb(48, 49, 51);">部署Operator</font>
```bash
[root@tiaoban eck]# wget https://download.elastic.co/downloads/eck/3.1.0/operator.yaml
[root@tiaoban eck]# kubectl apply -f operator.yaml 
namespace/elastic-system created
serviceaccount/elastic-operator created
secret/elastic-webhook-server-cert created
configmap/elastic-operator created
clusterrole.rbac.authorization.k8s.io/elastic-operator created
clusterrole.rbac.authorization.k8s.io/elastic-operator-view created
clusterrole.rbac.authorization.k8s.io/elastic-operator-edit created
clusterrolebinding.rbac.authorization.k8s.io/elastic-operator created
service/elastic-webhook-server created
statefulset.apps/elastic-operator created
validatingwebhookconfiguration.admissionregistration.k8s.io/elastic-webhook.k8s.elastic.co created
```

## <font style="color:rgb(48, 49, 51);">验证</font>
```bash
[root@tiaoban eck]# kubectl get pod -n elastic-system 
NAME                 READY   STATUS    RESTARTS   AGE
elastic-operator-0   1/1     Running   0          2s
[root@tiaoban eck]# kubectl get svc -n elastic-system 
NAME                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
elastic-webhook-server   ClusterIP   10.103.185.159   <none>        443/TCP   5m55s
```

<font style="color:rgb(48, 49, 51);">当看到elastic-operator-0状态为Running时，表示eck已成功部署并运行在k8s集群上。</font>

# <font style="color:rgb(48, 49, 51);">Elasticsearch部署</font>
## 添加节点标签
假设我们在 k8s-1、k8s-2、k8s-3 节点部署分布式 es 集群，先添加节点标签，方便调度到指定节点。

```bash
# kubectl label node k8s-1 storage=true                       
node/k8s-1 labeled
# kubectl label node k8s-2 storage=true
node/k8s-2 labeled
# kubectl label node k8s-3 storage=true
node/k8s-3 labeled
```

## <font style="color:rgb(48, 49, 51);">创建elasticsearch集群</font>
```yaml
[root@tiaoban eck]# cat > es.yaml << EOF
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  namespace: elk
  name: elasticsearch
spec:
  version: 9.1.1
  # image: harbor.cuiliangblog.cn/elk/elasticsearch:9.1.1 # 自定义镜像地址，如果不指定则从elastic官方镜像仓库拉取
  nodeSets:
  - name: all # 节点名称
    count: 3  # 节点数量
    volumeClaimTemplates:
    - metadata:
        name: elasticsearch-data
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 50Gi # 指定master节点存储容量
        storageClassName: local-path # 使用LocalPathProvisioner本地存储
    podTemplate:
      spec:
        nodeSelector:             # 指定调度节点标签
          storage: "true"          
        containers:
        - name: elasticsearch
          env:
          - name: ES_JAVA_OPTS           # 指定节点JVM大小
            value: "-Xms1g -Xmx1g"
          resources:
            limits:	 # 资源限制值，通常为JVM的2倍
              cpu: 2
              memory: 2Gi
            requests:	# 资源请求值，通常与JVM保持一致
              cpu: 1
              memory: 1Gi
EOF
[root@tiaoban eck]# kubectl apply -f es.yaml
elasticsearch.elasticsearch.k8s.elastic.co/elasticsearch created
```

## <font style="color:rgb(48, 49, 51);">查看并验证资源</font>
```bash
[root@tiaoban eck]# kubectl get pod -n elk
NAME                     READY   STATUS    RESTARTS   AGE
elasticsearch-es-all-0   1/1     Running   0          3m48s
elasticsearch-es-all-1   1/1     Running   0          3m48s
elasticsearch-es-all-2   1/1     Running   0          3m48s
[root@tiaoban eck]# kubectl get svc -n elk
NAME                             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
elasticsearch-es-all             ClusterIP   None            <none>        9200/TCP   4m7s
elasticsearch-es-http            ClusterIP   10.96.196.197   <none>        9200/TCP   4m9s
elasticsearch-es-internal-http   ClusterIP   10.98.63.89     <none>        9200/TCP   4m9s
elasticsearch-es-transport       ClusterIP   None            <none>        9300/TCP   4m9s
[root@tiaoban eck]# kubectl get es -n elk
NAME            HEALTH   NODES   VERSION   PHASE   AGE
elasticsearch   green    3       9.1.1     Ready   14m
```

<font style="color:rgb(48, 49, 51);">获取elastic用户密码</font>

```bash
[root@tiaoban eck]# kubectl get secrets -n elk elasticsearch-es-elastic-user -o go-template='{{.data.elastic | base64decode}}'
A1i529P3q783xblCSChV8zY1
```

<font style="color:rgb(48, 49, 51);">导出CA证书</font>

```bash
[root@tiaoban eck]# kubectl -n elk get secret elasticsearch-es-http-certs-public -o go-template='{{index .data "ca.crt" | base64decode }}' > ca.crt
```

<font style="color:rgb(48, 49, 51);">访问验证</font>

```bash
[root@rockylinux /]# curl -k https://elastic:A1i529P3q783xblCSChV8zY1@elasticsearch-es-http.elk.svc:9200/_cat/nodes?v
ip          heap.percent ram.percent cpu load_1m load_5m load_15m node.role   master name
10.244.0.55            8          71   8    0.65    0.69     0.66 cdfhilmrstw -      elasticsearch-es-all-0
10.244.2.32           45          72   9    0.90    0.98     0.82 cdfhilmrstw *      elasticsearch-es-all-2
10.244.1.24           25          70   7    1.04    0.91     0.73 cdfhilmrstw -      elasticsearch-es-all-1
```

## 创建ingress资源
自签证书创建secret资源

```bash
[root@tiaoban eck]# openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj "/CN=elk-tls"
Generating a RSA private key
writing new private key to 'tls.key'
[root@tiaoban eck]# kubectl create secret tls -n elk elk-tls --cert=tls.crt --key=tls.key
secret/elk-tls created
```

<font style="color:rgb(48, 49, 51);">创建IngressRouter规则文件和ServersTransport文件，配置insecureSkipVerify使得traefik代理访问后端服务时跳过证书验证。</font>

```yaml
[root@tiaoban eck]# cat > es-ingress.yaml << EOF
apiVersion: traefik.io/v1alpha1
kind: ServersTransport
metadata:
  name: elasticsearch-transport
  namespace: elk
spec:
  serverName: "elasticsearch.cuiliangblog.cn"
  insecureSkipVerify: true
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: elasticsearch-tls
  namespace: elk
spec:
  entryPoints:
    - websecure                  
  routes:
  - match: Host(`elasticsearch.cuiliangblog.cn`)
    kind: Rule
    services:
    - name: elasticsearch-es-http
      port: 9200
      serversTransport: elasticsearch-transport
  tls:
    secretName: elk-tls
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: redirect-https-middleware
  namespace: elk
spec:
  redirectScheme:
    scheme: https
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: elasticsearch
  namespace: elk
spec:
  entryPoints:
  - web
  routes:
  - match: Host(`elasticsearch.cuiliangblog.cn`)
    kind: Rule
    services:
    - name: elasticsearch-es-http
      port: 9200
    middlewares:
    - name: redirect-https-middleware   # 指定使用RedirectScheme中间件，完成http强制跳转至https
EOF
[root@tiaoban eck]# kubectl apply -f es.yaml
serverstransport.traefik.io/elasticsearch-transport created
ingressroute.traefik.io/elasticsearch-tls created
middleware.traefik.io/redirect-https-middleware created
ingressroute.traefik.io/elasticsearch created
```

添加hosts后访问验证

![](https://via.placeholder.com/800x600?text=Image+094d31b311d839bf)

# <font style="color:rgb(48, 49, 51);">Kibana部署</font>
## 创建kibana资源
```yaml
[root@tiaoban eck]# cat > kibana.yaml << EOF
apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
  name: kibana
  namespace: elk
spec:
  version: 9.1.1
  # image: harbor.cuiliangblog.cn/elk/kibana:9.1.1
  count: 1
  elasticsearchRef: # 与Elasticsearch资源名称匹配
    name: elasticsearch
  podTemplate:
    spec:
      containers:
      - name: kibana
        env:
          - name: NODE_OPTIONS
            value: "--max-old-space-size=2048"
          - name: SERVER_PUBLICBASEURL
            value: "https://kibana.cuiliangblog.cn"
          - name: I18N_LOCALE # 中文配置
            value: "zh-CN"
        resources:
          requests:
            memory: 1Gi
            cpu: 0.5
          limits:
            memory: 2Gi
            cpu: 2
EOF
[root@tiaoban eck]# kubectl apply -f kibana.yaml
kibana.kibana.k8s.elastic.co/kibana created
```

<font style="color:rgb(48, 49, 51);">查看验证</font>

```bash
[root@tiaoban eck]# kubectl get pod -n elk | grep kibana
kibana-kb-6698c6c45d-r7jj6   1/1     Running       0          3m39s
[root@tiaoban eck]# kubectl get svc -n elk | grep kibana
kibana-kb-http                   ClusterIP   10.105.217.119   <none>        5601/TCP   3m43s
[root@tiaoban eck]# kubectl get kibana -n elk
NAME     HEALTH   NODES   VERSION   AGE
kibana   green    1       9.1.1     7m5s
```

## <font style="color:rgb(48, 49, 51);">创建Ingress资源</font>
```yaml
[root@tiaoban eck]# cat > kibana-ingress.yaml << EOF
apiVersion: traefik.io/v1alpha1
kind: ServersTransport
metadata:
  name: kibana-transport
  namespace: elk
spec:
  serverName: "kibana.cuiliangblog.cn"
  insecureSkipVerify: true
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: kibana-tls
  namespace: elk
spec:
  entryPoints:
    - websecure             
  routes:
  - match: Host(`kibana.cuiliangblog.cn`)
    kind: Rule
    services:
    - name: kibana-kb-http
      port: 5601
      serversTransport: kibana-transport
  tls:
    secretName: elk-tls
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: kibana
  namespace: elk
spec:
  entryPoints:
  - web
  routes:
  - match: Host(`kibana.cuiliangblog.cn`)
    kind: Rule
    services:
    - name: kibana-kb-http
      port: 5601
    middlewares:
    - name: redirect-https-middleware   # 指定使用RedirectScheme中间件，完成http强制跳转至https
EOF
[root@tiaoban eck]# kubectl apply -f kibana.yaml
serverstransport.traefik.io/kibana-transport created
ingressroute.traefik.io/kibana-tls created
ingressroute.traefik.io/kibana created
```

## <font style="color:rgb(48, 49, 51);">访问验证</font>
<font style="color:rgb(48, 49, 51);">客户端添加hosts记录后访问kibana测试</font>

![](https://via.placeholder.com/800x600?text=Image+eb24649e7f106e91)


