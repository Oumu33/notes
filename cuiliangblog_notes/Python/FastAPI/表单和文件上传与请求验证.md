# 表单和文件上传与请求验证

> 分类: Python > FastAPI
> 更新时间: 2026-01-10T23:34:33.471208+08:00

---

> FastAPI 不仅擅长处理 JSON 请求体，还可以优雅地处理表单提交和文件上传。学习本章内容，你将掌握如何使用 `Form` 和 `File` 类声明表单字段和上传文件，知道如何对这些请求参数进行验证，提升接口的健壮性和安全性。
>

# 表单请求
## 表单参数
在传统 HTML 表单中，数据通常以 `application/x-www-form-urlencoded` 格式提交，FastAPI 提供了 `Form` 类来处理这种数据格式。

示例：接收登录表单数据

```python
from fastapi import FastAPI, Form

app = FastAPI()

@app.post("/login/")
def login(username: str = Form(...), password: str = Form(...)):
    """
    处理用户登录请求的端点函数
    
    该函数通过POST方法接收用户名和密码表单数据，并返回包含这些信息的字典
    
    参数:
        username (str): 用户名，通过表单字段传递，必需参数
        password (str): 密码，通过表单字段传递，必需参数
    
    返回值:
        dict: 包含用户名和密码的字典，格式为{"username": username, "password": password}
    """
    return {"username": username, "password": password}
```

你可以在 Swagger 文档 `/docs` 中使用表单方式进行测试。注意：如果你尝试用 JSON 格式发送数据，将收到错误提示。

# 文件上传
## 文件上传
FastAPI 支持文件上传，并自动处理文件流。你可以使用 `File(...)` 接收原始二进制数据，或者使用 `UploadFile` 对象，它提供了更丰富的文件操作接口（如 `.filename`, `.file.read()` 等）。

示例：上传一个文件

```python
from fastapi import FastAPI, File, UploadFile

app = FastAPI()

@app.post("/upload-file/")
async def upload_file(file: UploadFile = File(...)):
    """
    异步处理文件上传请求
    
    该函数接收一个上传的文件，读取其内容并返回文件的基本信息。
    
    参数:
        file (UploadFile): 通过表单数据上传的文件对象，默认为必需参数
                          包含文件名、内容类型等元数据信息
    
    返回值:
        dict: 包含以下键值对的字典：
            - filename (str): 上传文件的原始文件名
            - content_type (str): 文件的MIME类型
            - size (int): 文件内容的字节长度
    """
    # 读取上传文件的全部内容
    content = await file.read()
    return {
        "filename": file.filename,
        "content_type": file.content_type,
        "size": len(content)
    }
```

你也可以使用同步的方式读取文件，但推荐使用异步 `await file.read()`。

## 同时上传多个文件
使用 `List[UploadFile]` 接收多个文件：

```python
from typing import List
from fastapi import FastAPI, File, UploadFile
app = FastAPI()

@app.post("/upload-files/")
async def upload_files(files: List[UploadFile] = File(...)):
    """
    异步处理文件上传请求
    
    该函数接收客户端上传的多个文件，并返回所有文件的文件名列表。
    
    参数:
        files (List[UploadFile]): 上传的文件列表，使用FastAPI的File()来接收multipart/form-data格式的文件数据
        
    返回值:
        dict: 包含所有上传文件文件名的字典，格式为 {"filenames": [filename1, filename2, ...]}
    """
    # 提取所有上传文件的文件名并返回
    return {"filenames": [file.filename for file in files]}
```

Swagger 会自动生成多个文件上传框。

## 表单与文件混合上传
你也可以在同一个接口中同时接收表单字段和文件：

```python
from fastapi import FastAPI, File, UploadFile, Form
app = FastAPI()

@app.post("/form-and-file/")
async def upload_form_and_file(
    name: str = Form(...),
    file: UploadFile = File(...)
):
    """
    处理同时包含表单数据和文件上传的POST请求
    
    该函数接收一个字符串类型的表单字段和一个文件上传字段，
    并返回包含表单数据和文件名的JSON响应。
    
    参数:
        name (str): 通过表单提交的字符串数据，使用Form(...)表示此字段为必填项
        file (UploadFile): 上传的文件对象，使用File(...)表示此字段为必填项
        
    返回值:
        dict: 包含name和filename两个键的字典
              - name: 提交的表单数据
              - filename: 上传文件的原始文件名
    """
    return {"name": name, "filename": file.filename}
```

这种方式在提交复杂数据（如表单+头像上传）时非常常见。

# 数据校验
## 请求验证与错误提示
FastAPI 会自动对 `Form`、`File`、`UploadFile` 声明的参数进行验证：

+ 如果字段缺失，返回 `422 Unprocessable Entity`；
+ 如果字段类型不匹配，同样会自动提示错误；
+ 支持结合 `pydantic` 模型对某些值进行更复杂的校验（如长度、格式等）。

示例：表单字段长度校验

```python
from fastapi import FastAPI, Form, Depends
from pydantic import BaseModel, StringConstraints
from typing import Annotated

app = FastAPI()

class LoginForm(BaseModel):
    """
    登录表单数据模型
    
    Attributes:
        username (str): 用户名，长度至少为3个字符
        password (str): 密码，长度至少为6个字符
    """
    username: Annotated[str, StringConstraints(min_length=3)]
    password: Annotated[str, StringConstraints(min_length=6)]

def as_form(
    username: str = Form(...),
    password: str = Form(...)
) -> LoginForm:
    """
    将表单数据转换为LoginForm对象
    
    Args:
        username (str): 从表单中获取的用户名字段，必需项
        password (str): 从表单中获取的密码字段，必需项
    
    Returns:
        LoginForm: 包含用户名和密码的登录表单对象
    """
    return LoginForm(username=username, password=password)

# 处理登录验证的POST请求端点
@app.post("/validate-login/")
def validate_login(form_data: LoginForm = Depends(as_form)):
    """
    验证登录信息端点
    
    Args:
        form_data (LoginForm): 通过依赖注入获取的登录表单数据
    
    Returns:
        LoginForm: 返回接收到的登录表单数据
    """
    return form_data

```

通过组合 `Depends` + `Form`，你可以使用 `Pydantic` 校验复杂的表单输入。

## 文件类型限制（自定义验证）
FastAPI 不限制上传文件的格式，但你可以手动检查 `file.content_type` 来拒绝非法文件：

```python
from fastapi import FastAPI, File, UploadFile

app = FastAPI()


@app.post("/secure-upload/")
async def secure_upload(file: UploadFile = File(...)):
    """
    安全上传文件处理函数
    
    该函数接收上传的文件，验证文件类型是否为PNG或JPEG格式，
    如果符合要求则返回文件名，否则返回错误信息。
    
    参数:
        file (UploadFile): 通过表单上传的文件对象，默认为必需参数
        
    返回值:
        dict: 包含文件名或错误信息的字典
              成功时返回 {"filename": 文件名}
              失败时返回 {"error": 错误描述}
    """
    # 验证文件类型，只允许PNG或JPEG格式
    if file.content_type not in ["image/png", "image/jpeg"]:
        return {"error": "Only PNG or JPEG files are allowed."}
    return {"filename": file.filename}

```

