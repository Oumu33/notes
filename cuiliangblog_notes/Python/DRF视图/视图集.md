# 视图集

> 分类: Python > DRF视图
> 更新时间: 2026-01-10T23:34:31.404411+08:00

---

## 一、简介
### 1. 特点:
+ 可以将一组相关的操作, 放在一个类中进行完成
+ 不提供get,post方法, 使用retrieve, create方法来替代
+ 可以将标准的请求方式(get,post,put,delete), 和mixin中的方法做映射

### 2. 常见的视图集父类
| 类名称    |               父类       |         作用 |
| --- | --- | --- |
| ViewSet | APIView ViewSetMixin | 可以做路由映射 |
| GenericViewSet | GenericAPIView ViewSetMixin | <font style="color:#404040;">可以做路由映射,可以使用二级视图三个属性,三个方法</font> |
| ModelViewSet | GenericAPIView 5个mixin类 | |
| ReadOnlyModelViewSet | GenericAPIView RetrieveModelMixin ListModelMixin | |


## 二、示例
### 1. ViewSet
+ view.ps

```python
from rest_framework.generics import get_object_or_404
from rest_framework.response import Response
from quickstart.models import BookInfo
from quickstart.serializers import BookInfoSerializer
from rest_framework import viewsets
class BookInfoViewSet(viewsets.ViewSet):
    """
    获取所有图书和单个图书信息
    """
    def list(self, request):
        queryset = BookInfo.objects.all()
        serializer = BookInfoSerializer(queryset, many=True)
        return Response(serializer.data)
    def retrieve(self, request, pk=None):
        queryset = BookInfo.objects.all()
        book = get_object_or_404(queryset, pk=pk)
        serializer = BookInfoSerializer(book)
        return Response(serializer.data)
```

+ urls.py

```python
from django.urls import path
from quickstart import views

urlpatterns = [
    path('books/', views.BookInfoViewSet.as_view({'get': 'list'})),
    path('books/<int:pk>', views.BookInfoViewSet.as_view({'get': 'retrieve'}))
]
```

### 2. ModelViewSet
+ view.ps

```python
from quickstart.models import BookInfo
from quickstart.serializers import BookInfoSerializer
from rest_framework import viewsets


class BookInfoModelViewSet(viewsets.ModelViewSet):
    """
    获取所有图书和单个图书信息的增删改查
    """
    queryset = BookInfo.objects.all()
    serializer_class = BookInfoSerializer
```

+ urls.py

```python
from django.urls import path
from rest_framework import routers

app_name = "public"
router = routers.DefaultRouter()
# 示例数据接口
router.register('bookInfo', views.BookInfoModelViewSet, 'bookInfo')
urlpatterns += router.urls
```

### 3. ReadOnlyModelViewSet
+ view.ps

```python
from quickstart.models import BookInfo
from quickstart.serializers import BookInfoSerializer
from rest_framework import viewsets


class BookInfoReadOnlyModelViewSet(viewsets.ReadOnlyModelViewSet):
    """
    获取所有图书和单个图书信息
    """
    queryset = BookInfo.objects.all()
    serializer_class = BookInfoSerializer
```

+ urls.py

```python
from django.urls import path
from quickstart import views

urlpatterns = [
    path('books/', views.BookInfoReadOnlyModelViewSet.as_view({'get': 'list'})),
    path('books/<int:pk>/', views.BookInfoReadOnlyModelViewSet.as_view({'get': 'retrieve'}))
]
```

## 三、重写增删改查方法
### 1. 重写queryset查询方法
```python
class HistoryReadOnlyModelViewSet(viewsets.ReadOnlyModelViewSet):
    """
    获取操作记录
    """
    serializer_class = OperateHistorySerializer

    # 重写queryset方法
    def get_queryset(self):
        # 获取查询参数
        operate = self.request.query_params.get('operate')
        goods_id = self.request.query_params.get('goods_id')
        user_id = self.request.query_params.get('user_id')
        position_id = self.request.query_params.get('position_id')
        start_time = self.request.query_params.get('start_time')
        end_time = self.request.query_params.get('end_time')
        q1 = Q()
        q1.connector = 'AND'
        if operate:
            q1.children.append(('operate', operate))
        if goods_id:
            q1.children.append(('goods_id', goods_id))
        if user_id:
            q1.children.append(('user_id', user_id))
        if position_id:
            q1.children.append(('goods__position', position_id))
        if start_time and end_time:
            q1.children.append(('time__range', [start_time, end_time]))
        return OperateHistory.objects.filter(q1).order_by('-time')
```

### 2. 重写get方法
```python
class ArticleModelViewSet(viewsets.ModelViewSet):
    """
    博客文章增删改查
    """
    queryset = Article.objects.all()
    pagination_class = MyPageNumber
    filter_backends = [DjangoFilterBackend, filters.OrderingFilter]
    ordering_fields = ['is_recommend', 'created_time', 'view', 'comment', 'like', 'collect']
    filter_fields = ['category', 'tags']

    # 重写get文章方法（阅读量+1,更新留言数）
    def retrieve(self, request, *args, **kwargs):
        instance = self.get_object()
        instance.comment = ArticleComment.objects.filter(article=instance.id).count()
        instance.view = instance.view + 1
        instance.save()
        serializer = self.get_serializer(instance)
        return Response(serializer.data)
```

### 3. 重写序列化器方法
```python
class ArticleModelViewSet(viewsets.ModelViewSet):
    """
    博客文章增删改查
    """
    queryset = Article.objects.all()
    pagination_class = MyPageNumber
    filter_backends = [DjangoFilterBackend, filters.OrderingFilter]
    ordering_fields = ['is_recommend', 'created_time', 'view', 'comment', 'like', 'collect']
    filter_fields = ['category', 'tags']

    # 重写序列化器方法(查询全部和查询指定id返回不同的字段)
    def get_serializer_class(self):
        if self.action == 'list':
            return ArticleListSerializer
        else:
            return ArticleRetrieveSerializer
```

### 4. 重写update方法
```python
class LeaveMessageModelViewSet(viewsets.ModelViewSet):
    """
    留言增删改查
    """
    serializer_class = LeaveMessageSerializer

    # 重写更新方法
    def perform_update(self, serializer):
        serializer.save()
        name = serializer.data['name']

    # 重写更新的response
    def update(self, request, *args, **kwargs):
        try:
            instance = self.get_object()
            instance.like = instance.like + 1
            instance.save()
            return Response({'msg': '点赞成功'}, status=status.HTTP_200_OK)
        except Exception as e:
            print(e)
            return Response({'msg': '点赞失败'}, status=status.HTTP_400_BAD_REQUEST)
```

### 5. 重写delete方法
```python
class CmdbModelViewSet(viewsets.ModelViewSet):
    """
    资产信息的增删改查
    """
    serializer_class = CmdbSerializer


    # 重写删除方法
    def perform_destroy(self, instance):
        instance.is_delete = True
        instance.save()

    # 也可以重写删除的response
    def destroy(self, request, *args, **kwargs):
        instance = self.get_object()
        self.perform_destroy(instance)
        return Response(status=status.HTTP_204_NO_CONTENT)
```

### 6. 重写create方法
```python
from django.db import transaction
class GoodsModelVIewSet(viewsets.ModelViewSet):
    """
    资产信息增删改查
    """
    queryset = Goods.objects.all()
    serializer_class = GoodsSerializer

    # 重写create方法
    @transaction.atomic  # 开启事务
    def perform_create(self, serializer):
        # 设置保存点
        sid = transaction.savepoint()
        try:
            Goods.objects.create(**serializer.data)
            OperateHistory.objects.create(operate=1, goods_id=goodsObj.id, user_id=serializer.data.get('user_id'),
                                          number=serializer.data.get('number'))
        except Exception as e:
            print(e)
            transaction.savepoint_rollback(sid)  # 回滚
        transaction.savepoint_commit(sid)  # 提交
        
	# 重写create和response
    def create(self, request, *args, **kwargs):
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        self.perform_create(serializer)
        return Response(serializer.data, status=status.HTTP_201_CREATED)
```

### 7. 重写patch方法
```python
class CmdbModelViewSet(viewsets.ModelViewSet):
    """
    资产信息的增删改查
    """
    serializer_class = CmdbSerializer


    # 重写patch方法
    def perform_update(self, serializer):
        serializer.save()
        name = serializer.data['name']

    # 也可以重写patch的response
    def update(self, request, *args, **kwargs):
        return self.partial_update(request, *args, **kwargs)
```



