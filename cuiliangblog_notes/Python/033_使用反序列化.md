# 使用反序列化

> 来源: Python
> 创建时间: 2021-03-13T22:27:36+08:00
> 更新时间: 2026-01-11T09:25:38.859617+08:00
> 阅读量: 654 | 点赞: 0

---

## 一、数据校验
### 1. 字段类型校验
> 对传入的数据进行字段类型校验，是否满足序列器定义的字段类型（整形，字符形，日期形等）
>

+ **传入合法数据校验**

```python
>>> from quickstart.serializers import BookInfoSerializer
>>> #1. 模拟前端json数据
>>> new_book = {
...     "name": "孙子兵法",
...     "releas_date": "2020-02-02",
...     "read": "10",
...     "comment": "5",
...     "author": 1
... }
>>> #2. 创建序列化器
>>> serializer = BookInfoSerializer(data=new_book)
>>> #3. 数据校验(如果校验不通过，提示详细信息)
>>> serializer.is_valid(raise_exception=True)
True
>>> #4. 输出校验结果(校验通过——serializer对象，校验不通过——原json数据)
>>> print(serializer.data)
{'name': '孙子兵法', 'releas_date': '2020-02-02', 'read': 10, 'is_delete': False}
```

+ **传入非法数据校验（**read字段传入字符串**）**

```python
>>> from quickstart.serializers import BookInfoSerializer
>>> #1. 模拟前端json数据
>>> new_book = {
...     "name": "孙子兵法",
...     "releas_date": "2020-02-02",
...     "read": "abc",
...     "comment": 5,
...     "author": 1
... }
>>> #2. 创建序列化器
>>> serializer = BookInfoSerializer(data=new_book)
>>> #3. 数据校验(如果校验不通过，提示详细信息)
>>> serializer.is_valid(raise_exception=True)
Traceback (most recent call last):
  File "<console>", line 1, in <module>
  File "/Users/cuiliang/PycharmProjects/tutorial/venv/lib/python3.9/site-packages/rest_framework/serializers.py", line 228, in is_valid
    raise ValidationError(self.errors)
rest_framework.exceptions.ValidationError: {'read': [ErrorDetail(string='请填写合法的整数值。', code='invalid')]}
>>> #4. 输出校验结果(校验通过——serializer对象，校验不通过——原json数据)
>>> print(serializer.data)
{'name': '孙子兵法', 'releas_date': '2020-02-02', 'read': 'abc'}
```

### 2. 字段选项校验
> 对传入的数据进行字段选项校验，是否满足序列器定义的字段选项（最小长度，最大长度，是否可以为空等）
>

+ **传入非法数据校验（**name长度超过20**）**

```python
>>> from quickstart.serializers import BookInfoSerializer
>>> # 1.模拟前端json数据
>>> new_book = {
...     "name": "孙子兵法，子孙兵法，孙子子孙兵法，管他什么兵法，都是好兵法",
...     "releas_date": "2020-02-02",
...     "read": 10,
...     "comment": 5,
...     "author": 1
... }
>>> # 2.创建序列化器
>>> serializer = BookInfoSerializer(data=new_book)
>>> # 3.数据校验(如果校验不通过，提示详细信息)
>>> serializer.is_valid(raise_exception=True)
Traceback (most recent call last):
  File "<console>", line 1, in <module>
  File "/Users/cuiliang/PycharmProjects/tutorial/venv/lib/python3.9/site-packages/rest_framework/serializers.py", line 228, in is_valid
    raise ValidationError(self.errors)
rest_framework.exceptions.ValidationError: {'name': [ErrorDetail(string='请确保这个字段不能超过 20 个字符。', code='max_length')]}
>>> # 4.输出校验结果(校验通过——serializer对象，校验不通过——原json数据)
>>> print(serializer.data)
{'name': '孙子兵法，子孙兵法，孙子子孙兵法，管他什么兵法，都是好兵法', 'releas_date': '2020-02-02', 'read': 10}
```

### 3. 单字段校验
+ **序列化器中****定义单字段校验方法**

```python
# 修改BookInfoSerializer序列器，新增单字段校验方法（name字段不得包含字符）
class BookInfoSerializer(serializers.Serializer):
    id = serializers.IntegerField(label='id', read_only=True)
    name = serializers.CharField(max_length=20, label='书名')
    releas_date = serializers.DateField(label='发布日期')
    read = serializers.IntegerField(default=0, label='阅读量')
    comment = serializers.IntegerField(default=0, label='评论量')
    is_delete = serializers.BooleanField(default=False, label='逻辑删除')
    # 外键关联
    # 外键关联
    author = serializers.PrimaryKeyRelatedField(read_only=True)

    # 单字段校验方法（name字段不得包含字符）
    def validate_name(self, value):
        if value.isalnum():
            # 条件为真，校验通过，直接返回值
            return value
        else:
            # 条件为假，校验不通过，设置异常信息
            raise serializers.ValidationError('书籍名称中不得包含字符')
```

+ **传入合法数据校验**

```python
>>> from quickstart.serializers import BookInfoSerializer
>>> # 1.模拟前端json数据
>>> new_book = {
...     "name": "孙子兵法",
...     "releas_date": "2020-02-02",
...     "read": 10,
...     "comment": 5,
...     "author": 1
... }
>>> # 2.创建序列化器
>>> serializer = BookInfoSerializer(data=new_book)
>>> # 3.数据校验(如果校验不通过，提示详细信息)
>>> serializer.is_valid(raise_exception=True)
孙子兵法
True
>>> # 4.输出校验结果(校验通过——serializer对象，校验不通过——原json数据)
>>> print(serializer.data)
{'name': '孙子兵法', 'releas_date': '2020-02-02', 'read': 10, 'is_delete': False}
```

+ **传入非法数据校验**（name中包含字符）

```python
>>> from quickstart.serializers import BookInfoSerializer
>>> 
>>> # 1.模拟前端json数据
>>> new_book = {
...     "name": "孙子兵法-1",
...     "releas_date": "2020-02-02",
...     "read": 10,
...     "comment": 5,
...     "author": 1
... }
>>> # 2.创建序列化器
>>> serializer = BookInfoSerializer(data=new_book)
>>> # 3.数据校验(如果校验不通过，提示详细信息)
>>> serializer.is_valid(raise_exception=True)
孙子兵法-1
Traceback (most recent call last):
  File "<console>", line 1, in <module>
  File "/Users/cuiliang/PycharmProjects/tutorial/venv/lib/python3.9/site-packages/rest_framework/serializers.py", line 228, in is_valid
    raise ValidationError(self.errors)
rest_framework.exceptions.ValidationError: {'name': [ErrorDetail(string='书籍名称中不得包含字符', code='invalid')]}
>>> # 4.输出校验结果(校验通过——serializer对象，校验不通过——原json数据)
>>> print(serializer.data)
{'name': '孙子兵法-1', 'releas_date': '2020-02-02', 'read': 10}
```

### 4. 多字段校验
+ **序列化器中定义单字段校验方法**

```python
class BookInfoSerializer(serializers.Serializer):
    id = serializers.IntegerField(label='id', read_only=True)
    name = serializers.CharField(max_length=20, label='书名')
    releas_date = serializers.DateField(label='发布日期')
    read = serializers.IntegerField(default=0, label='阅读量')
    comment = serializers.IntegerField(default=0, label='评论量')
    is_delete = serializers.BooleanField(default=False, label='逻辑删除')
    # 外键关联
    author = serializers.PrimaryKeyRelatedField(read_only=True)

    # 多字段校验方法（评论数不得大于阅读量）
    def validate(self, attrs):
        read = attrs["read"]
        comment = attrs["comment"]
        if read > comment:
            # 条件为真，校验通过，直接返回值
            return attrs
        else:
            # 条件为假，校验不通过，设置异常信息
            raise serializers.ValidationError('评论数不得大于阅读量')
```

+ **传入合法数据**

```python
>>> from quickstart.serializers import BookInfoSerializer
>>> # 1.模拟前端json数据
>>> new_book = {
...     "name": "孙子兵法-1",
...     "releas_date": "2020-02-02",
...     "read": 10,
...     "comment": 5,
...     "author": 1
... }
>>> # 2.创建序列化器
>>> serializer = BookInfoSerializer(data=new_book)
>>> # 3.数据校验(如果校验不通过，提示详细信息)
>>> serializer.is_valid(raise_exception=True)
True
>>> # 4.输出校验结果(校验通过——serializer对象，校验不通过——原json数据)
>>> print(serializer.data)
{'name': '孙子兵法-1', 'releas_date': '2020-02-02', 'read': 10, 'comment': 5, 'is_delete': False}
```

+ **传入非法数据**（阅读数大于评论量）

```python
>>> from quickstart.serializers import BookInfoSerializer
>>> # 1.模拟前端json数据
>>> new_book = {
...     "name": "孙子兵法-1",
...     "releas_date": "2020-02-02",
...     "read": 10,
...     "comment": 15,
...     "author": 1
... }
>>> # 2.创建序列化器
>>> serializer = BookInfoSerializer(data=new_book)
>>> # 3.数据校验(如果校验不通过，提示详细信息)
>>> serializer.is_valid(raise_exception=True)
Traceback (most recent call last):
  File "<console>", line 1, in <module>
  File "/Users/cuiliang/PycharmProjects/tutorial/venv/lib/python3.9/site-packages/rest_framework/serializers.py", line 228, in is_valid
    raise ValidationError(self.errors)
rest_framework.exceptions.ValidationError: {'non_field_errors': [ErrorDetail(string='评论数不得大于阅读量', code='invalid')]}
>>> # 4.输出校验结果(校验通过——serializer对象，校验不通过——原json数据)
>>> print(serializer.data)
{'name': '孙子兵法-1', 'releas_date': '2020-02-02', 'read': 10, 'comment': 15}
```

## 二、数据入库
### 1. 数据创建
+ **序列化器中定义create方法**

```python
class BookInfoSerializer(serializers.Serializer):
    id = serializers.IntegerField(label='id', read_only=True)
    name = serializers.CharField(max_length=20, label='书名')
    releas_date = serializers.DateField(label='发布日期')
    read = serializers.IntegerField(default=0, label='阅读量')
    comment = serializers.IntegerField(default=0, label='评论量')
    is_delete = serializers.BooleanField(default=False, label='逻辑删除')
    # 外键关联
    author_id = serializers.IntegerField()

    # 实现数据创建的create方法
    def create(self, validated_data):
        # 创建book对象，创建将校验通过后的数据
        return BookInfo.objects.create(**validated_data)
```

+ **传入数据测试**

```python
>>> from quickstart.serializers import BookInfoSerializer
>>> 
>>> # 1.模拟前端json数据
>>> new_book = {
...     "name": "孙子兵法-1",
...     "releas_date": "2020-02-02",
...     "read": 10,
...     "comment": 5,
...     "author_id": 1
... }
>>> # 2.创建序列化器
>>> serializer = BookInfoSerializer(data=new_book)
>>> # 3.数据校验(如果校验不通过，提示详细信息)
>>> serializer.is_valid(raise_exception=True)
True
>>> # 4.数据入库
>>> serializer.save()
<BookInfo: 孙子兵法-1>
```

### 2. 数据更新
+ **序列化器中定义update方法**

```python
class BookInfoSerializer(serializers.Serializer):
    id = serializers.IntegerField(label='id', read_only=True)
    name = serializers.CharField(max_length=20, label='书名')
    releas_date = serializers.DateField(label='发布日期')
    read = serializers.IntegerField(default=0, label='阅读量')
    comment = serializers.IntegerField(default=0, label='评论量')
    is_delete = serializers.BooleanField(default=False, label='逻辑删除')
    # 外键关联
    author_id = serializers.IntegerField()

    # 实现数据创建的create方法
    def create(self, validated_data):
        # 创建book对象，创建将校验通过后的数据
        return BookInfo.objects.create(**validated_data)

    # 实现数据更新的update方法
    def update(self, instance, validated_data):
        # 更新数据
        instance.name = validated_data['name']
        instance.releas_date = validated_data['releas_date']
        instance.read = validated_data['read']
        instance.comment = validated_data['comment']
        instance.is_delete = validated_data['is_delete']
        instance.author_id = validated_data['author_id']
        # 入库
        instance.save()
        # 返回
        return instance
```

+ **传入数据测试**

```python
>>> from quickstart.models import BookInfo
>>> from quickstart.serializers import BookInfoSerializer
>>> # 1.模拟前端json数据
>>> new_book = {
...     "name": "孙子兵法-2",
...     "releas_date": "2020-02-02",
...     "read": 10,
...     "comment": 5,
...     "author_id": 1
... }
>>> # 2.获取更新对象
>>> book = BookInfo.objects.get(id=1)
>>> # 2.创建序列化器(将修改的对象序列化，并将传入数据反序列化)
>>> serializer = BookInfoSerializer(instance=book, data=new_book)
>>> # 3.数据校验(如果校验不通过，提示详细信息)
>>> serializer.is_valid(raise_exception=True)
True
>>> # 4.数据入库
>>> serializer.save()
<BookInfo: 孙子兵法-2>
```


