# 常用分析工具
<font style="color:rgb(62, 62, 62);">在排查es问题时，我们会使用一些常见的命令来分析cpu、io、网络等问题。常见的命令如下</font>

# iostat命令<font style="color:rgba(0, 0, 0, 0.9);"></font>
<font style="color:rgb(62, 62, 62);">我们这里按照1s的频率输出磁盘信息</font>

```plain
iostat -xd 1
```

+ <font style="color:rgb(62, 62, 62);">iops</font><font style="color:rgb(62, 62, 62);">由r/s(每秒读次数）和w/s(每秒写次数）组成。</font>
+ <font style="color:rgb(62, 62, 62);">await</font><font style="color:rgb(62, 62, 62);">平均IO等待时间，包括硬件处理IO的时间和在队列中的等待时间。</font>
+ <font style="color:rgb(62, 62, 62);">%util</font><font style="color:rgb(62, 62, 62);">设备的繁忙比</font><font style="color:rgb(62, 62, 62);">设备执行的I/O时间与所经过的时间百分比。当值接近100%时设备产生饱和。在设备具有并行处理能力的情况下，util达到100%不代表设备没有余力处理更多I/O请求。</font>

<font style="color:rgb(62, 62, 62);">如果想查看和进程关联的信息，可以使用pidstat或者iotop。</font>

<font style="color:rgb(62, 62, 62);">例如，下面为iotop的输出结果</font>

![](https://via.placeholder.com/800x600?text=Image+85b542cba37c5d4a)

# 内存<font style="color:rgba(0, 0, 0, 0.9);"></font>
<font style="color:rgb(62, 62, 62);">sar命令可以诊断操作系统内存相关情况。</font>

+ <font style="color:rgb(62, 62, 62);">sar -B</font><font style="color:rgb(62, 62, 62);">当系统物理内存不足时。系统回收效率对部署的es节点的性能有较大的影响。我们可以通过sar -B来观察内存分页信息</font>

![](https://via.placeholder.com/800x600?text=Image+5fee5c7959ae710f)

+ <font style="color:rgb(62, 62, 62);">pgfree/s</font><font style="color:rgb(62, 62, 62);">每秒被放入空闲列表中的页数，如果其他进程需要内存，则这些页可以被分页(paged out）。</font>
+ <font style="color:rgb(62, 62, 62);">pgscank/s</font><font style="color:rgb(62, 62, 62);">每秒被kswapd守护进程扫描的页数。</font>
+ <font style="color:rgb(62, 62, 62);">pgscand/s</font><font style="color:rgb(62, 62, 62);">每秒被直接扫描的页数。</font>
+ <font style="color:rgb(62, 62, 62);">pgsteal/s</font><font style="color:rgb(62, 62, 62);">为了满足内存需求，系统每秒从缓存（pagecache和swapcache）回收的页面数。</font>
+ <font style="color:rgb(62, 62, 62);">%vmeff</font><font style="color:rgb(62, 62, 62);">代表页面回收效率。</font><font style="color:rgb(62, 62, 62);">计算方式为：</font><font style="color:rgb(62, 62, 62);">pgsteal/(pgscand+pgscank)。</font><font style="color:rgb(62, 62, 62);">过低表明虚拟内存存在问题，如果在采样周期内没有发生页面扫描，则该值为0或接近100。</font><font style="color:rgb(62, 62, 62);">我们可以重点关注vmeff，当为0和接近100时说明内存够用，其它情况页面回收效率过低，内存也不够。</font>
+ <font style="color:rgb(62, 62, 62);">sar -w</font>

![](https://via.placeholder.com/800x600?text=Image+1be500bcccaa2148)

+ <font style="color:rgb(62, 62, 62);">pswpin/s</font><font style="color:rgb(62, 62, 62);">每秒换入交换页数量</font>
+ <font style="color:rgb(62, 62, 62);">pswpount/s</font><font style="color:rgb(62, 62, 62);">每秒换出交换页的数量</font>

**<font style="color:rgb(62, 62, 62);">PS：我们需要关闭内存交换，内存交换会严重损害性能</font>**<font style="color:rgb(62, 62, 62);">。</font>

# cpu<font style="color:rgba(0, 0, 0, 0.9);"></font>
<font style="color:rgb(62, 62, 62);">我们知道，操作系统有内核态和用户态，该命令可以输出相关信息</font>

+ <font style="color:rgb(62, 62, 62);">vmstat</font>

![](https://via.placeholder.com/800x600?text=Image+87c975a24afb1612)

+ <font style="color:rgb(62, 62, 62);">mpstat</font><font style="color:rgb(62, 62, 62);">用户级(usr）和内核级(sys）的CPU占用百分比</font><font style="color:rgb(62, 62, 62);">还可以输出采样周期内的软中断(soft)、硬中断（ irq）占用时间的百分比</font>

# ![](https://via.placeholder.com/800x600?text=Image+4448b7fbafeb8068)  
网络<font style="color:rgba(0, 0, 0, 0.9);"></font>
+ <font style="color:rgb(62, 62, 62);">sar -n DEV 1</font><font style="color:rgb(62, 62, 62);">sar是用来查看网卡流量的最常用方式，它以字节为单位输出网络传入和传出流量。</font>

![](https://via.placeholder.com/800x600?text=Image+ecb0d23bf2f6dd02)

+ <font style="color:rgb(62, 62, 62);">netstat -anp</font><font style="color:rgb(62, 62, 62);">统计了进程级别连接、监听的端口的信息。</font>

![](https://via.placeholder.com/800x600?text=Image+9eaa30e33c897be2)<font style="color:rgb(51, 51, 51);"></font>

<font style="color:rgb(62, 62, 62);">Recv-Q和Send-Q代表该连接在内核中等待发送和接收的数据长度。</font>

<font style="color:rgb(62, 62, 62);">如果改数据太多，可能原因为应用程序处理不及时或者对端的数据接收不及时，比如网络拥塞之类</font>


