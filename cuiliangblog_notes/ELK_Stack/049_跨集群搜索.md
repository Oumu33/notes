# 跨集群搜索
# 简介
跨集群搜索使你可以针对一个或多个远程集群运行单个搜索请求。 

例如，你可以使用跨集群搜索来筛选和分析存储在不同数据中心的集群中的日志数据。

**<font style="color:#F5222D;">重点：Remote clusters 的配置</font>**

远程集群（**<font style="color:#F5222D;">Remote clusters </font>**）的配置使你可以建立到远程集群的单向连接。 此功能用于跨集群复制和跨集群搜索。

# 操作实践
## 前提条件
至少两个以上的集群，每个集群的名称不一样，

+ 集群2信息

```json
[root@es-2 ~]# curl http://192.168.10.22:9200
{
  "name" : "node-2",
  "cluster_name" : "es-2",
  "cluster_uuid" : "cNfan6fMQlGqHlmAIcTzIA",
  "version" : {
    "number" : "7.13.4",
    "build_flavor" : "default",
    "build_type" : "rpm",
    "build_hash" : "c5f60e894ca0c61cdbae4f5a686d9f08bcefc942",
    "build_date" : "2021-07-14T18:33:36.673943207Z",
    "build_snapshot" : false,
    "lucene_version" : "8.8.2",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}
```

+ 集群3信息

```json
[root@es-3 elasticsearch]# curl 192.168.10.23:9200
{
  "name" : "node-3",
  "cluster_name" : "es-3",
  "cluster_uuid" : "CG36o0jcR22FUJZ6Ah7DZg",
  "version" : {
    "number" : "7.13.4",
    "build_flavor" : "default",
    "build_type" : "rpm",
    "build_hash" : "c5f60e894ca0c61cdbae4f5a686d9f08bcefc942",
    "build_date" : "2021-07-14T18:33:36.673943207Z",
    "build_snapshot" : false,
    "lucene_version" : "8.8.2",
    "minimum_wire_compatibility_version" : "6.8.0",
    "minimum_index_compatibility_version" : "6.0.0-beta1"
  },
  "tagline" : "You Know, for Search"
}
```

## 配置了xpack.security的集群认证
如果想做跨集群操作，也需要在一个集群生成证书和密钥，然后把密钥发到另一个集群。也就是说，9200端口访问认证走的是用户名密码。9300端口访问走的是证书密钥

## 集群使用相同的p12证书密钥
本地和远程集群使用相同的elastic-certificates.p12，实现集群互信，elasticsearch服务p12密钥配置文件如下。

```bash
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/elastic-certificates.p12
  truststore.path: certs/elastic-certificates.p12
```

## p12证书密钥生成
默认安装集群时每套集群自动生成不同的p12文件，无法知道默认keystore密码，要想实现集群相互信任，需要重新手动生成keystore并指定密码。

### 集群1重新生成keystore并指定密码
+ <font style="color:rgb(48, 49, 51);">集群1生成证书</font>

```bash
[root@es-1 ~]# cd /usr/share/elasticsearch/
[root@es-1 elasticsearch]# ./bin/elasticsearch-certutil ca
This tool assists you in the generation of X.509 certificates and certificate
signing requests for use with SSL/TLS in the Elastic stack.

The 'ca' mode generates a new 'certificate authority'
This will create a new X.509 certificate and private key that can be used
to sign certificate when running in 'cert' mode.

Use the 'ca-dn' option if you wish to configure the 'distinguished name'
of the certificate authority

By default the 'ca' mode produces a single PKCS#12 output file which holds:
* The CA certificate
* The CA's private key

If you elect to generate PEM format certificates (the -pem option), then the output will
be a zip file containing individual files for the CA certificate and private key

Please enter the desired output file [elastic-stack-ca.p12]: // 直接回车，使用默认路径即可
Enter password for elastic-stack-ca.p12 : // 输入密码，并记住它
```

+ <font style="color:rgb(48, 49, 51);">集群1查看证书</font>

```bash
[root@es-1 elasticsearch]# pwd
/usr/share/elasticsearch
[root@es-1 elasticsearch]# ls -la elastic-stack-ca.p12 
-rw------- 1 root root 2672 7月   9 23:14 elastic-stack-ca.p12
```

+ <font style="color:rgb(48, 49, 51);">集群1生成密钥</font>

```bash
[root@es-1 elasticsearch]# ./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12
This tool assists you in the generation of X.509 certificates and certificate
signing requests for use with SSL/TLS in the Elastic stack.

The 'cert' mode generates X.509 certificate and private keys.
    * By default, this generates a single certificate and key for use
       on a single instance.
    * The '-multiple' option will prompt you to enter details for multiple
       instances and will generate a certificate and key for each one
    * The '-in' option allows for the certificate generation to be automated by describing
       the details of each instance in a YAML file

    * An instance is any piece of the Elastic Stack that requires an SSL certificate.
      Depending on your configuration, Elasticsearch, Logstash, Kibana, and Beats
      may all require a certificate and private key.
    * The minimum required value for each instance is a name. This can simply be the
      hostname, which will be used as the Common Name of the certificate. A full
      distinguished name may also be used.
    * A filename value may be required for each instance. This is necessary when the
      name would result in an invalid file or directory name. The name provided here
      is used as the directory name (within the zip) and the prefix for the key and
      certificate files. The filename is required if you are prompted and the name
      is not displayed in the prompt.
    * IP addresses and DNS names are optional. Multiple values can be specified as a
      comma separated string. If no IP addresses or DNS names are provided, you may
      disable hostname verification in your SSL configuration.

    * All certificates generated by this tool will be signed by a certificate authority (CA)
      unless the --self-signed command line option is specified.
      The tool can automatically generate a new CA for you, or you can provide your own with
      the --ca or --ca-cert command line options.

By default the 'cert' mode produces a single PKCS#12 output file which holds:
    * The instance certificate
    * The private key for the instance certificate
    * The CA certificate

If you specify any of the following options:
    * -pem (PEM formatted output)
    * -keep-ca-key (retain generated CA key)
    * -multiple (generate multiple certificates)
    * -in (generate certificates from an input file)
then the output will be be a zip file containing individual certificate/key files

Enter password for CA (elastic-stack-ca.p12) :  // 输入密码
Please enter the desired output file [elastic-certificates.p12]: // 直接回车，使用默认路径
Enter password for elastic-certificates.p12 :   // 输入密码

Certificates written to /usr/share/elasticsearch/elastic-certificates.p12

This file should be properly secured as it contains the private key for 
your instance.

This file is a self contained file and can be copied and used 'as is'
For each Elastic product that you wish to configure, you should copy
this '.p12' file to the relevant configuration directory
and then follow the SSL configuration instructions in the product guide.

For client applications, you may only need to copy the CA certificate and
configure the client to trust this certificate.
```

+ <font style="color:rgb(48, 49, 51);">集群1查看密钥</font>

```bash
[root@es-1 elasticsearch]# pwd
/usr/share/elasticsearch
[root@es-1 elasticsearch]# ls -la elastic-certificates.p12 
-rw------- 1 root root 3596 7月   9 23:15 elastic-certificates.p12
```

### <font style="color:rgb(48, 49, 51);">将集群1密钥分发至其他集群并修改目录和权限（所有集群节点）</font>
+ <font style="color:rgb(48, 49, 51);">分发密钥文件</font>

```bash
[root@es-1 elasticsearch]# scp elastic-certificates.p12 192.168.10.22:/usr/share/elasticsearch
[root@es-1 elasticsearch]# scp elastic-certificates.p12 192.168.10.23:/usr/share/elasticsearch
```

+ <font style="color:rgb(48, 49, 51);">修改权限与目录</font>

```bash
[root@es-1 elasticsearch]# cp /usr/share/elasticsearch/elastic-certificates.p12 /etc/elasticsearch/
[root@es-1 elasticsearch]# chmod 644 /usr/share/elasticsearch/elastic-certificates.p12
[root@es-1 elasticsearch]# chmod 644 /etc/elasticsearch/elastic-certificates.p12
```

### <font style="color:rgb(48, 49, 51);">节点添加密码（所有节点）</font>
```bash
[root@es-1 elasticsearch]# ./bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
Enter value for xpack.security.transport.ssl.keystore.secure_password: // 输入密码
[root@es-1 elasticsearch]# ./bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password
Enter value for xpack.security.transport.ssl.truststore.secure_password: // 输入密码
```

### <font style="color:rgb(48, 49, 51);">启动es服务（所有节点）</font>
```bash
[root@es-1 elasticsearch]# systemctl start elasticsearch
[root@es-1 elasticsearch]# systemctl status elasticsearch
```

<font style="color:rgb(48, 49, 51);">启动后看日志(/var/log/elasticsearch/)，是否正常，若日志异常，则需要具体排查。通常是密钥权限不足或存放路径有问题导致。</font>

## 在每个集群设置remote cluster
在每个集群对应的 kibana dev-tool 配置如下信息。

+ 配置远程集群：包括当前集群cluster_one以及一起联合远程访问的集群 cluter_two。

```json
PUT _cluster/settings
{
  "persistent": {
    "cluster": {
      "remote": {
        "es-2": {
          "seeds": [
            "192.168.10.22:9300"
          ]
        },
        "es-3": {
          "seeds": [
            "192.168.10.23:9300"
          ]
        }
      }
    }
  }
}
```

## kibana验证
Stack Management——>Remote Clusters

![](https://via.placeholder.com/800x600?text=Image+592d01e09c414c6a)

### 插入测试数据
+ 在es-2集群插入如下数据：

```json
PUT remote_index/_doc/1
{
  "user":"tom"
}
PUT remote_index/_doc/2
{
  "user":"tom 02"
}
```

+ 在es-3集群插入如下数据：

```json
PUT remote_index/_doc/1
{
  "user":"tom"
}
PUT remote_index/_doc/2
{
  "user":"tom 03"
}
```

### 跨集群检索
+ cluster_one:twitter,cluster_two:twitter 形式是：集群名称：索引名称

```json
GET es-2:remote_index,es-3:remote_index/_search
{
  "query": {
    "match": {
      "user": "tom"
    }
  }
}
```

### 结果验证
```json
{
  "took" : 22,
  "timed_out" : false,
  "num_reduce_phases" : 3,
  "_shards" : {
    "total" : 2,
    "successful" : 2,
    "skipped" : 0,
    "failed" : 0
  },
  "_clusters" : {
    "total" : 2,
    "successful" : 2,
    "skipped" : 0
  },
  "hits" : {
    "total" : {
      "value" : 4,
      "relation" : "eq"
    },
    "max_score" : 0.21110919,
    "hits" : [
      {
        "_index" : "es-3:remote_index",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 0.21110919,
        "_source" : {
          "user" : "tom"
        }
      },
      {
        "_index" : "es-2:remote_index",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 0.21110919,
        "_source" : {
          "user" : "tom"
        }
      },
      {
        "_index" : "es-3:remote_index",
        "_type" : "_doc",
        "_id" : "2",
        "_score" : 0.160443,
        "_source" : {
          "user" : "tom 03"
        }
      },
      {
        "_index" : "es-2:remote_index",
        "_type" : "_doc",
        "_id" : "2",
        "_score" : 0.160443,
        "_source" : {
          "user" : "tom 02"
        }
      }
    ]
  }
}

```

可以看到，结果共4条，分别来自es-2和es-3集群。

## 文档
es跨集群搜索：[https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-cross-cluster-search.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-cross-cluster-search.html)

es远程集群：[https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-remote-clusters.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.13/modules-remote-clusters.html)




