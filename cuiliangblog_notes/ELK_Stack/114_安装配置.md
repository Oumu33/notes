# 安装配置
# 安装部署
## <font style="color:rgb(48, 49, 51);">下载安装rpm包</font>
```bash
[root@es-master ~]# wget https://artifacts.elastic.co/downloads/kibana/kibana-8.8.2-x86_64.rpm
[root@es-master ~]# rpm -ivh kibana-8.8.2-x86_64.rpm
warning: kibana-8.8.2-x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID d88e42b4: NOKEY
Verifying...                          ################################# [100%]
Preparing...                          ################################# [100%]
Updating / installing...
   1:kibana-8.8.2-1                   ################################# [100%]
Creating kibana group... OK
Creating kibana user... OK
Created Kibana keystore in /etc/kibana/kibana.keystore
/usr/lib/tmpfiles.d/elasticsearch.conf:1: Line references path below legacy directory /var/run/, updating /var/run/elasticsearch → /run/elasticsearch; please update the tmpfiles.d/ drop-in file accordingly.
```

## <font style="color:rgb(33, 37, 41);">为Kibana生成注册令牌</font>
```bash
[root@es-master ~]# /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana
eyJ2ZXIiOiI4LjguMiIsImFkciI6WyIxOTIuMTY4LjguNTo5MjAwIl0sImZnciI6IjYzMzI0ZDA1NjE4ZjkyNTBlZGQ0Y2Y0YTg3ZTAzZWU2YTM1YmMzYjEwNDE2OTFlODhhN2Q1MmY5ZmMyNDU5ZDQiLCJrZXkiOiJfa1hyWVlrQm1pLWREWEcxaTEtMjo2bDJqSzRCX1JCZWM3Qlo5VGtIdVZnIn0=
```

## kibana注册集群
```bash
[root@es-master ~]# /usr/share/kibana/bin/kibana-setup --enrollment-token eyJ2ZXIiOiI4LjguMiIsImFkciI6WyIxOTIuMTY4LjguNTo5MjAwIl0sImZnciI6IjYzMzI0ZDA1NjE4ZjkyNTBlZGQ0Y2Y0YTg3ZTAzZWU2YTM1YmMzYjEwNDE2OTFlODhhN2Q1MmY5ZmMyNDU5ZDQiLCJrZXkiOiJfa1hyWVlrQm1pLWREWEcxaTEtMjo2bDJqSzRCX1JCZWM3Qlo5VGtIdVZnIn0=

✔ Kibana configured successfully.

To start Kibana run:
  bin/kibana
```

## <font style="color:rgb(48, 49, 51);">修改kibana配置</font>
<font style="color:rgb(48, 49, 51);">从es8开始，kibana使用token注册连接es，kibana通过解析token可以获取到es的地址用户名和密码信息，因此在kibana配置文件中无需设置es地址与账号密码信息。</font>

```bash
[root@es-master ~]# vim /etc/kibana/kibana.yml
server.port: 5601
server.host: "0.0.0.0"
# kibana中文界面
i18n.locale: "zh-CN"
```

## <font style="color:rgb(48, 49, 51);">启动服务</font>
```bash
[root@es-master ~]# systemctl enable kibana
Created symlink /etc/systemd/system/multi-user.target.wants/kibana.service → /usr/lib/systemd/system/kibana.service.
[root@es-master ~]# systemctl start kibana
```

## <font style="color:rgb(48, 49, 51);">访问验证</font>
+ <font style="color:rgb(48, 49, 51);">登录kibana </font>[http://192.168.10.100:5601](http://192.168.10.21:5601/app/dev_tools#/console)

![](https://via.placeholder.com/800x600?text=Image+2d7eab670376eace)

# 账号密码方式连接ES
除了使用常用的token方式连接es外，kibana也可以使用账号密码方式连接es，配置如下

## 生成kibana_system用户密码
```bash
[elasticsearch@ES01 bin~]$ ./elasticsearch-reset-password -u kibana_system
dqqGysPzlz2hPg5VwcJs
```

## 修改kibana配置文件
```bash
[root@ELP-P-VM-KA ~]# su - kibana
[kibana@ELP-P-VM-KA ~]$ cd /opt/kibana/config/
[kibana@ELP-P-VM-KA ~]$ ls
kibana.yml  node.options
[kibana@ELP-P-VM-KA ~]$ vim kibana.yml
server.host: "0.0.0.0"
server.publicBaseUrl: "https://kibana.local.com"
server.ssl.enabled: true
server.ssl.certificate: /opt/kibana/config/certs/kibana.crt
server.ssl.key: /opt/kibana/config/certs/kibana.key
elasticsearch.hosts: ['https://ES01:9200','https://ES02:9200','https://ES03:9200']
elasticsearch.username: kibana_system
elasticsearch.password: dqqGysPzlz2hPg5VwcJs
elasticsearch.ssl.certificateAuthorities: [/opt/kibana/config/certs/ca.crt] # es证书
```

然后重启kibana即可。

# monitor异常处理
访问kibana的monitor时，会提示以下报错。

![](https://via.placeholder.com/800x600?text=Image+6e2d128e5f79ff65)

## 修改kibana配置并重启
```bash
[root@es-master ~]# vim /etc/kibana/kibana.yml
monitoring.ui.ccs.enabled: false
[root@es-master ~]# systemctl restart kibana
```

## 访问monitor页面验证
![](https://via.placeholder.com/800x600?text=Image+7606f9f0364942c1)

# kibana启用https
默认情况下kibana是http方式访问，在实际生产环境中通常需要修改为https方式。此时可选择申请公网tls证书或使用elasticsearch工具自签证书

## 生成kibana证书和私钥
```bash
[root@es-test ~]# cd /usr/share/elasticsearch/bin/
[root@es-test bin]# ./elasticsearch-certutil csr -name kibana-server -dns kibana.test.com, localhost
```

生成的证书仅仅可以供kibana.test.com及 localhost 使用。上面的命令将一个叫做 csr-bundle.zip 的文件。我们使用如下的命令来进行解压缩

```bash
[root@es-test bin]# cd ../
[root@es-test elasticsearch]# ls
LICENSE.txt  NOTICE.txt  README.asciidoc  bin  csr-bundle.zip  jdk  lib  modules  plugins
[root@es-test elasticsearch]# unzip csr-bundle.zip
```

## 拷贝证书至kibana目录下
```bash
[root@es-test elasticsearch]# pwd
/usr/share/elasticsearch
[root@es-test elasticsearch]# mv kibana-server /etc/kibana
```

## 生成crt文件
```bash
[root@es-test ~]# cd /etc/kibana/kibana-server/
[root@es-test kibana-server]# ls
kibana-server.csr  kibana-server.key
[root@es-test kibana-server]# openssl x509 -req -in kibana-server.csr -signkey kibana-server.key -out kibana-server.crt
Certificate request self-signature ok
subject=CN = kibana-server
[root@es-test kibana-server]# ls
kibana-server.crt  kibana-server.csr  kibana-server.key
```

## 修改Kibana配置
```yaml
[root@es-test kibana-server]# vim /etc/kibana/kibana.yml
server.publicBaseUrl: "https://kibana.test.com:5601"
server.ssl.enabled: true
server.ssl.certificate: /etc/kibana/kibana-server/kibana-server.crt
server.ssl.key: /etc/kibana/kibana-server/kibana-server.key
```

## 访问验证
![](https://via.placeholder.com/800x600?text=Image+42804df104f29581)

# Kibana修改端口为443
## 设置node进程特殊权限
<font style="color:rgb(33, 37, 41);">非 root 用户默认无法绑定到低于 1024 的端口。</font>

<font style="color:rgb(33, 37, 41);">但是，从内核 2.6.24 开始，可以使用 </font>setcap<font style="color:rgb(33, 37, 41);"> 命令为程序设置特定功能</font>

```bash
[root@es-test kibana-server]# setcap 'cap_net_bind_service=+ep' /usr/share/kibana/node/bin/node
[root@es-test kibana-server]# systemctl restart kibana
```

## 访问验证
![](https://via.placeholder.com/800x600?text=Image+40066be6992b2501)


