# 集群版本升级
# 准备工作
## <font style="color:rgb(48, 49, 51);">确定版本升级路线方案</font>
<font style="color:rgb(48, 49, 51);">要升级到哪个ES版本，我们就查看对应版本的升级操作文档，本案例以升级到最新8.11.3为例，官方文档参考地址：</font>[<font style="color:rgb(48, 49, 51);">https://www.elastic.co/guide/en/elastic-stack/8.11/upgrading-elastic-stack.html</font>](https://www.elastic.co/guide/en/elastic-stack/8.11/upgrading-elastic-stack.html)<font style="color:rgb(48, 49, 51);">  
</font><font style="color:rgb(48, 49, 51);">从官方文档可知，版本升级路线与操作如下：</font>

+ <font style="color:rgb(48, 49, 51);">对于8.X的版本，可直接升级。</font>
+ <font style="color:rgb(48, 49, 51);">对于7.X的版本，需要先升级到7.17.16，然后借助reindex 方式，实现再从7.17.16升级到8.11.3。</font>

## 下载指定版本的软件包
下载地址：[https://www.elastic.co/downloads/past-releases](https://www.elastic.co/downloads/past-releases)，提前下载elasticsearch、logstash、kibana、elastic agent

## <font style="color:rgb(48, 49, 51);">备份集群数据</font>
<font style="color:rgb(48, 49, 51);">在升级操作前，建议做好集群快照，以备不时之需。</font>

# <font style="color:rgb(48, 49, 51);">升级前配置操作</font>
## <font style="color:rgb(48, 49, 51);">禁用副本分片分配</font>
<font style="color:rgb(25, 27, 31);">多个节点的集群环境，当一个节点关闭后，相关的分片会重新分配，并产生大量的磁盘IO。</font>

```json
PUT _cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": "primaries"
  }
}
```

## <font style="color:rgb(48, 49, 51);">同步刷新，保证数据全部落盘</font>
<font style="color:rgb(25, 27, 31);">停止非必要的索引操作并执行同步刷新，分片恢复会快得多。</font>

```plain
POST /_flush
```

# 升级ES软件版本
依次对集群内每个ES节点进行操作

## 执行升级
```bash
# 停止elasticsearch服务
[root@ES01 ~]# systemctl stop elasticsearch
# 移走旧版软件包
[root@ES01 ~]# mv /opt/elasticsearch /opt/elasticsearch-8.10.4
# 解压新版软件包
[root@ES01 ~]# tar -zxvf elasticsearch-8.11.3-linux-x86_64.tar.gz
[root@ES01 ~]# mv elasticsearch-8.11.3 /opt/elasticsearch
# 拷贝替换config
[root@ES01 elasticsearch]# cd /opt/elasticsearch
[root@ES01 elasticsearch]# mv config config-back
[root@ES01 elasticsearch]# cp -R /opt/elasticsearch-8.10.4/config .
# 修改用户和用户组权限
[root@ES01 elasticsearch]# chown -R elasticsearch:elasticsearch /opt/elasticsearch
# 更新插件（例如安装了IK分词器插件）
[root@ES01 bin]# ./elasticsearch-plugin remove analysis-ik
[root@ES01 bin]# ./elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v8.11.3/elasticsearch-analysis-ik-8.11.3.zip
# 启动服务
[root@ES01 elasticsearch]# systemctl start elasticsearch
# 验证
[root@ES01 elasticsearch]# curl --cacert /opt/elasticsearch/config/certs/http_ca.crt https://elastic:xPO7p-Z2jg918nJYF16a@127.0.0.1:9200
{
  "name" : "ELP-T-VM-ES01",
  "cluster_name" : "elk-test",
  "cluster_uuid" : "1kxYdUPSQQqew-xbS8wwYQ",
  "version" : {
    "number" : "8.11.3",
    "build_flavor" : "default",
    "build_type" : "tar",
    "build_hash" : "64cf052f3b56b1fd4449f5454cb88aca7e739d9a",
    "build_date" : "2023-12-08T11:33:53.634979452Z",
    "build_snapshot" : false,
    "lucene_version" : "9.8.0",
    "minimum_wire_compatibility_version" : "7.17.0",
    "minimum_index_compatibility_version" : "7.0.0"
  },
  "tagline" : "You Know, for Search"
}
```

version已从原来的8.10.4升级为8.11.3，节点升级成功，接下来剩余es节点按相同步骤操作。

## 集群验证
1. <font style="color:rgb(48, 49, 51);">开启分片分配</font>

<font style="color:rgb(48, 49, 51);">待所有节点均升级成功并加入集群后，开启分片分配</font>

```json
PUT _cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": all
  }
}
```

2. 查看集群状态

```json
GET _cluster/health
GET _cat/nodes
```

# 升级Kibana版本
## 执行升级
```bash
# 停止kibana服务
[root@ES01 ~]# systemctl stop kibana
# 移走旧版软件包
[root@ES01 ~]# mv /opt/kibana /opt/kibana-8.10.4
# 解压新版软件包
[root@ES01 ~]# tar -zxvf kibana-8.11.3-linux-x86_64.tar.gz
[root@ES01 ~]# mv kibana-8.11.3 /opt/kibana
# 拷贝替换config
[root@ES01 kibana]# cd /opt/kibana
[root@ES01 kibana]# mv config config-back
[root@ES01 kibana]# cp -R /opt/kibana-8.10.4/config .
# 拷贝替换data
[root@ES01 kibana]# mv data data-back
[root@ES01 kibana]# cp -R /opt/kibana-8.10.4/data .
# 修改用户和用户组权限
[root@ES01 kibana]# chown -R kibana:kibana /opt/kibana
# 启动服务
[root@ES01 kibana]# systemctl start kibana
```

## 访问验证
![](https://via.placeholder.com/800x600?text=Image+58dd6da0f6218f98)

# 升级elastic agent版本
先升级fleet-server 再升级elastic-agent，使用kibana在线升级即可。

![](https://via.placeholder.com/800x600?text=Image+8c71d7afe10c610a)




