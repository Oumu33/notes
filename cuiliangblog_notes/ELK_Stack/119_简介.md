# 简介
# Fleet介绍
## Fleet是什么
从 7.13 开始，开始引入 Fleet Server。Fleet Server 是 Elastic Stack 的一个组件，用于集中管理 Elastic Agent。 它作为 Elastic Agent 的一部分在用作服务器的主机上启动。 一个 Fleet Server 进程可以支持多个 Elastic Agent 连接，并作为一个控制面来更新代理策略、收集状态信息和协调跨 Elastic Agent 的操作。

## Fleet组成
Fleet 是一个组件，用于在你的环境中管理 Elastic Agent 配置。 Fleet 由两部分组成：

+ Fleet UI 是一个带有用户界面的 Kibana 应用程序，供用户载入和配置代理、管理载入数据以及管理整个环境中的代理。
+ Fleet Server 是一个后端组件，你环境中的弹性代理可以连接到该组件，以检索代理策略、更新和管理命令。

Fleet Server 是 Elastic Agent 的一种特殊模式，可以与你的 Elastic Stack 部署一起集中部署。 你可以在负载平衡设置中配置 Fleet Server 的多个实例，以扩展性能并增加可用性。 Fleet Server 需要连接到支持 Elasticsearch 集群才能运行。

## Fleet架构
![](https://via.placeholder.com/800x600?text=Image+b56439447a199088)

1. 创建新的代理策略时，Fleet UI会将策略保存到Elasticsearch的Fleet索引中。
2. 注册策略时，Elastic Agents会向Fleet Server发送请求， 使用身份验证生成的注册密钥。
3. Fleet Server监控队列索引，从中获取新的代理策略然后Elasticsearch 将策略传送到在该策略中注册的所有Elastic Agents。 Fleet Server还可以将更新的策略写入Fleet index以进行管理代理之间的协调。
4. Elastic Agent使用策略中的配置信息来收集和发送数据到 Elasticsearch。
5. Elastic Agent会向队列服务器更新信息，保持打开状态连接。
6. 更新策略时，Fleet Server将从 Elasticsearch 并将其发送到连接的 Elastic Agent。

# 代理策略和集成
## 代理策略
代理策略，也就是 agent policy。集成有就是 integration。代理策略是一个 YAML 文件，它定义代理将收集并发送到 Elasticsearch（或其他受支持的目的地）的各种输入和设置。 当你在独立模式下使用 Elastic Agent 时，可以使用 /etc/elasticagent/elastic-agent.yml 文件配置策略。 当代理由 Fleet 管理时，策略会从 Elasticsearch 中检索并在代理启动时自动应用到代理。 Kibana 上的 Fleet 界面可用于创建和管理代理策略。 创建策略后，用户可以添加定义代理收集的数据源的集成。

## 代理策略架构
在 7.13 之前是这样的一种架构

![](https://via.placeholder.com/800x600?text=Image+a167b48f7991afc2)

在 7.13 及之后是这样的一种架构

![](https://via.placeholder.com/800x600?text=Image+39f5545d9f480d93)

## Fleet server代理策略优势
+ Scale：在之前的架构中，我们如果有1000个 agents，那么在 Kibana 中将会有1000个显示的 agent。通过改造之后，我们的 Kibana 将只会和 Fleet Server 进行交互。它可以支持更多的 agents。
+ Secuirty：它可以使得我们使用较少的访问权限。因为 Kibana 只需要和 Fleet Server 进行交互，Fleet Server 相比较而言，设计较为简单，而且它具有更少的访问权限。
+ More flexibility：给我们的部署带来更多的灵活性。你可以把你的 Fleet Server 安装在你的 agents 附近，而不需要 Kibana 安装于你的数据采集附近。

Fleet Server 是 Elastic Agent 用来与 Elasticsearch 通信的机制：

+ 创建新的代理策略后，它会保存到 Elasticsearch。
+ 为了注册该策略，Elastic Agents 使用为身份验证生成的注册密钥向 Fleet Server 发送请求。
+ Fleet Server 接收请求并从 Elasticsearch 获取代理策略，然后将该策略发送到在该策略中注册的所有 Elastic Agent。
+ Elastic Agent 使用策略中的配置信息来收集数据并将其发送到 Elasticsearch。
+ Fleet Server 会定期检查 Elastic Agent 的状态信息。
+ 当策略更新时，Fleet Server 从 Elasticsearch 检索更新的策略并将其发送到连接的 Elastic Agent。

Fleet Server 作为 Elastic Agent 内的子进程运行。Agent 使用描述 Fleet Server 配置的特殊策略。 在大规模 self-managed 部署或在 Elastic Cloud 上托管的 Elasticsearch 服务中，Fleet Server 通常作为专用的 Elastic Agent 通信主机运行，但你可以选择将其用于自我管理集群上的数据收集。

# Fleet与beats比较
## 数据采集
在 Fleet 出现之前，我们通过 Beats，Logstash 或 Fluentd 收集上来的数据是这样的

![](https://via.placeholder.com/800x600?text=Image+9af61138f8e66c21)

针对一些数据类型，比如 NGINX，它可能被不同的技术来进行收集，比如

![](https://via.placeholder.com/800x600?text=Image+4d61d54f446fcc41)

这样导致有关 NGINX 的信息分布于不同的索引之中，依赖于采集的技术不同。这对于我们分析有不利的一面。Elastic 在最新版本里的设计思想是无论 NGINX 是采用什么样的技术采集的，NGINX 的数据应该永远看起来是一样的。

我们通过 [Elastic Common Schema](https://www.elastic.co/guide/en/ecs/current/index.html) 及 Data stream naming scheme 来实现上述目的。

## 数据输出
![](https://via.placeholder.com/800x600?text=Image+b399a7af0ed31a6d)

目前fleet只支持输出到es和logstash，暂不支持消息队列。

## 对比
| beats | elastic agent |
| --- | --- |
| 需要为每个用例安装 beat | 适用于所有用例的单一代理 |
| 在命令行安装模块 | 从 Kibana UI 安装集成 |
| 需要手写/编辑 YAML 配置 | 从集成 UI 配置 |
| 无法向已安装的 beat 发送动作 | 中央、远程代理管理 |
| 或是所有开箱即用的 assets 或没有 | 选择要添加的集成 |
| 手动输入凭据（用户名及密码） | 自动生成的 ES API 密钥 |
| 边缘设备需要更高的 ES 权限 | 边缘设备所需的最低 ES 权限 |
| 具有大量字段的单个索引 | 生成具有更少字段的多个索引，并提高了查询性能 |


从安装的角度来说，Elastic agent 一个 agent 代替之前所有的 Beats

![](https://via.placeholder.com/800x600?text=Image+4c14f25cd8113fe5)


