# 聚合高级使用
## 作用范围
### query(默认范围，用查询结果生成聚合结果)
```json
# 获取birthday日期范围为2000年，按city字段分桶统计。
GET query_test/_search
{
  "query": {
    "range": {
      "birthday": {
        "gte": "2000-01-01",
        "lte": "2000-12-31"
      }
    }
  },
  "size": 0,
  "aggs": {
    "citys":{
      "terms": { 
        "field": "city.keyword"
      }
    }
  }
}
# 响应
{
  "took" : 7,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 2,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "citys" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "shang hai",
          "doc_count" : 1
        },
        {
          "key" : "shen zhen",
          "doc_count" : 1
        }
      ]
    }
  }
}
```

** 当设置size参数为0时，只返回聚合结果，当去掉size参数时，返回聚合结果和查询结果**

### filter(聚合前过滤条件)
为某个聚合分析设定过滤条件，从而在不更改整体 query 语句的情况下修改了作用范围

```json
# 过滤city为bei jing的文档，然后计算最小值
GET query_test/_search
{
  "size": 0,
  "aggs": {
    "city_bei_jing": {
      "filter": {
        "term": {
          "city.keyword": "bei jing"
        }
      },
      "aggs": {
        "min_age": {
          "min": {
            "field": "age"
          }
        }
      }
    }
  }
}
# 响应
{
  "took" : 4,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 6,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "city_bei_jing" : {
      "doc_count" : 2,
      "min_age" : {
        "value" : 2.0
      }
    }
  }
}
```

### post_filter(聚合后查询结果过滤，对聚合结果不影响)
```json
GET query_test/_search
{
  "aggs": {
    "citys": {
      "terms": {
        "field": "city.keyword"
      }
    }
  },
  "post_filter": {
    "term": {
      "city.keyword": "shen zhen"
    }
  }
}
# 响应
{
  "took" : 3,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 1,
      "relation" : "eq"
    },
    "max_score" : 1.0,
    "hits" : [
      {
        "_index" : "query_test",
        "_type" : "_doc",
        "_id" : "6",
        "_score" : 1.0,
        "_source" : {
          "id" : "6",
          "name" : "helen",
          "age" : 22,
          "email" : "query_test6@qq.com",
          "hobby" : "read music movie",
          "city" : "shen zhen",
          "birthday" : "2000-12-11"
        }
      }
    ]
  },
  "aggregations" : {
    "citys" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "bei jing",
          "doc_count" : 2
        },
        {
          "key" : "shang hai",
          "doc_count" : 2
        },
        {
          "key" : "nan jing",
          "doc_count" : 1
        },
        {
          "key" : "shen zhen",
          "doc_count" : 1
        }
      ]
    }
  }
}
```

## 排序
### 基于关键字排序
+ 基于_count排序

```json
# 按city字段分桶统计，并按_count数排序
GET query_test/_search
{
  "size": 0,
  "aggs": {
    "citys":{
      "terms": { 
        "field": "city.keyword",
        "order": {
          "_count": "asc"
        }
      }
    }
  }
}
# 响应
{
  "took" : 3,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 6,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "citys" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "nan jing",
          "doc_count" : 1
        },
        {
          "key" : "shen zhen",
          "doc_count" : 1
        },
        {
          "key" : "bei jing",
          "doc_count" : 2
        },
        {
          "key" : "shang hai",
          "doc_count" : 2
        }
      ]
    }
  }
}
```

+ 基于_key排序

```json
按city字段分桶统计，并按_key排序
GET query_test/_search
{
  "size": 0,
  "aggs": {
    "citys":{
      "terms": { 
        "field": "city.keyword",
        "order": {
          "_key": "asc"
        }
      }
    }
  }
}
# 响应
{
  "took" : 4,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 6,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "citys" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "bei jing",
          "doc_count" : 2
        },
        {
          "key" : "nan jing",
          "doc_count" : 1
        },
        {
          "key" : "shang hai",
          "doc_count" : 2
        },
        {
          "key" : "shen zhen",
          "doc_count" : 1
        }
      ]
    }
  }
}
```

### 基于子聚合排序
```json
# 按city分桶，计算每个桶的age字段平均值，然后按avg_age排序
GET query_test/_search
{
  "size": 0,
  "aggs": {
    "citys": {
      "terms": {
        "field": "city.keyword",
        "order": {
          "avg_age": "asc"
        }
      },
      "aggs": {
        "avg_age": {
          "avg": {
            "field": "age"
          }
        }
      }
    }
  }
}
# 响应
{
  "took" : 5,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 6,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "citys" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "shang hai",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.0
          }
        },
        {
          "key" : "bei jing",
          "doc_count" : 2,
          "avg_age" : {
            "value" : 17.5
          }
        },
        {
          "key" : "shen zhen",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 22.0
          }
        },
        {
          "key" : "nan jing",
          "doc_count" : 1,
          "avg_age" : {
            "value" : 41.0
          }
        }
      ]
    }
  }
}
```

### 基于子聚合多值排序
```json
# 按city分桶，计算每个桶的age字段分析值，然后按其中的sum_age排序
GET query_test/_search
{
  "size": 0,
  "aggs": {
    "citys": {
      "terms": {
        "field": "city.keyword",
        "order": {
          "stats_age.sum": "asc"
        }
      },
      "aggs": {
        "stats_age": {
          "stats": {
            "field": "age"
          }
        }
      }
    }
  }
}
# 响应
{
  "took" : 6,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 6,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [ ]
  },
  "aggregations" : {
    "citys" : {
      "doc_count_error_upper_bound" : 0,
      "sum_other_doc_count" : 0,
      "buckets" : [
        {
          "key" : "shen zhen",
          "doc_count" : 1,
          "stats_age" : {
            "count" : 1,
            "min" : 22.0,
            "max" : 22.0,
            "avg" : 22.0,
            "sum" : 22.0
          }
        },
        {
          "key" : "shang hai",
          "doc_count" : 2,
          "stats_age" : {
            "count" : 2,
            "min" : 12.0,
            "max" : 22.0,
            "avg" : 17.0,
            "sum" : 34.0
          }
        },
        {
          "key" : "bei jing",
          "doc_count" : 2,
          "stats_age" : {
            "count" : 2,
            "min" : 2.0,
            "max" : 33.0,
            "avg" : 17.5,
            "sum" : 35.0
          }
        },
        {
          "key" : "nan jing",
          "doc_count" : 1,
          "stats_age" : {
            "count" : 1,
            "min" : 41.0,
            "max" : 41.0,
            "avg" : 41.0,
            "sum" : 41.0
          }
        }
      ]
    }
  }
}
```


