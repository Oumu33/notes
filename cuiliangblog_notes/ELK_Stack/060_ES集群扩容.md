# ES集群扩容

> 来源: ELK Stack
> 创建时间: 2024-12-27T11:29:05+08:00
> 更新时间: 2026-01-11T09:26:40.645834+08:00
> 阅读量: 179 | 点赞: 0

---

随着 es 数据不断增多，就需要进行扩容和架构调整操作，以下为具体步骤。

# ES 集群扩容
## 部署 ES
具体步骤参考前文，此处不在赘述。

## 检查集群状态
在集群中验证新节点是否加入：

```bash
curl -XGET "http://<master-ip>:9200/_cat/nodes?v"
```

您应该能够看到新节点的 `node.name` 和角色。

## 数据平衡
扩容后，集群会自动重新分配分片到新节点，但可能需要手动调整：

## 检查分片分布
```bash
curl -XGET "http://<master-ip>:9200/_cat/shards?v"
```

## 手动触发分片重新分配（可选）
如果分片未正确分配，可手动触发重新平衡：

```bash
curl -XPOST "http://<master-ip>:9200/_cluster/reroute"
```

## 调整索引模板分片数
具体可参考前文，此处不再赘述。

# ES 节点角色更换
例如之前是 3 台 master+data 节点，现在又扩容 3 台 data 节点，想要将原来的 master+data 节点转为仅 master 节点。

## 状态检查
使用以下命令检查集群和节点的健康状态，确保所有节点正常运行：

```bash
curl -XGET "http://<master-ip>:9200/_cat/nodes?v"
curl -XGET "http://<master-ip>:9200/_cluster/health?pretty"
```

列出所有索引和分片分布：

```bash
curl -XGET "http://<master-ip>:9200/_cat/shards?v"
```

## 禁止分片分配到当前节点
在需要转换角色的 `master+data` 节点上，临时设置为不允许接收分片分配：

```bash
curl -XPUT "http://<master-ip>:9200/_cluster/settings" -H 'Content-Type: application/json' -d'
{
  "transient": {
    "cluster.routing.allocation.exclude._name": "<node-name>"
  }
}'
```

其中，`<node-name>` 是该节点的名称（例如 `node-1`）。  
执行后，Elasticsearch 会将该节点上的分片迁移到其他可用的 `data` 节点。

## 等待分片迁移完成
使用以下命令监控分片迁移状态：

```bash
curl -XGET "http://<master-ip>:9200/_cat/health?v"
curl -XGET "http://<master-ip>:9200/_cat/shards?v"
```

确保目标节点上的分片状态全部为 `STARTED`。

## 调整角色配置
1. 停止 ElasticSearch 服务
2. 修改`elasticsearch.yml` 配置文件，将 `node.roles` 设置为仅 `master`：

```plain
node.roles: ["master","ingest"]
```

3. 备份旧分片数据，清空原数据目录。

```bash
 mv /var/lib/elasticsearch/nodes/0/indices/* /data/es-indices/
```

4. 启动 Elasticsearch 服务


