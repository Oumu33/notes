# 跨集群复制
## 基本概念
### 什么是跨集群复制
<font style="color:rgb(52, 55, 65);">跨集群复制（</font>Cross-cluster replication，简称：CCR<font style="color:rgb(52, 55, 65);">）指的是：索引数据从一个 Elasticsearch 集群复制到另一个 Elasticsearch 集群。</font>

<font style="color:rgb(52, 55, 65);">对于主集群的索引数据的任何修改都会直接复制到从索引集群。</font>

### <font style="color:rgb(52, 55, 65);">跨集群复制好处</font>
+ 支持灾难恢复（DR）、确保高可用性（HA）

跨集群复制确保了不间断的服务可用性，<font style="color:rgb(52, 55, 65);">能够承受住数据中心或区域服务中断的影响，降低了复杂性、节省了成本</font>。

+ 降低延迟

将数据复制到更靠近应用程序用户的集群可以最大限度地减少查询延迟。

+ 水平可扩展性

跨多个副本集群拆分查询繁重的工作负载可提高应用程序可用性。

+ 集中式汇报

企业客户可以将属于不同业务线的较小集群（数百个分支银行中心）中的报告不断汇总到一个中央集群（大型全球银行）中，以用于整合报告、方便可视化呈现。

### 关于高可用
+ 副本的目的是高可用，集群的快照和恢复和功能是高可用，怎么又来个跨集群复制呢？

副本主要体现在分片层面，可以看做分片的复制，一般集群至少设置一个副本，当主副本故障时，副本分片会提升为主分片。

+ 快照和恢复主要体现在：集群级别和索引层面，可以全量或者增量。但，做不到实时备份和恢复。

也就是说，快照会设定一个时间间隔，比如每5分钟备份一次。

当集群出现故障需要恢复时，极有可能会少备份最近5分钟的数据，

综上，才会有了跨集群复制的概念。

### 核心概念
![](https://via.placeholder.com/800x600?text=Image+de29af27113e50d4)

跨集群复制使用主动-被动模型（active-passive model）。

数据索引到一个领导者索引（leader index），并且数据被复制到一个或多个只读跟随者索引（read-only follower indices）。 在向集群添加跟随者索引之前，必须配置包含领导者索引的远程集群。

leader-follower 模式在 kafka、zookeeper等中都有涉及，我认为翻译为：主、从比较契合。

核心释义解读如下：

+ active-passive model：主动-被动模型。
+ leader index：主索引或领导者索引。
+ read-only follower indices：从索引或跟随者索引。

## 操作实践
### 准备工作
+ 激活license

![](https://via.placeholder.com/800x600?text=Image+e81ff5dfb035942d)

+ 准备至少2个集群

![](https://via.placeholder.com/800x600?text=Image+729ce4e6d6758e88)

+ xpack设置为true，并设置账号密码，集群1生成证书，然后复制到集群2并导入证书。



### 设置跨集群复制
+ 从集群设置 remote cluster

```json
PUT /_cluster/settings
{
  "persistent": {
    "cluster": {
      "remote": {
        "leader": {
          "seeds": [
            "192.168.10.21:9300"
          ]
        }
      }
    }
  }
}
# 查看是否设置成功
GET /_remote/info
{
  "leader" : {
    "connected" : true,
    "mode" : "sniff",
    "seeds" : [
      "192.168.10.21:9300"
    ],
    "num_nodes_connected" : 1,
    "max_connections_per_cluster" : 3,
    "initial_connect_timeout" : "30s",
    "skip_unavailable" : false
  }
}
```

+ 主集群添加角色，给read和monitor权限即可。

```json
POST /_security/role/remote-replication
{
  "cluster": [
    "read_ccr"
  ],
  "indices": [
    {
      "names": [
        "leader-index-name"
      ],
      "privileges": [
        "monitor",
        "read"
      ]
    }
  ]
}
```

+ 从集群添加角色，给读写，监控，跟随权限

```json
POST /_security/role/remote-replication
{
  "cluster": [
    "manage_ccr"
  ],
  "indices": [
    {
      "names": [
        "follower-index-name"
      ],
      "privileges": [
        "monitor",
        "read",
        "write",
        "manage_follow_index"
      ]
    }
  ]
}
```

### 创建自动跟踪模式以自动跟踪在远程集群中定期创建的索引（从集群设置）
+ 创建follower index

![](https://via.placeholder.com/800x600?text=Image+b25f15f8e929dd02)

+ 配置ollower index。
+ <font style="color:rgb(0, 0, 0);">Remote cluster， 从集群对leader 的设置。</font>
+ <font style="color:rgb(0, 0, 0);">Leader index，主集群的索引。</font>
+ <font style="color:rgb(0, 0, 0);">Follower index，从集群的索引名称，与 Leader index 是一一对应的关系，是从 Leader 索引复制过来的数据。</font>

![](https://via.placeholder.com/800x600?text=Image+26a62d3d04e206b3)

+ 执行成功后如下所示

![](https://via.placeholder.com/800x600?text=Image+e401f02f7361017e)

### 结果验证
+ 检查同步是否成功

```json
GET /kibana_sample_data_logs_from_leader/_ccr/stats
{
  "indices" : [
    {
      "index" : "kibana_sample_data_logs_from_leader",
      "shards" : [
        {
          "remote_cluster" : "leader",
          "leader_index" : "kibana_sample_data_logs",
          "follower_index" : "kibana_sample_data_logs_from_leader",
          "shard_id" : 0,
          "leader_global_checkpoint" : 14073,
          "leader_max_seq_no" : 14073,
          "follower_global_checkpoint" : 14073,
          "follower_max_seq_no" : 14073,
          "last_requested_seq_no" : 14073,
          "outstanding_read_requests" : 1,
          "outstanding_write_requests" : 0,
          "write_buffer_operation_count" : 0,
          "write_buffer_size_in_bytes" : 0,
          "follower_mapping_version" : 2,
          "follower_settings_version" : 2,
          "follower_aliases_version" : 1,
          "total_read_time_millis" : 0,
          "total_read_remote_exec_time_millis" : 0,
          "successful_read_requests" : 0,
          "failed_read_requests" : 0,
          "operations_read" : 0,
          "bytes_read" : 0,
          "total_write_time_millis" : 0,
          "successful_write_requests" : 0,
          "failed_write_requests" : 0,
          "operations_written" : 0,
          "read_exceptions" : [ ],
          "time_since_last_read_millis" : 24369
        }
      ]
    }
  ]
}
```

+ 主集群删除三条记录

```json
GET kibana_sample_data_logs/_search
{
  "query": {
    "match_all": {}
  }
}
POST kibana_sample_data_logs/_delete_by_query
{
  "query":{
    "terms":{
      "_id":[
        "x9hrKIIBjwKi58joWycZ",
        "yNhrKIIBjwKi58joWycZ",
        "ydhrKIIBjwKi58joWycZ"
      ]
    }
  }
}
GET kibana_sample_data_logs/_count
# 响应
{
  "count" : 14071,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  }
}
```

+ 从集群查看

```json
GET /kibana_sample_data_logs_from_leader/_count
{
  "count" : 14071,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  }
}
```

## 跨集群复制常用命令清单
包含但不限于：检查复制进度、暂停和恢复复制、重新创建跟随者索引和终止复制。

### 检查复制进度
```json
GET /kibana_sample_data_logs_from_leader/_ccr/stats
```

![](https://via.placeholder.com/800x600?text=Image+0eabfe4fffb31be6)

### 暂停和恢复复制
![](https://via.placeholder.com/800x600?text=Image+5b312b570aa1ddd7)

```plain
POST kibana_sample_data_logs_from_leader/_ccr/pause_follow
POST kibana_sample_data_logs_from_leader/_ccr/resume_follow
```

### 重新创建跟随者索引
分三步骤：

```plain
#暂停
POST /follower_index/_ccr/pause_follow
#关闭
POST /follower_index/_close?wait_for_active_shards=0
#重建
PUT /follower_index/_ccr/follow?wait_for_active_shards=1
{
"remote_cluster" : "remote_cluster",
"leader_index" : "leader_index"
}
```

### 终止复制
需要先暂停、然后关闭，最后终止复制。



POST kibana_sample_data_logs_from_leader/_ccr/unfollow

![](https://via.placeholder.com/800x600?text=Image+3453662aad97e7c3)

## 参考文档
es跨集群复制[https://www.elastic.co/guide/en/elasticsearch/reference/current/xpack-ccr.html](https://www.elastic.co/guide/en/elasticsearch/reference/current/xpack-ccr.html)


