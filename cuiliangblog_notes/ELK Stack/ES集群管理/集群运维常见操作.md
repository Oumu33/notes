# 集群运维常见操作

> 分类: ELK Stack > ES集群管理
> 更新时间: 2026-01-10T23:33:37.691363+08:00

---

## 集群调整
### 1. 节点间分片移动
```json
POST /_cluster/reroute
{
  "commands": [
    {
      "move": {
        "index": "indexname",
        "shard": 1,
        "from_node": "nodename",
        "to_node": "nodename"
      }
    }
  ]
}
```

### 2. 集群节点下线
保证集群颜色绿色的前提下，将某个节点优雅下线。

```json
PUT /_cluster/settings {
  "transient": {
     "cluster.routing.allocation.exclude._ip": "122.5.3.55"
   }
}
```

### 3. 强制刷新
刷新索引是确保当前仅存储在事务日志中的所有数据也永久存储在Lucene索引中。

```json
POST /_flush
```

### 4. 更改并发分片的数量以平衡集群
控制在集群范围内允许多少并发分片重新平衡。默认值为2。

```json
PUT /_cluster/settings
{
   "transient": {
     "cluster.routing.allocation.cluster_concurrent_rebalance": 2
   }
 }
```

### 5. 更改每个节点同时恢复的分片数量
如果节点已从集群断开连接，则其所有分片将都变为未分配状态。经过一定的延迟后，分片将分配到其他位置。每个节点要恢复的并发分片数由该设置确定。

```json
PUT /_cluster/settings
{
  "transient": {
     "cluster.routing.allocation.node_concurrent_recoveries": 6
   }
}
```

### 6. 调整恢复速度
为了避免集群过载，Elasticsearch限制了分配给恢复的速度。你可以仔细更改该设置，以使其恢复更快。

如果此值调的太高，则正在进行的恢复可能会消耗过多的带宽和其他资源，这可能会使集群不稳定

```json
 PUT /_cluster/settings
 {
   "transient": {
    "indices.recovery.max_bytes_per_sec": "80mb"
  }
}
```

### 7. 清除节点上的缓存
如果节点达到较高的JVM值，则可以在节点级别上调用该API 以使 Elasticsearch 清理缓存。这会降低性能，但可以使你摆脱OOM（内存不足）的困扰。

```json
POST /_cache/clear
```

### 8. 调整断路器
为了避免在Elasticsearch中进入OOM，可以调整断路器上的设置。这将限制搜索内存，并丢弃所有估计消耗比所需级别更多的内存的搜索。

```json
PUT /_cluster/settings
{
  "persistent": {
    "indices.breaker.total.limit": "40%"
  }
}
```

## 集群迁移
### 1. 对部分索引使用reindex
```json
POST _reindex
{
  "source": {
    "index": "my-index-000001"
  },
  "dest": {
    "index": "my-new-index-000001"
  }
}
```

### 2. 使用第三方工具进行集群迁移
+ elasticdump
+ elasticsearch-migration

工具本质：scroll + bulk 实现。

## 集群备份恢复
适用场景：高可用业务场景，定期增量、全量数据备份，以备应急不时之需。

```json
PUT /_snapshot/my_backup/snapshot_hamlet_index?wait_for_completion=true
 {
   "indices": "hamlet_*",
   "ignore_unavailable": true,
   "include_global_state": false,
   "metadata": {
     "taken_by": "mingyi",
     "taken_because": "backup before upgrading"
  }
 }
 
 POST /_snapshot/my_backup/snapshot_hamlet_index/_restore
```

