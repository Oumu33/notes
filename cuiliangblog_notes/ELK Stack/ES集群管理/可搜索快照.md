# 可搜索快照

> 分类: ELK Stack > ES集群管理
> 更新时间: 2026-01-10T23:33:37.346397+08:00

---

## 简介
### 快照
Elasticsearch拥有副本机制来保障集群的高可用，但无法解决如下的数据丢失

+ 主副本所在的机器存储全部损坏
+ 误删除索引数据
+ 升级失败，数据无法回滚

一般高可用的场景：除了副本至少设置为1，还要定期设置增量快照 snapshot。

设置快照的好处就在于：当集群故障时，即便数据丢失，也能通过快照的方式及时恢复。  
Elasticsearch提供了Snapshot和Restore API用于对集群数据完成备份与恢复

+ 数据备份的过程可以简单理解成将本地数据文件同步到远程仓库(repository)的过程
+ 支持全量和增量备份
+ repository常见也有如下类型：fs / S3 / HDFS / Azure / Google Cloud Storage

### 什么是可搜索快照
早期的快照就是“死数据”，是不支持搜索的，但这种使用频次非常低的数据也是有搜索需求的。使用时将很久之前的“冷”数据以快照方式存储（副本设置为0，节约存储），当需要检索的时候，再由快照恢复到索引，实现检索。

可搜索快照是指使用快照以极具成本效益的方式搜索不常访问的只读数据。冷数据层和冻结数据层（ cold and frozen data tiers ）使用可搜索的快照来降低存储和运营成本。

可搜索快照消除了对副本分片的需求（副本默认设置为0），会将搜索数据所需的本地存储减半。可搜索快照依赖于已用于备份的相同快照机制，并保障对快照存储库存储成本的影响最小。

### 适用场景
可搜索快照非常适合管理大量历史归档数据。

历史信息的搜索频率通常低于最近的数据，因此可能不需要副本以获得性能优势。

对于更复杂或耗时的搜索，你可以将**异步搜索**与可搜索快照结合使用。

### 特点
平衡存储成本

管理数据生命周期

跳过手动恢复

## 创建快照与恢复
+ 在elasticsearch中配置文件中添加远程仓库地址

```json
path.repo: "/www/elasticsearch/backup" 
```

+ 注册快照存储库

```json
# 创建备份数据仓库
PUT /_snapshot/my_fs_backup
{
    "type": "fs",
    "settings": {
        "location": "/www/elasticsearch/backup"
    }
}
```

+ 为指定索引创建快照

```json
# 创建数据快照
// snapshot_1：快照名称
// wait_for_completion：等待操作完成
PUT /_snapshot/my_backup/snapshot_1?wait_for_completion=true
{
  "indices": "index_1", // 操作的index
  "ignore_unavailable": true, // 忽略不可用
  "include_global_state": false // 包括全局状态
}
```

+ 恢复备份数据

```json

# 查看已创建的备份数据仓库
GET /_snapshot/my_backup


# 恢复备份数据
POST /_snapshot/my_fs_backup/snapshot_1/_restore
{
  "indices": "index_1",
  "ignore_unavailable": true,
  "include_global_state": false,
  "rename_pattern": "(.+)",
  "rename_replacement": "restored_$1"
}
```

## 将快照挂载为可搜索的快照索引
### 索引挂载到本地
**重中之重**：要搜索快照，必须首先将其作为索引挂载到本地

```json
POST /_snapshot/my_repositor/snapshot_docs_index/_mount?wait_for_completion=true 
{
  "index": "my_docs", // 必须设置，要挂载数据的快照中包含的索引的名称。如果renamed_index不设置，该 index 将用以创建新索引。 
  "renamed_index": "docs", // 可选，将创建的索引的名称。
  "index_settings": { // 挂载时应添加到索引中的设置
    "index.number_of_replicas": 0
  },
  "ignored_index_settings": [ // 挂载时应从索引中删除的设置。 	
    "index.refresh_interval"
  ]
} 
# 执行结果
{
  "snapshot" : {
    "snapshot" : "snapshot_docs_index",
    "indices" : [
      "docs"
    ],
    "shards" : {
      "total" : 1,
      "failed" : 0,
      "successful" : 1
    }
  }
}
```

这里的 my_docs 是快照里面的索引，不是外层的索引，也就是说：把 my_docs 索引（非快照里）删除，上面的挂载操作照样可以运行。

### 执行快照搜索
```json
GET docs/_search 
```

## 基于ILM实现自动挂载快照
### 注册快照存储库（即设置存储路径）
+ 在elasticsearch中配置文件中添加远程仓库地址

```json
path.repo: "/www/elasticsearch/backup" 
```

+ 注册快照存储库

```json
# 创建备份数据仓库
PUT /_snapshot/my_fs_backup
{
    "type": "fs",
    "settings": {
        "location": "/www/elasticsearch/backup"
    }
}
```

### 设置ilm policy
```json
# cold 阶段设置可搜索快照
PUT _ilm/policy/my_custom_policy_filter
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_age": "3d",
            "max_docs": 5,
            "max_size": "50gb"
          },
          "set_priority": {
            "priority": 100
          }
        }
      },
      "warm": {
        "min_age": "15s",
        "actions": {
          "forcemerge": {
            "max_num_segments": 1
          },
          "allocate": {
            "require": {
              "box_type": "warm"
            },
            "number_of_replicas": 0
          },
          "set_priority": {
            "priority": 50
          }
        }
      },
      "cold": {
        "min_age": "20s",
        "actions": {
          "allocate": {
            "require": {
              "box_type": "cold"
            },
            "number_of_replicas": 0
          },
          "searchable_snapshot": {
            "snapshot_repository": "my_repository" // 填写快照存储库地址
          }
        }
      }
    }
  }
}
```

### 创建模板，关联配置的ilm_policy
```json
PUT _index_template/timeseries_template
{
  "index_patterns": ["timeseries-*"],                 
  "template": {
    "settings": {
      "number_of_shards": 1,
      "number_of_replicas": 0,
      "index.lifecycle.name": "my_custom_policy_filter",      
      "index.lifecycle.rollover_alias": "timeseries",
      "index.routing.allocation.require.box_type": "hot"
    }
  }
}
```

cold 阶段：原来的timeseries-000001不再存在，形成可搜索快照。索引名称前面加了前缀：restored-*，之前的索引名称变成了别名。

相比于手动实现，不需要人为实现挂载环节，ILM自动后台实现。

## 可搜索快照的工作原理
当从快照挂载索引时，Elasticsearch 将其分片分配给集群内的数据节点。然后，数据节点根据指定的挂载选项自动从存储库检索相关分片数据到本地存储。如果可能，搜索使用本地存储中的数据。如果数据在本地不可用，Elasticsearch 会从快照存储库找它需要的数据。



如果持有这些分片之一的节点出现故障，Elasticsearch 会自动将受影响的分片分配到另一个节点上，并且该节点从存储库中恢复相关的分片数据。不需要副本，也不需要复杂的监控或处理来恢复丢失的分片。



尽管默认情况下可搜索快照索引没有副本，但仍可以通过调整 index.number_of_replicas 将副本添加到这些索引中。可搜索快照分片的副本通过从快照存储库复制数据来恢复，就像可搜索快照分片的主分片一样。相比之下，常规索引的副本是通过从主数据库复制数据来恢复的。

## 如何区分正常索引和可搜索快照索引
+  ILM 实现的话，看名字，前缀为：restored_*。 	
+  手动实现的场景的确不多，自己控制就可以，也可以参考ILM 的实现，设置 renamed_index 的名称。

## 参考文档
es备份集群[https://www.elastic.co/guide/en/elasticsearch/reference/7.13/backup-cluster.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.13/backup-cluster.html)

es快照与恢复[https://www.elastic.co/guide/en/elasticsearch/reference/7.13/snapshot-restore.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.13/snapshot-restore.html)

es注册快照存储仓库[https://www.elastic.co/guide/en/elasticsearch/reference/7.13/snapshots-register-repository.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.13/snapshots-register-repository.html)

基于ilm挂载快照[https://www.elastic.co/guide/en/elasticsearch/reference/7.13/ilm-searchable-snapshot.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.13/ilm-searchable-snapshot.html)

快照索引挂载到本地[https://www.elastic.co/guide/en/elasticsearch/reference/7.13/searchable-snapshots-api-mount-snapshot.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.13/searchable-snapshots-api-mount-snapshot.html)

