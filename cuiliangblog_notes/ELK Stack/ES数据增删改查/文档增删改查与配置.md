# 文档增删改查与配置

> 分类: ELK Stack > ES数据增删改查
> 更新时间: 2026-01-10T23:33:34.158751+08:00

---

## 创建文档
### 创建指定id的文档
> 当创建文档时，如果index不存在，会自动创建index
>

```json
# 请求
PUT /test_index/_doc/1
{
  "username": "alex",
  "age": 30
}
# 响应
{
  "_index" : "test_index",
  "_type" : "_doc",
  "_id" : "1",
  "_version" : 1,
  "result" : "created",
  "_shards" : {
    "total" : 2,
    "successful" : 2,
    "failed" : 0
  },
  "_seq_no" : 0,
  "_primary_term" : 1
}
```

### 创建不指定id的文档
```json
# 请求
POST /test_index/_doc
{
  "username" : "join",
  "age" : 20
}
# 响应
{
  "_index" : "test_index",
  "_type" : "_doc",
  "_id" : "-mDiHYAB813_dBaikTbP",
  "_version" : 1,
  "result" : "created",
  "_shards" : {
    "total" : 2,
    "successful" : 2,
    "failed" : 0
  },
  "_seq_no" : 1,
  "_primary_term" : 1
}
```

## 查看文档
### 查看指定id的文档
```json
# 请求
GET /test_index/_doc/1
# 响应
{
  "_index" : "test_index",
  "_type" : "_doc",
  "_id" : "1",
  "_version" : 1,
  "_seq_no" : 0,
  "_primary_term" : 1,
  "found" : true,
  "_source" : {
    "username" : "alex",
    "age" : 30
  }
}
```

### 查看指定条件的文档(参考query DSL)
## 更新文档
```plain
POST test/_doc/1/_update
{
    "doc" : {
        "name" : "new_name"
    }
}
```

## 删除文档
### 删除指定ID的文档
+ <font style="color:rgb(33, 37, 41);">从</font>kibana_sample_data_logs<font style="color:rgb(33, 37, 41);">索引中删除 id为</font>rEfZ7IEBOwIK7Ec9c3Ph的<font style="color:rgb(33, 37, 41);">文档</font>

```json
# 请求
DELETE /kibana_sample_data_logs/_doc/rEfZ7IEBOwIK7Ec9c3Ph
# 响应
{
  "_index" : "kibana_sample_data_logs",
  "_type" : "_doc",
  "_id" : "rEfZ7IEBOwIK7Ec9c3Ph",
  "_version" : 2,
  "result" : "deleted",
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "failed" : 0
  },
  "_seq_no" : 14078,
  "_primary_term" : 1
}
```

### 删除指定条件的文档
+ 删除index_name中message字段包含some message的文档

```json
POST index_name/_delete_by_query
{
  "query": { //这些是自定义查询条件，根据查询条件去批量删除
    "match": {//请求体跟Search API是一样的
      "message": "some message"
    }
  }
}
```

## 批量操作（bulk）
es 允许一次操作多个文档，从而减少网络传输开销，提升写入速率

### 指令格式
bulk操作和以往的普通请求格式有区别。指令一般都在一行，用换行符隔开，不是标准的JSON格式。

```json
POST _bulk
{action: {metadata}} \n
{request body} \n
{action: {metadata}} \n
{request body} \n
……
```

+ {action: {metadata}} 代表批量操作的类型，可以是新增、删除和修改
+ \n 是每行结尾必须填写的一个规范，每一行包括最后一行都需要写，用于es的解析
+ {request body} 是请求body，增加和修改操作需要，删除操作则不需要

### action选项
+ create：如果文档不存在，那么就创建它，存在的话，就会报错，发生异常报错不会影响其他操作
+ index：创建一个新文档或者替换一个现有的文档
+ update：部分更新一个文档
+ delete：删除一个文档

metadata 中需要指定要操作的文档的 _index、_type 和 _id，同时_index、_type也可在url中指定

### 批量create
+ metadata指定index

```json
# 请求
POST _bulk
{"create":{"_index": "test","_type": "_doc","_id": "2001"}}
{"id": "2001","nickname":"test-2001"}
{"create":{"_index": "test","_type": "_doc","_id": "2002"}}
{"id": "2002","nickname":"test-2002"}
{"create":{"_index": "test","_type": "_doc","_id": "2003"}}
{"id": "2003","nickname":"test-2003"}
# 响应
{
  "took" : 137,                // 操作耗时
  "errors" : false,
  "items" : [                  // 每个bulk操作返回结果
    {
      "create" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2001",
        "_version" : 1,
        "result" : "created",
        "_shards" : {
          "total" : 5,
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 0,
        "_primary_term" : 1,
        "status" : 201
      }
    },
    {
      "create" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2002",
        "_version" : 1,
        "result" : "created",
        "_shards" : {
          "total" : 5,
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 0,
        "_primary_term" : 1,
        "status" : 201
      }
    },
    {
      "create" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2003",
        "_version" : 1,
        "result" : "created",
        "_shards" : {
          "total" : 5,
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 1,
        "_primary_term" : 1,
        "status" : 201
      }
    }
  ]
}
```

+ url指定index

```json
# 请求
POST /test/_doc/_bulk
{"create":{"_id": "2004"}}
{"id": "2004","nickname":"test-2004"}
{"create":{"_id": "2005"}}
{"id": "2005","nickname":"test-2005"}
{"create":{"_id": "2006"}}
{"id": "2006","nickname":"test-2006"}
# 响应
{
  "took" : 9,
  "errors" : true,
  "items" : [
    {
      "create" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2004",
        "_version" : 1,
        "result" : "created",
        "_shards" : {
          "total" : 5,
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 1,
        "_primary_term" : 1,
        "status" : 201
      }
    },
    {
      "create" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2005",
        "status" : 409,
        "error" : {
          "type" : "version_conflict_engine_exception",
          "reason" : "[2005]: version conflict, document already exists (current version [1])",
          "index_uuid" : "kSssALKqQAK1IYZHfeeECQ",
          "shard" : "0",
          "index" : "test"
        }
      }
    },
    {
      "create" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2006",
        "status" : 409,
        "error" : {
          "type" : "version_conflict_engine_exception",
          "reason" : "[2006]: version conflict, document already exists (current version [1])",
          "index_uuid" : "kSssALKqQAK1IYZHfeeECQ",
          "shard" : "1",
          "index" : "test"
        }
      }
    }
  ]
}
```

### 批量index
```json
# 请求
POST /test/_doc/_bulk
{"index":{"_id": "2005"}}
{"id": "2005","nickname":"test-index"}
{"index":{"_id": "2006"}}
{"id": "2006","nickname":"test-2006"}
{"index":{"_id": "2007"}}
{"id": "2007","nickname":"test-2007"}
# 响应
{
  "took" : 11,
  "errors" : false,
  "items" : [
    {
      "index" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2005",
        "_version" : 1,
        "result" : "created",
        "_shards" : {
          "total" : 5,
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 0,
        "_primary_term" : 1,
        "status" : 201
      }
    },
    {
      "index" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2006",
        "_version" : 1,
        "result" : "created",
        "_shards" : {
          "total" : 5,
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 2,
        "_primary_term" : 1,
        "status" : 201
      }
    },
    {
      "index" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2007",
        "_version" : 1,
        "result" : "created",
        "_shards" : {
          "total" : 5,
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 1,
        "_primary_term" : 1,
        "status" : 201
      }
    }
  ]
}
```

### 批量update
```json
# 请求
POST /test/_doc/_bulk
{"update":{"_id": "2004"}}
{"doc": {"id": "2004"}}
{"update":{"_id": "2005"}}
{"doc": {"nickname":"test-update"}}
# 响应
{
  "took" : 32,
  "errors" : false,
  "items" : [
    {
      "update" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2004",
        "_version" : 1,
        "result" : "noop",
        "_shards" : {
          "total" : 5,
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 1,
        "_primary_term" : 1,
        "status" : 200
      }
    },
    {
      "update" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2005",
        "_version" : 2,
        "result" : "updated",
        "_shards" : {
          "total" : 5,
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 2,
        "_primary_term" : 1,
        "status" : 200
      }
    }
  ]
}
```

### 批量delete
```json
# 请求
POST /test/_doc/_bulk
{"delete":{"_id": "2004"}}
{"delete":{"_id": "2005"}}
# 响应
{
  "took" : 9,
  "errors" : false,
  "items" : [
    {
      "delete" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2004",
        "_version" : 2,
        "result" : "deleted",
        "_shards" : {
          "total" : 5,
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 3,
        "_primary_term" : 1,
        "status" : 200
      }
    },
    {
      "delete" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2005",
        "_version" : 3,
        "result" : "deleted",
        "_shards" : {
          "total" : 5,
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 4,
        "_primary_term" : 1,
        "status" : 200
      }
    }
  ]
}
```

### 批量混合操作
+ metadata指定index

```json
# 请求
POST _bulk
{"create":{"_index": "test","_type": "_doc","_id": "2009"}}
{"id": "2009","nickname":"test-2009"}
{"update":{"_index": "test","_type": "_doc","_id": "2005"}}
{"doc": {"nickname":"test-update"}}
{"delete":{"_index": "test","_type": "_doc","_id": "2005"}}
# 响应
{
  "took" : 9,
  "errors" : true,
  "items" : [
    {
      "create" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2009",
        "status" : 409,
        "error" : {
          "type" : "version_conflict_engine_exception",
          "reason" : "[2009]: version conflict, document already exists (current version [1])",
          "index_uuid" : "kSssALKqQAK1IYZHfeeECQ",
          "shard" : "1",
          "index" : "test"
        }
      }
    },
    {
      "update" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2005",
        "status" : 404,
        "error" : {
          "type" : "document_missing_exception",
          "reason" : "[_doc][2005]: document missing",
          "index_uuid" : "kSssALKqQAK1IYZHfeeECQ",
          "shard" : "0",
          "index" : "test"
        }
      }
    },
    {
      "delete" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2005",
        "_version" : 1,
        "result" : "not_found",
        "_shards" : {
          "total" : 5,
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 5,
        "_primary_term" : 1,
        "status" : 404
      }
    }
  ]
}
```

+ url指定index

```json
# 请求
POST /test/_doc/_bulk
{"create":{"_id": "2009"}}
{"id": "2009","nickname":"test-2009"}
{"update":{"_id": "2005"}}
{"doc": {"nickname":"test-update"}}
{"delete":{"_id": "2005"}}
# 响应
{
  "took" : 8,
  "errors" : true,
  "items" : [
    {
      "create" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2009",
        "status" : 409,
        "error" : {
          "type" : "version_conflict_engine_exception",
          "reason" : "[2009]: version conflict, document already exists (current version [1])",
          "index_uuid" : "kSssALKqQAK1IYZHfeeECQ",
          "shard" : "1",
          "index" : "test"
        }
      }
    },
    {
      "update" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2005",
        "status" : 404,
        "error" : {
          "type" : "document_missing_exception",
          "reason" : "[_doc][2005]: document missing",
          "index_uuid" : "kSssALKqQAK1IYZHfeeECQ",
          "shard" : "0",
          "index" : "test"
        }
      }
    },
    {
      "delete" : {
        "_index" : "test",
        "_type" : "_doc",
        "_id" : "2005",
        "_version" : 1,
        "result" : "not_found",
        "_shards" : {
          "total" : 5,
          "successful" : 2,
          "failed" : 0
        },
        "_seq_no" : 6,
        "_primary_term" : 1,
        "status" : 404
      }
    }
  ]
}
```

## 批量查询（mget）
```json
# 请求
GET /_mget
{
  "docs": [
    {
      "_index": "test_index",
      "_type": "_doc",
      "_id": "1"
    },
    {
      "_index": "test_index",
      "_type": "_doc",
      "_id": "2"
    }
  ]
}
# 响应
{
  "docs" : [
    {
      "_index" : "test_index",
      "_type" : "_doc",
      "_id" : "1",
      "_version" : 1,
      "_seq_no" : 0,
      "_primary_term" : 1,
      "found" : true,
      "_source" : {
        "username" : "alex",
        "age" : 30
      }
    },
    {
      "_index" : "test_index",
      "_type" : "_doc",
      "_id" : "2",
      "_version" : 1,
      "_seq_no" : 2,
      "_primary_term" : 1,
      "found" : true,
      "_source" : {
        "username" : "tom",
        "age" : 10
      }
    }
  ]
}
```

## 参考文档
es 文档操作文档：[https://www.elastic.co/guide/en/elasticsearch/reference/7.13/docs.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.13/docs.html)

es删除文档：[https://www.elastic.co/guide/en/elasticsearch/reference/7.13/docs-delete.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.13/docs-delete.html)

