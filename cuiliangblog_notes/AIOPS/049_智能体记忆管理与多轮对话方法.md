# æ™ºèƒ½ä½“è®°å¿†ç®¡ç†ä¸å¤šè½®å¯¹è¯æ–¹æ³•

> æ¥æº: AIOPS
> åˆ›å»ºæ—¶é—´: 2025-09-14T09:20:37+08:00
> æ›´æ–°æ—¶é—´: 2026-01-11T09:45:35.092181+08:00
> é˜…è¯»é‡: 676 | ç‚¹èµ: 0

---

è¦å®ç°å¤šè½®å¯¹è¯ï¼Œæ ¸å¿ƒé—®é¢˜æ˜¯ å¦‚ä½•ä¿å­˜ä¸Šä¸‹æ–‡è®°å¿†ï¼Œè®©æ™ºèƒ½ä½“å¯¹ç”¨æˆ·å†å²è¾“å…¥æœ‰â€œè®°å¿†â€ï¼Œèƒ½å¤Ÿæ ¹æ®å†å²æ¶ˆæ¯è®°å½•å›ç­”é—®é¢˜ã€‚

# è®°å¿†æ¨¡å‹ä¸å…³é”®ç»„ä»¶
## çŸ­æœŸè®°å¿†ï¼ˆCheckpointerï¼‰
è½½ä½“ï¼šCheckpointerï¼ˆMemorySaverã€RedisSaverã€PostgresSaverâ€¦ï¼‰  
ä½œç”¨ï¼šæŠŠæ¯è½®æ¶ˆæ¯ + å·¥å…·è°ƒç”¨ç»“æœåºåˆ—åŒ–æˆå›¾çŠ¶æ€ï¼ŒæŒ‰ `thread_id` æŒä¹…åŒ–ï¼›ä¸‹æ¬¡ä¼ å…¥ç›¸åŒ `thread_id` è‡ªåŠ¨ç»­å†™ã€‚

åŸç†ï¼š

+ æ¯æ¬¡ä½ è°ƒç”¨ `graph.invoke(...)` æˆ– `graph.stream(...)`ï¼ŒLangGraph éƒ½ä¼šç»´æŠ¤ä¸€ä¸ªçŠ¶æ€ï¼ˆstateï¼‰ã€‚
+ å¦‚æœæ²¡æœ‰ Checkpointerï¼Œè¿™ä¸ª state é»˜è®¤åªå­˜åœ¨æœ¬æ¬¡è°ƒç”¨å†…ï¼Œè°ƒç”¨ç»“æŸå°±ä¸¢æ‰äº†ã€‚
+ å¦‚æœå¯ç”¨äº† Checkpointerï¼Œå®ƒä¼šæŠŠ state ä¿å­˜åˆ°å­˜å‚¨ä¸­ï¼ˆå†…å­˜/æ•°æ®åº“/æ–‡ä»¶ï¼‰ï¼Œä¸‹æ¬¡ç»§ç»­è°ƒç”¨æ—¶ï¼Œå¯ä»¥æ¢å¤ä¹‹å‰çš„ stateï¼Œå®ç°â€œè®°å¿†â€ã€‚

## é•¿æœŸè®°å¿†ï¼ˆBaseStoreï¼‰
è½½ä½“ï¼šBaseStoreï¼ˆInMemoryStoreã€RedisStoreã€AsyncPostgresStoreâ€¦ï¼‰  
ä½œç”¨ï¼šæ˜¾å¼ä¿å­˜â€œç”¨æˆ·åå¥½â€â€œèƒŒæ™¯äº‹å®â€ç­‰é«˜å¯†åº¦ä¿¡æ¯ï¼Œç”± LLM ä¸»åŠ¨è¯»å†™ï¼›Store æ”¯æŒå‘é‡æ£€ç´¢ï¼Œæ”¯æŒå‘½åç©ºé—´éš”ç¦»ã€‚

å’Œ **Checkpointer** çš„åŒºåˆ«ï¼š

+ Checkpointerï¼šä¿å­˜å›¾çš„è¿è¡ŒçŠ¶æ€ï¼ˆçŸ­æœŸè®°å¿†ï¼Œä¸»è¦ç”¨äºåŒä¸€ä¸ªçº¿ç¨‹è¿ç»­å¯¹è¯ï¼‰ã€‚
+ Storeï¼šLangGraph çš„å­˜å‚¨æ¨¡å—æä¾›æŒä¹…åŒ–çš„é”®å€¼å­˜å‚¨ï¼Œæ”¯æŒè·¨çº¿ç¨‹å’Œä¼šè¯çš„é•¿æœŸå†…å­˜ï¼Œé€‚ç”¨äºéœ€è¦æŒä¹…åŒ–æ•°æ®çš„å¤æ‚å·¥ä½œæµã€‚

## æ¶ˆæ¯è£å‰ªï¼ˆ Trimmingï¼‰
å½“å†å²æ¶ˆæ¯è¿‡é•¿æ—¶ï¼Œå¯åœ¨ `pre_model_hook` é‡Œæ’å…¥ `trim_messages` ç­–ç•¥ï¼ŒæŒ‰æœ€è¿‘ _N æ¡æ¶ˆæ¯_ æˆ– _Token æ•°_ ä¿ç•™ï¼Œè¶…å‡ºéƒ¨åˆ†ä¸¢å¼ƒã€‚è¿™ç§åšæ³•çš„ä¼˜ç‚¹æ˜¯ï¼šç®€å•ã€å¯æ§ï¼Œä¿è¯ä¸Šä¸‹æ–‡é•¿åº¦ä¸è¶…é™ã€‚ä½†ç¼ºç‚¹æ˜¯ï¼šå®¹æ˜“ä¸¢å¤±é•¿å¯¹è¯ä¸­çš„é‡è¦ä¿¡æ¯ã€‚

## æ¶ˆæ¯æ€»ç»“ï¼ˆSummarization ï¼‰
é€šè¿‡ç”Ÿæˆæ‘˜è¦æ¥â€œå‹ç¼©â€å†å²ï¼Œé¿å… token çˆ†ç‚¸ã€‚

+ å®šæœŸæ€»ç»“ï¼šæ¯å¯¹è¯ X è½®ï¼ŒæŠŠæ—§æ¶ˆæ¯åˆå¹¶æˆä¸€æ®µæ‘˜è¦ï¼Œå†å­˜å…¥ memoryï¼Œæ–°çš„ä¸Šä¸‹æ–‡é‡Œåªä¿ç•™æ‘˜è¦ + æœ€è¿‘æ¶ˆæ¯ã€‚
+ é€’å½’æ€»ç»“ï¼šå¯¹æ‘˜è¦å†ç»§ç»­æ€»ç»“ï¼Œå½¢æˆåˆ†å±‚ç»“æ„ï¼ˆåƒæ ‘çŠ¶è®°å¿†ï¼‰ã€‚
+ è§’è‰²åˆ†æ®µæ€»ç»“ï¼šæ¯”å¦‚åªæ€»ç»“ç”¨æˆ·è¾“å…¥ï¼Œç³»ç»Ÿæˆ– AI å›å¤ä¸åšæ‘˜è¦ã€‚
+ ä¼˜ç‚¹ï¼šå†å²ä¸ä¼šä¸¢å¤±ï¼Œåªæ˜¯è¢«å‹ç¼©æˆæ›´çŸ­çš„æ‘˜è¦ã€‚
+ ç¼ºç‚¹ï¼šæ‘˜è¦è´¨é‡ä¾èµ– LLMï¼Œå¯èƒ½ä¸¢ç»†èŠ‚ã€‚

# ä»£ç æ¼”ç¤º
## é¢„æ„å»º Agent å®ç°è®°å¿†å­˜å‚¨
```python
import dotenv
from langchain_ollama import ChatOllama
from langgraph.checkpoint.memory import InMemorySaver
from langgraph.prebuilt import create_react_agent

# åŠ è½½ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶
dotenv.load_dotenv()

# åˆå§‹åŒ–æœ¬åœ°å¤§è¯­è¨€æ¨¡å‹ï¼Œæ¨¡å‹åç§°å’Œæ¨ç†æ¨¡å¼
llm = ChatOllama(model="qwen3:14b", reasoning=False)

# å®šä¹‰å·¥å…·åˆ—è¡¨ï¼Œ
tools = []
# å®šä¹‰çŸ­æœŸè®°å¿†ä½¿ç”¨å†…å­˜ï¼ˆç”Ÿäº§å¯ä»¥æ¢ RedisSaver/PostgresSaverï¼‰
checkpointer = InMemorySaver()
# åˆ›å»ºReActä»£ç†ï¼Œç»“åˆè¯­è¨€æ¨¡å‹å’Œå·¥å…·å‡½æ•°
agent = create_react_agent(model=llm, tools=tools, checkpointer=checkpointer)
# å¤šè½®å¯¹è¯é…ç½®ï¼ŒåŒä¸€ thread_id å³åŒä¸€ä¼šè¯
config = {"configurable": {"thread_id": "user-001"}}

msg1 = agent.invoke({"messages": [("user", "ä½ å¥½ï¼Œæˆ‘å«å´”äº®ï¼Œå–œæ¬¢å­¦ä¹ ã€‚")]}, config)
msg1["messages"][-1].pretty_print()

# 6. ç¬¬äºŒè½®ï¼ˆç»§ç»­åŒä¸€ threadï¼‰
msg2 = agent.invoke({"messages": [("user", "æˆ‘å«ä»€ä¹ˆï¼Ÿæˆ‘å–œæ¬¢åšä»€ä¹ˆï¼Ÿ")]}, config)
msg2["messages"][-1].pretty_print()
```

æ‰§è¡Œç»“æœå¦‚ä¸‹

```python
================================== Ai Message ==================================

ä½ å¥½å´”äº®ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼å­¦ä¹ æ˜¯ä¸€ä¸ªéå¸¸æ£’çš„è¿½æ±‚ï¼Œä¸çŸ¥é“ä½ æœ€è¿‘åœ¨å­¦ä¹ ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿæ˜¯æœ‰ä»€ä¹ˆç‰¹åˆ«æ„Ÿå…´è¶£çš„é¢†åŸŸå—ï¼ŸğŸ˜Š

================================== Ai Message ==================================

ä½ å«å´”äº®ï¼Œä½ å–œæ¬¢å­¦ä¹ ã€‚ğŸ˜Š

å¦‚æœä½ æ„¿æ„çš„è¯ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘ä½ å…·ä½“å¯¹å“ªäº›æ–¹é¢æ„Ÿå…´è¶£ï¼Œæ¯”å¦‚æ˜¯å­¦ä¹ æ–°æŠ€èƒ½ã€é˜…è¯»ã€è¿˜æ˜¯å…¶ä»–ä»€ä¹ˆï¼Ÿæˆ‘å¾ˆä¹æ„å’Œä½ ä¸€èµ·æ¢è®¨ï¼

```

## åº•å±‚ API å®ç°è®°å¿†å­˜å‚¨
å®šä¹‰ä¸€ä¸ªèŠå¤©æœºå™¨äººèŠ‚ç‚¹å‡½æ•° chatbotï¼Œå®ƒæ¥æ”¶åŒ…å«æ¶ˆæ¯å†å²çš„ stateï¼Œè°ƒç”¨æœ¬åœ°å¤§è¯­è¨€æ¨¡å‹ llm ç”Ÿæˆå›å¤ï¼Œå¹¶è¿”å›æ–°æ¶ˆæ¯ã€‚è¯¥å‡½æ•°è¢«é›†æˆåˆ°ä¸€ä¸ªåŸºäºå›¾ç»“æ„çš„å¯¹è¯æµç¨‹ä¸­ï¼Œæ”¯æŒå¤šè½®å¯¹è¯å¹¶ä¿æŒä¸Šä¸‹æ–‡ã€‚

ä»£ç å¦‚ä¸‹

```bash
from typing import TypedDict, Annotated
from langgraph.checkpoint.memory import MemorySaver
from langgraph.constants import START, END
from langgraph.graph import StateGraph
from langgraph.graph.message import add_messages
from langchain_ollama import ChatOllama

class State(TypedDict):
    """
    å®šä¹‰å›¾ç»“æ„ä¸­èŠ‚ç‚¹é—´ä¼ é€’çš„çŠ¶æ€ç»“æ„

    Attributes:
        messages: æ¶ˆæ¯åˆ—è¡¨ï¼Œä½¿ç”¨add_messageså‡½æ•°è¿›è¡Œåˆå¹¶
    """
    messages: Annotated[list, add_messages]

# åˆ›å»ºçŠ¶æ€å›¾æ„å»ºå™¨
graph_builder = StateGraph(State)

# åˆå§‹åŒ–æœ¬åœ°å¤§è¯­è¨€æ¨¡å‹ï¼Œé…ç½®åŸºç¡€URLã€æ¨¡å‹åç§°å’Œæ¨ç†æ¨¡å¼
llm = ChatOllama(base_url="http://localhost:11434", model="qwen3:14b", reasoning=False)

def chatbot(state: State):
    """
    èŠå¤©æœºå™¨äººèŠ‚ç‚¹å‡½æ•°ï¼Œå¤„ç†è¾“å…¥æ¶ˆæ¯å¹¶ç”Ÿæˆå›å¤

    Args:
        state (State): åŒ…å«æ¶ˆæ¯å†å²çš„çŠ¶æ€å­—å…¸

    Returns:
        dict: åŒ…å«æ–°ç”Ÿæˆæ¶ˆæ¯çš„å­—å…¸ï¼Œæ ¼å¼ä¸º{"messages": [å›å¤æ¶ˆæ¯]}
    """
    return {"messages": [llm.invoke(state["messages"])]}

# å°†èŠå¤©æœºå™¨äººèŠ‚ç‚¹æ·»åŠ åˆ°å›¾ä¸­
graph_builder.add_node("chatbot", chatbot)

# æ·»åŠ ä»å¼€å§‹èŠ‚ç‚¹åˆ°èŠå¤©æœºå™¨äººèŠ‚ç‚¹çš„è¾¹
graph_builder.add_edge(START, "chatbot")

# æ·»åŠ ä»èŠå¤©æœºå™¨äººèŠ‚ç‚¹åˆ°ç»“æŸèŠ‚ç‚¹çš„è¾¹
graph_builder.add_edge("chatbot", END)

# åˆ›å»ºå†…å­˜ä¿å­˜å™¨ç”¨äºä¿å­˜å¯¹è¯çŠ¶æ€
memory = MemorySaver()

# ç¼–è¯‘å›¾ç»“æ„å¹¶è®¾ç½®æ£€æŸ¥ç‚¹ä¿å­˜å™¨
graph = graph_builder.compile(checkpointer=memory)

# ç»˜åˆ¶å›¾ç»“æ„å¹¶ä¿å­˜ä¸ºPNGå›¾ç‰‡
graph.get_graph().draw_png('./graph.png')

# é…ç½®å¯¹è¯çº¿ç¨‹ID
config = {"configurable": {"thread_id": "chat-1"}}

# ç¬¬ä¸€æ¬¡å¯¹è¯ï¼šå‘é€åˆå§‹æ¶ˆæ¯
msg1 = graph.invoke({"messages": ["ä½ å¥½ï¼Œæˆ‘å«å´”äº®ï¼Œå–œæ¬¢å­¦ä¹ ã€‚"]}, config=config)
msg1["messages"][-1].pretty_print()

# ç¬¬äºŒæ¬¡å¯¹è¯ï¼šåŸºäºä¸Šä¸‹æ–‡è¯¢é—®ç”¨æˆ·ä¿¡æ¯
msg2 = graph.invoke({"messages": ["æˆ‘å«ä»€ä¹ˆï¼Ÿæˆ‘å–œæ¬¢åšä»€ä¹ˆï¼Ÿ"]}, config=config)
msg2["messages"][-1].pretty_print()

```

æ‰§è¡Œç»“æœå¦‚ä¸‹

```bash
================================== Ai Message ==================================

ä½ å¥½å´”äº®ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼ğŸ˜Š ä½ å¯¹å­¦ä¹ çš„çƒ­çˆ±çœŸçš„å¾ˆæ£’ï¼Œè¿™ç§æ€åº¦ä¼šè®©ä½ åœ¨å¾ˆå¤šé¢†åŸŸéƒ½å–å¾—ä¸é”™çš„æˆå°±ã€‚ä¸çŸ¥é“ä½ æœ€è¿‘åœ¨å­¦ä¹ ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿå¦‚æœæœ‰ä»»ä½•é—®é¢˜æˆ–è€…æƒ³è®¨è®ºçš„è¯é¢˜ï¼Œæˆ‘å¾ˆä¹æ„å’Œä½ äº¤æµï¼

================================== Ai Message ==================================

ä½ å«**å´”äº®**ï¼Œä½ å–œæ¬¢**å­¦ä¹ **ã€‚ğŸ˜Š

å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äºè‡ªå·±çš„äº‹æƒ…ï¼Œæˆ–è€…æƒ³æ¢ç´¢æ–°çš„å…´è¶£ï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€èµ·èŠèŠï¼

```

## é•¿æœŸè®°å¿†+è·¨çº¿ç¨‹å¬å›
æ•´ä½“å®ç°æ­¥éª¤ä¸ºï¼š

1. åˆå§‹åŒ–ä¸€ä¸ª `InMemoryStore`ï¼ˆæˆ– `RedisStore`ï¼‰ã€‚
2. æŠŠâ€œè®°å¿†å·¥å…·â€å¡è¿›æ™ºèƒ½ä½“å·¥å…·ç®±ï¼Œè®© LLM è‡ªå·±å†³å®šä½•æ—¶å­˜/å–ã€‚
3. å‘½åç©ºé—´æŒ‰ `user_id` éš”ç¦»ï¼Œé˜²æ­¢ç”¨æˆ·æ•°æ®ä¸²çº¿ã€‚

```python
import uuid
from typing import TypedDict, Annotated
import dotenv
from langchain_ollama import ChatOllama
from langchain_core.runnables import RunnableConfig
from langgraph.constants import END, START
from langgraph.graph import StateGraph, MessagesState, add_messages
from langgraph.checkpoint.memory import InMemorySaver
from langgraph.store.memory import InMemoryStore
from langgraph.store.base import BaseStore

# åŠ è½½ç¯å¢ƒå˜é‡é…ç½®
dotenv.load_dotenv()
# åˆå§‹åŒ–æœ¬åœ°å¤§è¯­è¨€æ¨¡å‹ï¼Œé…ç½®æ¨¡å‹åç§°å’Œæ¨ç†æ¨¡å¼
model = ChatOllama(model="qwen3:14b", reasoning=False)


class State(TypedDict):
    """
    å®šä¹‰å›¾ä¸­çŠ¶æ€çš„æ•°æ®ç»“æ„ã€‚

    å±æ€§:
        messages (Annotated[list, add_messages]): ä½¿ç”¨ add_messages åˆå¹¶çš„æ¶ˆæ¯åˆ—è¡¨ã€‚
    """
    messages: Annotated[list, add_messages]


def save_memory(store: BaseStore, user_id: str, content: str):
    """
    å°†ç”¨æˆ·è¾“å…¥çš„å†…å®¹ä¿å­˜ä¸ºè®°å¿†ã€‚

    å‚æ•°:
        store (BaseStore): å­˜å‚¨ç³»ç»Ÿçš„å®ä¾‹ï¼Œç”¨äºæŒä¹…åŒ–æ•°æ®ã€‚
        user_id (str): ç”¨æˆ·å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
        content (str): éœ€è¦å­˜å‚¨çš„æ–‡æœ¬å†…å®¹ã€‚
    """
    namespace = ("memories", user_id)
    store.put(namespace, str(uuid.uuid4()), {"data": content})


def recall_memories(store: BaseStore, user_id: str, query: str, limit: int = 5):
    """
    æ ¹æ®æŸ¥è¯¢è¯­å¥æ£€ç´¢ä¸ç”¨æˆ·ç›¸å…³çš„è®°å¿†ã€‚

    å‚æ•°:
        store (BaseStore): å­˜å‚¨ç³»ç»Ÿçš„å®ä¾‹ã€‚
        user_id (str): ç”¨æˆ·å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
        query (str): æŸ¥è¯¢å…³é”®è¯æˆ–å¥å­ã€‚
        limit (int, optional): è¿”å›çš„è®°å¿†æ¡æ•°ä¸Šé™ï¼Œé»˜è®¤æ˜¯ 5 æ¡ã€‚

    è¿”å›:
        list[str]: åŒ¹é…çš„è®°å¿†å†…å®¹åˆ—è¡¨ã€‚
    """
    namespace = ("memories", user_id)
    memories = store.search(namespace, query=query, limit=limit)
    return [m.value["data"] for m in memories]


def chatbot(state: MessagesState, config: RunnableConfig, *, store: BaseStore):
    """
    èŠå¤©æœºå™¨äººä¸»é€»è¾‘èŠ‚ç‚¹å‡½æ•°ã€‚

    å‚æ•°:
        state (MessagesState): å½“å‰å¯¹è¯çš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬å†å²æ¶ˆæ¯ç­‰ã€‚
        config (RunnableConfig): è¿è¡Œæ—¶é…ç½®ä¿¡æ¯ï¼Œå¦‚çº¿ç¨‹IDã€ç”¨æˆ·IDç­‰ã€‚
        store (BaseStore): ç”¨äºè¯»å–å’Œå†™å…¥ç”¨æˆ·è®°å¿†çš„å­˜å‚¨æ¥å£ã€‚

    è¿”å›:
        dict: æ›´æ–°åçš„æ¶ˆæ¯çŠ¶æ€å­—å…¸ã€‚
    """
    user_id = config["configurable"]["user_id"]

    # æ£€ç´¢å†å²è®°å¿†
    query = state["messages"][-1].content
    related_memories = recall_memories(store, user_id, query)

    # æ„é€ ç³»ç»Ÿæç¤º
    system_msg = (
        "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„èŠå¤©åŠ©æ‰‹ã€‚\n"
        f"ä»¥ä¸‹æ˜¯å…³äºç”¨æˆ·çš„è®°å¿†:\n{chr(10).join(related_memories) if related_memories else 'æš‚æ— '}"
    )

    # ä¿å­˜å½“å‰æ¶ˆæ¯åˆ°è®°å¿†
    save_memory(store, user_id, query)

    # è°ƒç”¨æ¨¡å‹ç”Ÿæˆå›å¤
    response = model.invoke(
        [{"role": "system", "content": system_msg}] + state["messages"]
    )
    return {"messages": response}


# åˆ›å»ºçŠ¶æ€å›¾å¹¶å®šä¹‰æµç¨‹
builder = StateGraph(State)
builder.add_node(chatbot)
builder.add_edge(START, "chatbot")
builder.add_edge("chatbot", END)

# åˆå§‹åŒ–æ£€æŸ¥ç‚¹å’Œå­˜å‚¨ç»„ä»¶
checkpointer = InMemorySaver()
store = InMemoryStore()

# ç¼–è¯‘æ„å»ºæœ€ç»ˆå¯è¿è¡Œçš„å›¾å¯¹è±¡ï¼Œå¹¶ç»˜åˆ¶å…¶ç»“æ„å›¾
graph = builder.compile(
    checkpointer=checkpointer,
    store=store,
)
graph.get_graph().draw_png('./graph.png')


# ç¬¬ä¸€æ¬¡äº¤äº’æµ‹è¯•ï¼šè®°å½•ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
config1 = {"configurable": {"thread_id": "1", "user_id": "1"}}
msg1 = graph.invoke({"messages": [{"role": "user", "content": "æˆ‘å«å´”äº®ï¼Œå–œæ¬¢å­¦ä¹ ã€‚"}]}, config1)
print("ç¬¬ä¸€æ¬¡å›å¤ï¼š")
msg1["messages"][-1].pretty_print()


# ç¬¬äºŒæ¬¡äº¤äº’æµ‹è¯•ï¼šéªŒè¯æ˜¯å¦èƒ½å›å¿†èµ·ä¹‹å‰çš„ä¿¡æ¯
config2 = {"configurable": {"thread_id": "2", "user_id": "1"}}
msg2 = graph.invoke({"messages": [{"role": "user", "content": "æˆ‘å«ä»€ä¹ˆï¼Ÿæˆ‘å–œæ¬¢åšä»€ä¹ˆï¼Ÿ"}]}, config2)
print("ç¬¬äºŒæ¬¡å›å¤ï¼š")
msg2["messages"][-1].pretty_print()

```

æ‰§è¡Œç»“æœå¦‚ä¸‹

```python
ç¬¬ä¸€æ¬¡å›å¤ï¼š
================================== Ai Message ==================================

å¾ˆé«˜å…´è®¤è¯†ä½ ï¼Œå´”äº®ï¼å¾ˆé«˜å…´ä½ å–œæ¬¢å­¦ä¹ ï¼Œè¿™çœŸæ˜¯ä¸€ä¸ªå¾ˆæ£’çš„å“è´¨ã€‚ä½ å¹³æ—¶å–œæ¬¢å­¦ä¹ å“ªäº›æ–¹é¢çš„çŸ¥è¯†å‘¢ï¼Ÿæ˜¯å–œæ¬¢é˜…è¯»ã€ä¸Šè¯¾ï¼Œè¿˜æ˜¯é€šè¿‡å…¶ä»–æ–¹å¼å­¦ä¹ ï¼Ÿæˆ‘å¾ˆæƒ³å¬å¬ä½ çš„æ•…äº‹ã€‚

ç¬¬äºŒæ¬¡å›å¤ï¼š
================================== Ai Message ==================================

ä½ å«å´”äº®ï¼Œå–œæ¬¢å­¦ä¹ ã€‚å¾ˆé«˜å…´è®¤è¯†ä½ ï¼å­¦ä¹ æ˜¯ä¸€ä»¶å¾ˆæœ‰è¶£çš„äº‹æƒ…ï¼Œä½ å¹³æ—¶éƒ½å–œæ¬¢å­¦ä¹ ä»€ä¹ˆå‘¢ï¼Ÿ

```

## æ¶ˆæ¯è£å‰ª
ä¸€ä¸ªé’©å­å‡½æ•° pre_model_hookï¼Œç”¨äºåœ¨æ¨¡å‹å¤„ç†å‰è£å‰ªæ¶ˆæ¯å†å²ï¼Œåªä¿ç•™æœ€è¿‘å‡ æ¡æ¶ˆæ¯ï¼Œé¿å…ä¸Šä¸‹æ–‡è¿‡é•¿ã€‚å®ƒä½¿ç”¨ trim_messages å‡½æ•°æŒ‰ç­–ç•¥è£å‰ªæ¶ˆæ¯ï¼Œé™åˆ¶æ€» token æ•°ä¸º 100ï¼Œä»äººç±»ç”¨æˆ·æ¶ˆæ¯å¼€å§‹è£å‰ªï¼Œç¡®ä¿è¾“å…¥æ¨¡å‹çš„æ¶ˆæ¯åˆ—è¡¨ä¸ä¼šè¶…å‡ºé™åˆ¶ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```python
import dotenv
from langchain_core.messages.utils import trim_messages, count_tokens_approximately
from langchain_ollama import ChatOllama
from langgraph.checkpoint.memory import InMemorySaver
from langgraph.prebuilt import create_react_agent

# åŠ è½½ç¯å¢ƒå˜é‡é…ç½®
dotenv.load_dotenv()
# åˆå§‹åŒ–æœ¬åœ°å¤§è¯­è¨€æ¨¡å‹ï¼Œé…ç½®æ¨¡å‹åç§°å’Œæ¨ç†æ¨¡å¼
model = ChatOllama(model="qwen3:14b", reasoning=False)
# å®šä¹‰å·¥å…·åˆ—è¡¨ï¼Œ
tools = []


def pre_model_hook(state):
    """
    åœ¨æ¨¡å‹å¤„ç†å‰å¯¹æ¶ˆæ¯è¿›è¡Œé¢„å¤„ç†çš„é’©å­å‡½æ•°

    è¯¥å‡½æ•°ç”¨äºè£å‰ªæ¶ˆæ¯å†å²ï¼Œåªä¿ç•™æœ€è¿‘çš„è‹¥å¹²æ¡æ¶ˆæ¯ï¼Œé¿å…ä¸Šä¸‹æ–‡è¿‡é•¿

    Args:
        state (dict): åŒ…å«å¯¹è¯çŠ¶æ€çš„å­—å…¸ï¼Œå…¶ä¸­"messages"é”®å¯¹åº”æ¶ˆæ¯åˆ—è¡¨

    Returns:
        dict: åŒ…å«è£å‰ªåæ¶ˆæ¯çš„å­—å…¸ï¼Œé”®ä¸º"llm_input_messages"
    """
    # å‚æ•°è¯´æ˜:
    #   state["messages"]: éœ€è¦è£å‰ªçš„æ¶ˆæ¯åˆ—è¡¨
    #   strategy: è£å‰ªç­–ç•¥ï¼Œ"last"è¡¨ç¤ºä»æœ€åå¼€å§‹è£å‰ª
    #   token_counter: ç”¨äºè®¡ç®—tokenæ•°é‡çš„å‡½æ•°ï¼Œè¿™é‡Œä½¿ç”¨è¿‘ä¼¼è®¡ç®—æ–¹æ³•
    #   max_tokens: æœ€å¤§tokenæ•°é‡é™åˆ¶ï¼Œè®¾ç½®ä¸º300
    #   start_on: å¼€å§‹è£å‰ªçš„æ¶ˆæ¯ç±»å‹ï¼Œ"human"è¡¨ç¤ºä»äººç±»ç”¨æˆ·çš„æ¶ˆæ¯å¼€å§‹
    #   end_on: ç»“æŸè£å‰ªçš„æ¶ˆæ¯ç±»å‹ï¼Œå¯ä»¥æ˜¯"human"æˆ–"tool"ç±»å‹çš„æ¶ˆæ¯
    # è¿”å›å€¼: è£å‰ªåçš„æ¶ˆæ¯åˆ—è¡¨
    trimmed_messages = trim_messages(
        state["messages"],
        strategy="last",
        token_counter=count_tokens_approximately,
        max_tokens=300,
        start_on="human",
        end_on=("human", "tool"),
    )

    return {"llm_input_messages": trimmed_messages}


checkpointer = InMemorySaver()
agent = create_react_agent(
    model,
    tools,
    pre_model_hook=pre_model_hook,
    checkpointer=checkpointer,
)
config = {"configurable": {"thread_id": "user-001"}}
msg1 = agent.invoke({"messages": [("user", "ä½ å¥½ï¼Œæˆ‘å«å´”äº®")]}, config)
msg1["messages"][-1].pretty_print()
like_list = ['å”±', 'è·³', 'rap', 'ç¯®çƒ']
for i in like_list:
    msg = "æˆ‘å–œæ¬¢åšçš„äº‹æ˜¯ï¼š" + i
    print(msg)
    agent.invoke({"messages": [("user", msg)]}, config)
msg2 = agent.invoke({"messages": [("user", "æˆ‘å«ä»€ä¹ˆï¼Ÿæˆ‘å–œæ¬¢åšçš„äº‹æ˜¯ä»€ä¹ˆï¼Ÿ")]}, config)
msg2["messages"][-1].pretty_print()
```

æ‰§è¡Œç»“æœå¦‚ä¸‹

```python
================================== Ai Message ==================================

ä½ å¥½å´”äº®ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚ğŸ˜Š ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿæœ‰ä»€ä¹ˆæœ‰è¶£çš„äº‹æƒ…å‘ç”Ÿå—ï¼Ÿ

æˆ‘å–œæ¬¢åšçš„äº‹æ˜¯ï¼šå”±
æˆ‘å–œæ¬¢åšçš„äº‹æ˜¯ï¼šè·³
æˆ‘å–œæ¬¢åšçš„äº‹æ˜¯ï¼šrap
æˆ‘å–œæ¬¢åšçš„äº‹æ˜¯ï¼šç¯®çƒ
================================== Ai Message ==================================

ä½ å«ä»€ä¹ˆï¼Ÿä½ å–œæ¬¢åšçš„äº‹æ˜¯ç¯®çƒå¯¹å—ï¼ŸğŸ€  
ï¼ˆä¸è¿‡ä½ åˆšåˆšå·²ç»å‘Šè¯‰è¿‡æˆ‘ä½ å–œæ¬¢åšçš„äº‹æ˜¯ç¯®çƒå•¦ï½ï¼‰

å¦‚æœä½ æ„¿æ„çš„è¯ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘ä½ çš„åå­—ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½æ›´ç†Ÿæ‚‰å•¦ï¼ğŸ˜Š  
ä½ æ˜¯ä¸æ˜¯ä¹Ÿç‰¹åˆ«å–œæ¬¢åœ¨çƒåœºä¸Šå¥”è·‘ã€æŠ•ç¯®ã€å’Œæœ‹å‹ä»¬ä¸€èµ·æ‰“çƒçš„æ„Ÿè§‰ï¼Ÿ

```

## æ¶ˆæ¯æ€»ç»“
å®ç°äº†ä¸€ä¸ªåŸºäºæœ¬åœ°å¤§è¯­è¨€æ¨¡å‹çš„å¯¹è¯ä»£ç†ï¼Œå…·å¤‡ä¸Šä¸‹æ–‡è®°å¿†ä¸æ‘˜è¦èƒ½åŠ›ã€‚ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¿½ï¿½ï¿½

+ åŠ è½½ç¯å¢ƒå˜é‡å¹¶åˆå§‹åŒ–Ollamaæ¨¡å‹ï¼›
+ åˆ›å»ºæ‘˜è¦èŠ‚ç‚¹ä»¥æ§åˆ¶è¾“å…¥é•¿åº¦ï¼›
+ å®šä¹‰å¸¦è®°å¿†çŠ¶æ€çš„ä»£ç†åŠä¼šè¯é…ç½®ï¼›
+ é€šè¿‡å¤šè½®å¯¹è¯æµ‹è¯•æ¨¡å‹å¯¹ç”¨æˆ·ä¿¡æ¯ï¼ˆå§“åã€å…´è¶£ï¼‰çš„è®°å¿†ä¸ç†è§£èƒ½åŠ›ã€‚

ä»£ç å¦‚ä¸‹

```python
import dotenv
from langchain_core.messages.utils import trim_messages, count_tokens_approximately
from langchain_ollama import ChatOllama
from langgraph.checkpoint.memory import InMemorySaver
from langgraph.prebuilt import create_react_agent
from langgraph.prebuilt.chat_agent_executor import AgentState
from langmem.short_term import SummarizationNode, RunningSummary

# åŠ è½½ç¯å¢ƒå˜é‡é…ç½®
dotenv.load_dotenv()

# åˆå§‹åŒ–æœ¬åœ°å¤§è¯­è¨€æ¨¡å‹ï¼Œé…ç½®æ¨¡å‹åç§°å’Œæ¨ç†æ¨¡å¼
model = ChatOllama(model="qwen3:14b", reasoning=False)

# å®šä¹‰å·¥å…·åˆ—è¡¨ï¼Œ
tools = []

# åˆ›å»ºä¸€ä¸ªSummarizationNodeå®ä¾‹ï¼Œç”¨äºå¤„ç†æ–‡æœ¬æ‘˜è¦ä»»åŠ¡
# å‚æ•°è¯´æ˜:
#   token_counter: ç”¨äºä¼°ç®—æ–‡æœ¬tokenæ•°é‡çš„å‡½æ•°ï¼Œè¿™é‡Œä½¿ç”¨count_tokens_approximatelyå‡½æ•°
#   model: æŒ‡å®šä½¿ç”¨çš„è¯­è¨€æ¨¡å‹å®ä¾‹
#   max_tokens: é™åˆ¶å¤„ç†æ–‡æœ¬çš„æœ€å¤§tokenæ•°é‡ä¸º300
#   max_summary_tokens: é™åˆ¶ç”Ÿæˆæ‘˜è¦çš„æœ€å¤§tokenæ•°é‡ä¸º128
#   output_messages_key: æŒ‡å®šè¾“å‡ºæ¶ˆæ¯åœ¨ç»“æœä¸­çš„é”®åï¼Œè®¾ç½®ä¸º"llm_input_messages"
summarization_node = SummarizationNode(
    token_counter=count_tokens_approximately,
    model=model,
    max_tokens=300,
    max_summary_tokens=128,
    output_messages_key="llm_input_messages",
)


# è‡ªå®šä¹‰çŠ¶æ€ç±»ï¼Œç»§æ‰¿è‡ªAgentStateï¼Œæ·»åŠ ä¸Šä¸‹æ–‡å­—æ®µç”¨äºå­˜å‚¨è¿è¡Œæ—¶æ‘˜è¦ä¿¡æ¯
class State(AgentState):
    context: dict[str, RunningSummary]

# åˆå§‹åŒ–å†…å­˜æ£€æŸ¥ç‚¹ä¿å­˜å™¨ï¼Œç”¨äºæŒä¹…åŒ–ä»£ç†çŠ¶æ€
checkpointer = InMemorySaver()

# åˆ›å»ºReactä»£ç†ï¼Œæ•´åˆæ¨¡å‹ã€å·¥å…·ã€æ‘˜è¦èŠ‚ç‚¹å’ŒçŠ¶æ€ç®¡ç†å™¨
agent = create_react_agent(
    model=model,
    tools=tools,
    pre_model_hook=summarization_node,
    state_schema=State,
    checkpointer=checkpointer,
)

# é…ç½®çº¿ç¨‹IDï¼Œç”¨äºæ ‡è¯†ç”¨æˆ·ä¼šè¯
config = {"configurable": {"thread_id": "user-001"}}

# å¯åŠ¨å¯¹è¯ï¼Œå‘é€ç”¨æˆ·è‡ªæˆ‘ä»‹ç»æ¶ˆæ¯å¹¶è·å–æ¨¡å‹å“åº”
msg1 = agent.invoke({"messages": [("user", "ä½ å¥½ï¼Œæˆ‘å«å´”äº®")]}, config)
msg1["messages"][-1].pretty_print()

# å®šä¹‰ç”¨æˆ·å…´è¶£åˆ—è¡¨
like_list = ['å”±', 'è·³', 'rap', 'ç¯®çƒ']

# å¾ªç¯å‘é€ç”¨æˆ·å…´è¶£ä¿¡æ¯ï¼Œé€æ¡æ›´æ–°ä¸Šä¸‹æ–‡
for i in like_list:
    msg = "æˆ‘å–œæ¬¢åšçš„äº‹æ˜¯ï¼š" + i
    print(msg)
    agent.invoke({"messages": [("user", msg)]}, config)

# æŸ¥è¯¢ç”¨æˆ·å§“åå’Œå…´è¶£ï¼Œæµ‹è¯•æ¨¡å‹å¯¹ä¸Šä¸‹æ–‡çš„ç†è§£èƒ½åŠ›
msg2 = agent.invoke({"messages": [("user", "æˆ‘å«ä»€ä¹ˆï¼Ÿæˆ‘å–œæ¬¢åšçš„äº‹æ˜¯ä»€ä¹ˆï¼Ÿ")]}, config)
msg2["messages"][-1].pretty_print()

```

æ‰§è¡Œç»“æœå¦‚ä¸‹

```python
================================== Ai Message ==================================

ä½ å¥½å´”äº®ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼ğŸ˜Š ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿæœ‰ä»€ä¹ˆæœ‰è¶£çš„äº‹æƒ…å‘ç”Ÿå—ï¼Ÿ

æˆ‘å–œæ¬¢åšçš„äº‹æ˜¯ï¼šå”±
æˆ‘å–œæ¬¢åšçš„äº‹æ˜¯ï¼šè·³
æˆ‘å–œæ¬¢åšçš„äº‹æ˜¯ï¼šrap
æˆ‘å–œæ¬¢åšçš„äº‹æ˜¯ï¼šç¯®çƒ
================================== Ai Message ==================================

ä½ å«**å´”äº®**ï¼Œä½ å–œæ¬¢åšçš„äº‹æ˜¯ï¼š**å”±ã€è·³ã€rapã€ç¯®çƒ**ã€‚ğŸ¶ğŸ’ƒğŸ¤ğŸ€

ä½ æ˜¯ä¸€ä¸ªå¤šæ‰å¤šè‰ºã€çƒ­çˆ±ç”Ÿæ´»ã€å……æ»¡æ´»åŠ›çš„äººï¼æ˜¯ä¸æ˜¯å¾ˆé…·ï¼ŸğŸ˜  
å¦‚æœä½ æƒ³ç»§ç»­åˆ†äº«æ›´å¤šå…³äºè‡ªå·±çš„æ•…äº‹ï¼Œæˆ‘éšæ—¶éƒ½åœ¨å“¦ï¼

```




