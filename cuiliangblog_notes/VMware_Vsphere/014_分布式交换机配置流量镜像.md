# 分布式交换机配置流量镜像

> 来源: VMware Vsphere
> 创建时间: 2021-02-16T16:53:31+08:00
> 更新时间: 2026-01-12T14:35:41.419455+08:00
> 阅读量: 951 | 点赞: 0

---

# 一、创建分布式交换机
1. Web浏览器启动Vmware vSphereWeb Client,连接到vCenter Server Appliance界面
2. 单击"主页"，选择"网络'

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465721459-642733a8-da89-4fe3-9860-e4bc327a71ef.png)

1. 右击"数据中心"，单击Distributed Switch中的"新建Distributed Switch"

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465720778-2a030294-506c-4e87-aec7-c606baebb86b.png)

1. 输入分布式交换机名称

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465677465-38555647-98bc-4b2a-8581-a821e865c699.png)

1. 选择版本

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465694325-2323872c-fc4d-45ac-8910-ae0fc293ef0f.png)

1. 指定上行链路端口数，IO Control及默认端口组名称

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465688401-1145574f-08fd-4a4f-bb22-5ed830f0abc0.png)

1. 完成，会建议你后续可新建分布式端口组，以及添加和管理主机

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465693362-d3669da2-c9b8-40a8-9bf7-981d8b2c52b6.png)

# 二、添加主机至分布式交换机
1. 右击分布式交换机，然后选择"添加和管理主机"

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465721903-461d1067-93b1-4a98-9b89-19dcd6f5a373.png)

1. 添加主机

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465697875-2cb513a4-7650-4d75-bb25-48875f5e0087.png)

1. 选择"新主机"，然后添加主机

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465696572-3c9b9564-9663-4fba-8ce7-24bdb3795a28.png)

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465701596-6ce5e22e-be93-4a86-8a60-aa708261948e.png)

1. 勾选'管理物理适配器'，后续可自行添加管理VMkernel适配器；迁移虚拟机网络，将在后面操作。

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465715669-9bfe6397-e3df-4bda-8c3d-88aac8110297.png)

1. 将主机上的网卡分配至上行链路，可选择链路或者自动分配

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465721940-78764469-6275-4ddf-9a8d-2a223034edb8.png)

1. 分配完成

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465718422-baf2a69f-2ec6-458f-bc6d-7641be1228e5.png)

1. 分析影响

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465704450-7a954484-6619-48c5-8305-6b9686905977.png)

# 三、将虚拟机迁移到分布式交换机端口组
1. 右击分布式交换机名称，选择“将虚拟机迁移至其他网络”

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465722220-b309c252-2f09-41b1-8546-a884f2a16d6c.png)

1. 将虚拟机从标准交换机迁移至该分布式交换机，例如，从标准交换机VMnetwork端口组迁移至分布式交换机的默认端口组等。也可以将未连接网络的虚拟枧迁移至该分布式交换机端口组。

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465692288-fb043c8e-d501-4b64-b733-bdacb4f5ba10.png)

1. 确认各项配置，检查端口、虚拟机、主机及拓扑等是否正常设置

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465705544-083cdba4-21b6-4d8b-a4c2-0b4f0e786fef.png)

至此，分布式交换机简单部署完成。下一步，部署流量镜像，实现该vCenter环境中一台虚拟机监控所有虚拟机流量。

# 四、分布式交换机端口镜像分类
1. 过分布式端口镜像：将网络流量从一组分布式端口镜像到其他分布式端口。源和目标虚拟机必须在同一主机上。
2. 远程镜像源：将网络流量从一组分布式端口镜像到特定上行链路端口。
3. 远程镜像目标：将网络流量从一组VLAN镜像到分布式端口。
4. 已封装远程镜像(L3)源：将网络流量从一组分布式端口镜像到远程代理的|P地址。

# 五、分布式端口镜像（同一主机中的虚拟机）
1. 在vspherewebClient导航器中，浏览到分布式交换机。
2. 单击配置选项卡并展开设置。
3. 选择端口镜像选项并单击新建。
4. 选择端口镜像会话的会话类型

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465681176-d9b13c6e-8f21-4ce9-a4d1-419018df5e27.png)

1. 输入"名称"、"状态"启用等信息，下一步

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465695577-d002c28e-15af-4ebd-a743-ca7e06b1812d.png)

1. 选择端口镜像会话的源端口

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465712773-746d3beb-aa9d-48e4-9e50-a6dd84f24276.png)

1. 同样，选择目标端口即用来获取流量的端口，FINISH

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465702465-c1f67205-a5c3-481c-ac56-1be5a8cabd1c.png)

1. 测试，在源端口对应虚拟机上做ping测试，在目标端口对应虚拟机进行抓包测试

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465715561-127dbe37-afcf-4304-bd6b-5c4ed424d43a.png)

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465696334-cd485ee4-00a2-4446-8793-aecc20e4a341.png)

经测试，可获取到流量数据。

# 六、远程镜像源·远程镜像目标（不同主机中的虚拟机）
实现目标：主机2中的虚拟机B可以获取到主机1中的虚拟机A的进出流量

设计方案：创建远程镜像源将主枧1中的虚拟机A流量封装成VLANx然后镜像至主机1的上行端口1；创建远程镜像目标，将封装的VLANx镜像至待接收的主机2上的虚拟机B。

1. 在vspherewebClient导航器中，浏览到分布式交换机。
2. 单击配置选项卡并展开设置。
3. 选择端口镜像选项并单击新建。
4. 选择端口镜像会话的会话类型

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465686603-fbbab513-6372-4539-bbf5-a7e56b6d4858.png)

1. 编辑属性，名称、是否启用、封装的VLANID、正常IO不影响

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465693249-887932a9-e12d-4593-a7de-551fe2b9e135.png)

1. 选择源

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465686724-33f527bf-8cd7-469a-b229-47380adf1492.png)

1. 选择要镜像的端口

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465700551-d5a5fba1-9ecf-4ca7-b180-e0a376638ebb.png)

1. 选择目标-链路

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465692561-f4b5eb4e-b864-4a67-93b7-636aea5d7088.png)

注：以上上行链路的配置，如果选择了和源不是一个主机，最后保存的时候会报如下错

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465666897-e7524f89-e186-40c5-b1cd-b1882f5ff65e.png)

1. 确认配置，FINISH

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465693697-bc1a01b7-1128-4c51-b310-998b1a20134e.png)

至此，某端口流量已经封装成VLANx并镜像至上行链路，接下来，只需把该VLAN流量镜像至需要的端口即可。

# 七、创建"远程镜像目标"
![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465689607-70127b9d-2aaa-46b6-bd6d-6ff1a62ccbd8.png)

1. 编辑属性

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465690526-573c9dab-bf07-4eb2-842f-54712d8653d9.png)

1. 选择源，配置以上封装的VLAN

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465684620-e867330f-0635-43df-9ee2-84278a315a8d.png)

1. 选择镜像目标，配置需要这些流量的端口

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465686003-319e1879-938a-4d7d-a4dc-270518914add.png)

1. 完成配置，确保镜像会话都已启动

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465697609-88f68b21-8eb0-4acf-8bc5-70d01da17194.png)

1. 测试

![](https://cdn.nlark.com/yuque/0/2021/png/2308212/1613465722239-4ecb3f34-58ff-444c-b172-a7f1b79b27db.png)

 


